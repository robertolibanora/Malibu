{% extends "staff/base.html" %}
{% from "staff/partials/qr_scanner.html" import render_qr_scanner %}
{% block staff_title %}Nuovo consumo{% endblock %}

{% block extra_head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/qr-scanner.css') }}">
{% endblock %}

{% block staff_content %}
<section class="card">
  <h1 class="card__title">üìç Evento attivo</h1>
  <div class="card__meta">{{ evento.data_evento.strftime('%d/%m/%Y') }} ‚Äî {{ evento.nome_evento }}</div>
  <div style="margin-top:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
    <span class="badge badge--{{ 'success' if evento.stato_pubblico == 'attivo' else 'secondary' }}">{{ evento.stato_pubblico|capitalize }}</span>
    {% if evento.is_staff_operativo %}
    <span class="badge badge--success" style="background: rgba(212,175,55,0.15); color: var(--gold-primary); border: 1px solid rgba(212,175,55,0.35);">
      Evento operativo staff
    </span>
    {% endif %}
  </div>
</section>

<section class="card">
  <h2 class="card__title">üîç Scanner QR Cliente</h2>
  <p class="text--muted" style="margin-bottom: 1.5rem;">
    Scansiona il QR del cliente prima di registrare il consumo. Lo scanner mostrer√† messaggi chiari: <em>Pronto</em>, <em>Cliente trovato</em> o eventuali errori.
  </p>
  
  <form id="consumoForm" class="form" method="post" action="{{ url_for('consumi.staff_new') }}">
    {{ render_qr_scanner(container_id='qr-reader', form_id='consumoForm', auto_submit=False, show_manual_input=False, result_input_id='qr_hidden') }}

    {% if prodotti and prodotti|length %}
    <div class="form__group">
      <label class="form__label">Prodotto da catalogo</label>
      <select class="form__input" name="prodotto_id" id="prodotto_id" disabled>
        <option value="">‚Äî Seleziona ‚Äî</option>
        {% for p in prodotti %}
        <option value="{{ p.id_prodotto }}" data-prezzo="{{ p.prezzo }}">{{ p.nome }} ‚Äî ‚Ç¨ {{ '%.2f'|format(p.prezzo) }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <div class="grid grid--2">
      <div class="form__group">
        <label class="form__label">Prodotto (testo libero)</label>
        <input class="form__input" type="text" name="prodotto" placeholder="Es. Vodka 1L" disabled>
      </div>
      <div class="form__group">
        <label class="form__label">Importo (‚Ç¨)</label>
        <input class="form__input" type="number" step="0.01" name="importo" id="importo" disabled>
      </div>
    </div>

    <div class="grid grid--2">
      <div class="form__group">
        <label class="form__label">Sconto (%)</label>
        <input class="form__input" type="number" step="1" name="sconto_pct" placeholder="0" disabled>
      </div>
      <div class="form__group">
        <label class="form__label">Punto vendita</label>
        <select class="form__input" name="punto_vendita" required disabled>
          <option value="bar">Bar</option>
          <option value="tavolo">Tavolo</option>
          <option value="priv√®">Priv√®</option>
        </select>
      </div>
    </div>

    <div class="form__group">
      <label class="form__label">Note (opzionale)</label>
      <input class="form__input" type="text" name="note" placeholder="Es. Tavolo 7 ‚Äì VIP" disabled>
    </div>

    <div class="form__actions">
      <button class="btn btn--primary" type="submit" id="consumo_submit" disabled>Registra consumo</button>
    </div>
  </form>
</section>
{% endblock %}

{% block scripts %}
<!-- html5-qrcode da CDN -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- Modulo scanner QR -->
<script src="{{ url_for('static', filename='js/qr-scanner.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){
  // Selezione prodotto da catalogo -> precompila importo
  const select = document.getElementById('prodotto_id');
  if (select){
    select.addEventListener('change', function(){
      const prezzo = this.options[this.selectedIndex].getAttribute('data-prezzo');
      if (prezzo){
        document.getElementById('importo').value = prezzo;
      }
    });
  }
  
  // Mostra info cliente dopo scansione QR
  document.addEventListener('qr-scanned', function(e) {
    const qrCode = e.detail.code;
    console.log('‚úÖ Cliente riconosciuto:', qrCode);
    
    // Feedback visivo aggiuntivo (opzionale)
    const form = document.getElementById('consumoForm');
    if (form) {
      const infoDiv = form.querySelector('.cliente-info');
      if (!infoDiv) {
        const div = document.createElement('div');
        div.className = 'banner banner--success cliente-info';
        div.style.marginTop = '1rem';
        div.innerHTML = `‚úÖ <strong>Cliente riconosciuto</strong> ‚Äî Procedi con il consumo`;
        form.insertBefore(div, form.querySelector('.form__group'));
      }
      // Sblocca i campi del form dopo lo scan
      form.querySelectorAll('input, select, button').forEach(function(el){
        if (el.id === 'qr_hidden') return;
        el.disabled = false;
      });
      checkEnableSubmit();
    }
  });

  function checkEnableSubmit() {
    const submit = document.getElementById('consumo_submit');
    if (!submit) return;
    const hasQR = (document.getElementById('qr_hidden')?.value || '').trim().length > 0;
    const importo = parseFloat(document.getElementById('importo')?.value || '0');
    const prodottoTxt = (document.querySelector('input[name="prodotto"]')?.value || '').trim();
    const prodottoSel = document.getElementById('prodotto_id')?.value;
    submit.disabled = !hasQR || (!(importo > 0) && !prodottoTxt && !prodottoSel);
  }
  document.addEventListener('input', checkEnableSubmit);
});
</script>
{% endblock %}