{% extends "staff/base.html" %}
{% from "staff/partials/qr_scanner.html" import render_qr_scanner %}
{% block staff_title %}Scan ingressi{% endblock %}

{% block extra_head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/qr-scanner.css') }}">
{% endblock %}

{% block staff_content %}
<section class="card">
  <h1 class="card__title">üìç Evento attivo</h1>
  <div class="card__meta">{{ evento.data_evento.strftime('%d/%m/%Y') }} ‚Äî {{ evento.nome_evento }}</div>
  <div class="staff-ingressi__stats">
    <div class="staff-ingressi__stat-item">
      <span class="staff-ingressi__stat-label">Ingressi registrati</span>
      <span class="staff-ingressi__stat-value">{{ ingressi_totali }}</span>
    </div>
    
    {% if residua is not none %}
    <div class="staff-ingressi__stat-item">
      <span class="staff-ingressi__stat-label">Capienza residua</span>
      <span class="staff-ingressi__stat-value {% if residua <= 10 %}staff-ingressi__stat-value--danger{% elif residua <= 50 %}staff-ingressi__stat-value--warning{% else %}staff-ingressi__stat-value--success{% endif %}">
      {{ residua }} / {{ evento.capienza_max }}
    </span>
    </div>
    {% endif %}

    <div class="staff-ingressi__stat-item">
      <span class="staff-ingressi__stat-label">Prenotati in attesa</span>
      <span class="staff-ingressi__stat-value staff-ingressi__stat-value--primary" id="prenotati_counter">
        <span class="staff-ingressi__counter-value">-</span>
      </span>
    </div>
  </div>
</section>

<section class="card">
  <h2 class="card__title">üîç Scanner QR Cliente</h2>
  <p class="text--muted" style="margin-bottom: 1.5rem;">
    Inquadra il QR code del cliente per registrare l'ingresso automaticamente.
  </p>
  
  <form id="scanForm" class="form" method="post" action="{{ url_for('ingressi.staff_scan') }}">
    {{ render_qr_scanner(container_id='qr-reader',
                         form_id='scanForm',
                         auto_submit=False,
                         show_manual_input=True,
                         manual_input_label='Oppure inserisci codice manualmente',
                         manual_input_placeholder='QR / codice cliente',
                         precheck_url=url_for('ingressi.staff_scan_check')) }}
    
    <div class="form__actions" style="margin-top: 1.5rem;">
      <button class="btn btn--primary" type="submit" id="btn_conferma" disabled>
        ‚úÖ Fai entrare
      </button>
      <button class="btn btn--ghost" type="button" id="btn_nega" disabled>‚õî Nega ingresso</button>
      <a href="{{ url_for('staff.home') }}" class="btn btn--ghost">
        ‚Üê Home
      </a>
    </div>
  </form>

  <div id="preview" class="card" style="margin-top:1rem; display:none;">
    <h3 class="card__title">Dettagli cliente</h3>
    <ul class="list" id="preview_list" style="margin-top:0.5rem;"></ul>
    <div class="banner banner--warning" id="already_banner" style="display:none; margin-top:0.75rem;">
      ‚ö†Ô∏è Gi√† registrato per questo evento
    </div>
  </div>
</section>

{% if residua is not none and residua <= 10 %}
<section class="card card--warning">
  <div class="banner banner--warning" role="alert">
    ‚ö†Ô∏è <strong>Attenzione:</strong> Capienza quasi esaurita ({{ residua }} posti rimasti)
  </div>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- html5-qrcode da CDN -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- Modulo scanner QR -->
<script src="{{ url_for('static', filename='js/qr-scanner.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const preview = document.getElementById('preview');
  const list = document.getElementById('preview_list');
  const banner = document.getElementById('already_banner');
  const btnConferma = document.getElementById('btn_conferma');
  const btnNega = document.getElementById('btn_nega');
  const qrHidden = document.getElementById('qr-result') || document.getElementById('qr_manual') || document.getElementById('qr_hidden') || document.getElementById('qr_manual');
  const counterEl = document.getElementById('prenotati_counter');

  // Fetch prenotati count
  async function updatePrenotatiCounter() {
    try {
      const res = await fetch('{{ url_for("ingressi.staff_prenotati_count") }}', {
        method: 'GET',
        credentials: 'same-origin'
      });
      const data = await res.json();
      if (data.ok) {
        const counter = counterEl.querySelector('.staff-ingressi__counter-value');
        if (counter) {
          counter.textContent = data.prenotati_mancanti;
          // Animate change
          counterEl.classList.add('staff-ingressi__stat-value--updated');
          setTimeout(() => counterEl.classList.remove('staff-ingressi__stat-value--updated'), 600);
        }
      }
    } catch (err) {
      console.error('Error updating counter:', err);
    }
  }

  // Initial load
  updatePrenotatiCounter();

  async function fetchPreview(qr) {
    const res = await fetch('{{ url_for("ingressi.staff_scan_preview") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify({ qr })
    });
    return await res.json();
  }

  document.addEventListener('qr-scanned', async function(e){
    const code = e.detail.code;
    try {
      const data = await fetchPreview(code);
      if (!data.ok) {
        preview.style.display = 'none';
        btnConferma.disabled = true;
        btnNega.disabled = true;
        return;
      }
      // Popola UI
      list.innerHTML = '';
      const c = data.cliente || {};
      const items = [
        ['Nome', (c.nome || '-') + ' ' + (c.cognome || '-')],
        ['Data di nascita', c.data_nascita || '-'],
        ['Provenienza', c.citta || '-'],
        ['Registrato', data.already ? 'S√¨' : 'No']
      ];
      items.forEach(([k,v]) => {
        const li = document.createElement('li');
        li.className = 'list__item';
        li.innerHTML = '<strong>'+k+':</strong> '+v;
        list.appendChild(li);
      });
      banner.style.display = data.already ? 'block' : 'none';
      preview.style.display = 'block';
      // Abilita pulsanti
      btnNega.disabled = false;
      btnConferma.disabled = !!data.already; // blocca se gi√† entrato
    } catch(err) {
      console.warn('preview error', err);
    }
  });

  // Update counter on scan
  document.addEventListener('qr-scanned', function(){
    setTimeout(() => updatePrenotatiCounter(), 500);
  });

  // Form submission
  const scanForm = document.getElementById('scanForm');
  scanForm?.addEventListener('submit', function(e){
    // Update counter dopo il submit (anche se la pagina reindirizza, il counter si aggiorna momentaneamente)
    updatePrenotatiCounter();
  });

  btnNega?.addEventListener('click', function(){
    // Reset anteprima e disabilita pulsanti
    preview.style.display = 'none';
    btnConferma.disabled = true;
    btnNega.disabled = true;
    // Pulisci input QR manuale/hidden
    const manual = document.getElementById('qr_manual');
    const hidden = document.getElementById('qr-result') || document.getElementById('qr_hidden');
    if (manual) manual.value = '';
    if (hidden) hidden.value = '';
  });
});
</script>
{% endblock %}