{% extends "staff/base.html" %}
{% from "staff/partials/qr_scanner.html" import render_qr_scanner %}
{% block staff_title %}Listino Consumazioni{% endblock %}

{% block extra_head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/qr-scanner.css') }}">
{% endblock %}

{% block staff_content %}
<form id="listinoForm" method="post" action="{{ url_for('consumi.staff_listino_addebito') }}">
  
  <!-- Header Section -->
  <section class="card staff-listino__header">
    <h1 class="card__title">üìã Listino Consumazioni</h1>
  <div class="card__meta">
    <strong>Evento:</strong> {{ evento.data_evento.strftime('%d/%m/%Y') }} ‚Äî {{ evento.nome_evento }}
  </div>
</section>

  <!-- Cliente Info Section -->
  <section class="card staff-listino__cliente-section">
    <h2 class="staff-listino__section-title">üë§ Cliente</h2>
    <div id="cliente_info" class="staff-listino__cliente-info" style="display: none;">
      <div class="staff-listino__cliente-card">
        <span class="staff-listino__cliente-badge">‚úì</span>
        <div>
          <p class="staff-listino__cliente-name" id="client_name">-</p>
          <p class="staff-listino__cliente-status">Verificato</p>
        </div>
      </div>
    </div>
    <div id="cliente_prompt" class="staff-listino__cliente-prompt">
      <!-- Tab Switcher -->
      <div class="staff-scanner__tabs">
        <button type="button" class="staff-scanner__tab staff-scanner__tab--active" data-tab="qr">
          üì± QR Code
        </button>
        <button type="button" class="staff-scanner__tab" data-tab="search">
          üîé Ricerca Cliente
        </button>
      </div>

      <!-- QR Tab (default) -->
      <div id="tab-qr" class="staff-scanner__tab-content staff-scanner__tab-content--active">
        <div class="staff-scanner__instruction">
          üì± Scansiona il QR del cliente per iniziare
        </div>
    {{ render_qr_scanner(container_id='qr-reader', form_id='listinoForm', auto_submit=False, show_manual_input=True, result_input_id='qr_hidden', manual_input_id='qr_manual', manual_input_label='QR Code Cliente', manual_input_placeholder='Oppure inserisci manualmente il QR code') }}
      </div>

      <!-- Search Tab -->
      <div id="tab-search" class="staff-scanner__tab-content">
        <div class="staff-scanner__search-container">
          <input 
            type="text" 
            id="search_cliente" 
            class="form__input staff-scanner__search-input" 
            placeholder="Cerca per nome o cognome..."
            autocomplete="off"
            aria-label="Ricerca cliente">
          <div id="search_results" class="staff-scanner__search-results"></div>
        </div>
      </div>
      
      <!-- Status Message -->
      <div id="scanner_status" class="staff-scanner__status staff-scanner__status--idle" role="status" aria-live="polite">
        <span class="staff-scanner__status-icon">‚è≥</span>
        <span class="staff-scanner__status-text">In attesa di scansione...</span>
      </div>
    </div>
  </section>

  <!-- Prodotti Listino - Solo se cliente √® scannerizzato -->
    {% if prodotti_per_categoria %}
  <section id="prodotti_section" class="card staff-listino__prodotti" style="display: none;">
    <h2 class="staff-listino__section-title">üõçÔ∏è Seleziona Prodotti</h2>
      
      {% for categoria, prodotti_cat in prodotti_per_categoria.items() %}
    <div class="staff-listino__categoria">
      <h3 class="staff-listino__categoria-title">{{ categoria }}</h3>
      <div class="staff-listino__prodotti-grid">
          {% for p in prodotti_cat %}
        <div class="staff-listino__prodotto-item">
          <label class="staff-listino__prodotto-label">
            <input type="checkbox" name="prodotto_id" value="{{ p.id_prodotto }}" class="prodotto-checkbox" data-nome="{{ p.nome }}" data-prezzo="{{ p.prezzo|float }}" disabled>
            <div class="staff-listino__prodotto-content">
              <span class="staff-listino__prodotto-nome">{{ p.nome }}</span>
              <span class="staff-listino__prodotto-prezzo">‚Ç¨{{ "%.2f"|format(p.prezzo) }}</span>
            </div>
          </label>
          
          <!-- Quantit√† Control -->
          <div class="staff-listino__quantita-wrapper" style="display: none;">
            <button type="button" class="staff-listino__qty-btn staff-listino__qty-btn--minus" data-product-id="{{ p.id_prodotto }}">‚àí</button>
            <input type="number" name="quantita_{{ p.id_prodotto }}" value="1" min="1" class="staff-listino__qty-input" disabled>
            <button type="button" class="staff-listino__qty-btn staff-listino__qty-btn--plus" data-product-id="{{ p.id_prodotto }}">+</button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </section>

  <!-- Punto Vendita & Note -->
  <section id="options_section" class="card staff-listino__options" style="display: none;">
    <h2 class="staff-listino__section-title">‚öôÔ∏è Opzioni</h2>
    <div class="grid grid--2">
      <div class="form__group">
        <label class="form__label" for="punto_vendita">Punto Vendita</label>
        <select class="form__input" id="punto_vendita" name="punto_vendita" required disabled>
          <option value="">- Seleziona -</option>
          <option value="bar">üçª Bar</option>
          <option value="tavolo">ü™ë Tavolo</option>
          <option value="priv√®">üé≠ Priv√®</option>
        </select>
      </div>
      <div class="form__group">
        <label class="form__label" for="note_input">Note (opzionale)</label>
        <input class="form__input" type="text" id="note_input" name="note" placeholder="Es. Tavolo 7" disabled>
      </div>
    </div>
  </section>

  <!-- Totale Riepilogo - Sticky -->
  <section id="riepilogo_section" class="card staff-listino__riepilogo" style="display: none;">
    <div class="staff-listino__totale-box">
      <div class="staff-listino__totale-label">Totale selezionato</div>
      <div class="staff-listino__totale-amount" id="totale">‚Ç¨0.00</div>
      <div class="staff-listino__totale-punti">
        Punti fedelt√†: <strong id="punti">0</strong>
      </div>
    </div>
  </section>

  <!-- Empty State Message -->
  {% else %}
  <section class="card">
    <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
      <p>‚ùå Nessun prodotto disponibile nel listino.</p>
      <p style="font-size: 0.875rem; margin-top: 0.5rem;">L'admin deve aggiungere prodotti al listino.</p>
    </div>
  </section>
  {% endif %}

  <!-- Actions -->
  <section class="card staff-listino__actions" {% if not prodotti_per_categoria %}style="display: none;"{% endif %}>
    <div class="staff-listino__action-buttons">
      <button class="btn btn--primary btn--large" type="submit" id="submit_btn" disabled>
        ‚úì Addebita al Cliente
      </button>
      <a href="{{ url_for('staff.home') }}" class="btn btn--ghost btn--large">
        ‚Üê Annulla
      </a>
    </div>
  </section>

  <!-- System Banner - Conferma Acquisto -->
  <div id="confirm_banner" class="staff-listino__system-banner staff-listino__system-banner--confirm" role="alertdialog" style="display: none;">
    <div class="staff-listino__banner-icon">üìã</div>
    <div class="staff-listino__banner-content">
      <div class="staff-listino__banner-title">Conferma Acquisto</div>
      <div id="confirm_text" class="staff-listino__banner-message"></div>
    </div>
    <div class="staff-listino__banner-actions">
      <button type="button" class="btn btn--primary btn--sm" id="confirm_yes">‚úì Conferma</button>
      <button type="button" class="btn btn--ghost btn--sm" id="confirm_no">‚úï Annulla</button>
    </div>
    </div>

  <!-- System Banner - Successo -->
  <div id="success_banner" class="staff-listino__system-banner staff-listino__system-banner--success" role="status" aria-live="polite" style="display: none;">
    <div class="staff-listino__banner-icon">‚úÖ</div>
    <div class="staff-listino__banner-content">
      <div class="staff-listino__banner-title">Acquisto Registrato</div>
      <div id="success_text" class="staff-listino__banner-message"></div>
    </div>
    <button type="button" class="staff-listino__banner-close" onclick="this.parentElement.style.display='none';" aria-label="Chiudi">√ó</button>
      </div>

  <!-- System Banner - Errore -->
  <div id="error_banner" class="staff-listino__system-banner staff-listino__system-banner--error" role="alert" style="display: none;">
    <div class="staff-listino__banner-icon">‚ö†Ô∏è</div>
    <div class="staff-listino__banner-content">
      <div id="error_text" class="staff-listino__banner-message"></div>
    </div>
    <button type="button" class="staff-listino__banner-close" onclick="this.parentElement.style.display='none';" aria-label="Chiudi">√ó</button>
    </div>

  <!-- Hidden Fields -->
  <input type="hidden" id="qr_hidden" name="qr">
    <input type="hidden" name="confirm_token" id="confirm_token" value="">
  </form>

<!-- Scripts -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script src="{{ url_for('static', filename='js/qr-scanner.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){
  // Elements
  const form = document.getElementById('listinoForm');
  const qrHidden = document.getElementById('qr_hidden');
  const qrManual = document.getElementById('qr_manual');
  const noteInput = document.getElementById('note_input');
  const puntoVendita = document.getElementById('punto_vendita');
  const submitBtn = document.getElementById('submit_btn');
  const totaleEl = document.getElementById('totale');
  const puntiEl = document.getElementById('punti');
  const confirmBanner = document.getElementById('confirm_banner');
  const confirmText = document.getElementById('confirm_text');
  const confirmYes = document.getElementById('confirm_yes');
  const confirmNo = document.getElementById('confirm_no');
  const successBanner = document.getElementById('success_banner');
  const successText = document.getElementById('success_text');
  const errorBanner = document.getElementById('error_banner');
  const errorText = document.getElementById('error_text');
  const clienteInfo = document.getElementById('cliente_info');
  const clientePrompt = document.getElementById('cliente_prompt');
  const prodottiSection = document.getElementById('prodotti_section');
  const optionsSection = document.getElementById('options_section');
  const riepiegoSection = document.getElementById('riepilogo_section');
  const scannerStatus = document.getElementById('scanner_status');
  const actionsSection = document.querySelector('.staff-listino__actions');
  
  let clienteData = null;
  let clienteAbilitato = false;
  let allowSubmit = false;
  
  const searchInput = document.getElementById('search_cliente');
  const searchResults = document.getElementById('search_results');
  const tabs = document.querySelectorAll('.staff-scanner__tab');
  const tabContents = document.querySelectorAll('.staff-scanner__tab-content');

  // Tab switching
  tabs.forEach(tab => {
    tab.addEventListener('click', function(e){
      e.preventDefault();
      const targetTab = this.dataset.tab;
      
      // Deselect all tabs
      tabs.forEach(t => t.classList.remove('staff-scanner__tab--active'));
      tabContents.forEach(tc => tc.classList.remove('staff-scanner__tab-content--active'));
      
      // Select current tab
      this.classList.add('staff-scanner__tab--active');
      document.getElementById(`tab-${targetTab}`).classList.add('staff-scanner__tab-content--active');
      
      if (targetTab === 'search') {
        searchInput.focus();
      }
    });
  });

  // Update status message
  function updateStatus(type, message) {
    const iconMap = {'idle': '‚è≥', 'found': '‚úÖ', 'error': '‚ùå', 'loading': '‚åõ'};
    scannerStatus.className = `staff-scanner__status staff-scanner__status--${type}`;
    scannerStatus.innerHTML = `
      <span class="staff-scanner__status-icon">${iconMap[type]}</span>
      <span class="staff-scanner__status-text">${message}</span>
    `;
  }

  // Lock/Unlock UI
  function setLockedUI(locked) {
    document.querySelectorAll('.prodotto-checkbox').forEach(cb => cb.disabled = locked);
    document.querySelectorAll('input[name^="quantita_"]').forEach(inp => inp.disabled = locked);
    document.querySelectorAll('.staff-listino__qty-btn').forEach(btn => btn.disabled = locked);
    if (puntoVendita) puntoVendita.disabled = locked;
    if (noteInput) noteInput.disabled = locked;
  }

  // Show/Hide sections
  function updateSectionsVisibility(showProducts) {
    if (showProducts) {
      clientePrompt.style.display = 'none';
      clienteInfo.style.display = 'block';
      prodottiSection.style.display = 'block';
      optionsSection.style.display = 'block';
      riepiegoSection.style.display = 'block';
      actionsSection.style.display = 'block';
    } else {
      clientePrompt.style.display = 'block';
      clienteInfo.style.display = 'none';
      prodottiSection.style.display = 'none';
      optionsSection.style.display = 'none';
      riepiegoSection.style.display = 'none';
      actionsSection.style.display = 'none';
    }
  }

  setLockedUI(true);
  updateSectionsVisibility(false);

  // QR Scanned
  document.addEventListener('qr-scanned', function(event){
    resetSelections();
    setLockedUI(true);
    clienteAbilitato = false;
    allowSubmit = false;
    confirmBanner.style.display = 'none';
    successBanner.style.display = 'none';
    errorBanner.style.display = 'none';
    updateStatus('idle', 'Scansione riconosciuta...');
    const code = event?.detail?.code;
    if (code) fetchClienteInfo(code);
  });

  // Calcola totale
  function updateTotale(){
    let totale = 0;
    document.querySelectorAll('.prodotto-checkbox:checked').forEach(cb => {
      const pid = parseInt(cb.value);
      const qty = parseInt(document.querySelector(`input[name="quantita_${pid}"]`)?.value || 1);
      const prezzoUnitario = parseFloat(cb.dataset.prezzo || '0');
      totale += prezzoUnitario * qty;
    });
    totaleEl.textContent = '‚Ç¨' + totale.toFixed(2);
    puntiEl.textContent = Math.floor(totale / 10);
    checkForm();
  }

  // Reset
  function resetSelections() {
    document.querySelectorAll('.prodotto-checkbox').forEach(cb => {
      cb.checked = false;
      const wrapper = cb.closest('.staff-listino__prodotto-item')?.querySelector('.staff-listino__quantita-wrapper');
      if (wrapper) {
        wrapper.style.display = 'none';
        const qtyInput = wrapper.querySelector('input[type="number"]');
        if (qtyInput) qtyInput.value = 1;
      }
    });
    updateTotale();
  }
  
  // Product checkbox change
  document.querySelectorAll('.prodotto-checkbox').forEach(cb => {
    cb.addEventListener('change', function(){
      const wrapper = this.closest('.staff-listino__prodotto-item')?.querySelector('.staff-listino__quantita-wrapper');
      if (wrapper) {
        wrapper.style.display = this.checked ? 'flex' : 'none';
        if (!this.checked) {
          const qtyInput = wrapper.querySelector('input[type="number"]');
        if (qtyInput) qtyInput.value = 1;
        }
      }
      updateTotale();
    });
  });

  // Quantity buttons
  document.querySelectorAll('.staff-listino__qty-btn').forEach(btn => {
    btn.addEventListener('click', function(e){
      e.preventDefault();
      const productId = this.dataset.productId;
      const input = document.querySelector(`input[name="quantita_${productId}"]`);
      if (!input) return;
      
      const currentVal = parseInt(input.value) || 1;
      if (this.classList.contains('staff-listino__qty-btn--plus')) {
        input.value = currentVal + 1;
      } else if (this.classList.contains('staff-listino__qty-btn--minus')) {
        input.value = Math.max(1, currentVal - 1);
      }
      updateTotale();
    });
  });
  
  // Quantity input change
  document.querySelectorAll('input[name^="quantita_"]').forEach(input => {
    input.addEventListener('change', updateTotale);
    input.addEventListener('input', updateTotale);
  });
  
  // Form validation
  function checkForm(){
    const hasQR = qrHidden.value.trim().length > 0;
    const hasProdotti = document.querySelectorAll('.prodotto-checkbox:checked').length > 0;
    const punto = puntoVendita.value;
    const hasNote = noteInput.value.trim().length > 0;
    
    let valid = hasQR && hasProdotti && clienteAbilitato;
    
    if (punto === 'tavolo' || punto === 'priv√®') {
      valid = valid && hasNote;
    }
    
    submitBtn.disabled = !valid;
  }
  
  puntoVendita.addEventListener('change', checkForm);
  noteInput.addEventListener('input', checkForm);
  
  // Fetch cliente info
  async function fetchClienteInfo(qrCode) {
    clienteData = null;
    clienteAbilitato = false;
    setLockedUI(true);
    updateStatus('loading', 'Verifica cliente...');
    errorBanner.style.display = 'none';
    
    try {
      const res = await fetch("{{ url_for('consumi.staff_cliente_info') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'same-origin',
        body: JSON.stringify({ qr: qrCode })
      });
      const data = await res.json();
      
      if (!data.ok) {
        let msg = 'Impossibile procedere.';
        if (data.reason === 'not_found') msg = 'Cliente non trovato. Verifica il QR.';
        else if (data.reason === 'no_event' || data.reason === 'event_closed') msg = 'Evento non operativo.';
        else if (data.reason === 'missing_qr') msg = 'QR non valido.';
        
        updateStatus('error', msg);
        errorText.textContent = msg;
        errorBanner.style.display = 'block';
        resetSelections();
        updateSectionsVisibility(false);
        checkForm();
        return;
      }

      clienteData = data.cliente;
      const nomeCompleto = [clienteData.nome, clienteData.cognome].filter(Boolean).join(' ');
      document.getElementById('client_name').textContent = nomeCompleto || 'Cliente';

      if (!data.ha_ingresso) {
        updateStatus('error', '‚ö†Ô∏è Cliente non entrato a questo evento');
        errorText.textContent = 'Attenzione: il cliente non risulta entrato a questo evento.';
        errorBanner.style.display = 'block';
        clienteAbilitato = false;
        resetSelections();
        updateSectionsVisibility(false);
      } else {
        updateStatus('found', '‚úì Cliente verificato');
        errorBanner.style.display = 'none';
        clienteAbilitato = true;
        setLockedUI(false);
        updateSectionsVisibility(true);
      }
      checkForm();
    } catch (err) {
      console.error('Errore:', err);
      updateStatus('error', '‚ùå Errore recupero cliente');
      errorText.textContent = 'Impossibile recuperare le informazioni del cliente.';
      errorBanner.style.display = 'block';
      resetSelections();
      updateSectionsVisibility(false);
      checkForm();
    }
  }

  // Search cliente functionality
  let searchTimeout = null;
  if (searchInput) {
    searchInput.addEventListener('input', function(){
      clearTimeout(searchTimeout);
      const query = this.value.trim();
      
      if (!query || query.length < 2) {
        searchResults.innerHTML = '';
        return;
      }

      searchTimeout = setTimeout(async () => {
        updateStatus('loading', 'Ricerca in corso...');
        
        try {
          const res = await fetch("{{ url_for('consumi.staff_search_cliente') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            credentials: 'same-origin',
            body: JSON.stringify({ q: query })
          });

          const data = await res.json();
          
          if (!data.ok || !data.clienti || data.clienti.length === 0) {
            searchResults.innerHTML = '<div class="staff-scanner__search-empty">‚ùå Nessun cliente trovato</div>';
            updateStatus('error', 'Cliente non trovato');
            return;
          }

          // Build results
          let html = '<div class="staff-scanner__search-list">';
          data.clienti.forEach(cli => {
            const statusBadge = cli.ha_ingresso 
              ? '<span class="staff-scanner__client-badge staff-scanner__client-badge--entered">‚úì Entrato</span>'
              : '<span class="staff-scanner__client-badge staff-scanner__client-badge--not-entered">‚ö†Ô∏è Non entrato</span>';
            
            html += `
              <button type="button" class="staff-scanner__search-result" data-qr="${cli.qr}" data-has-ingresso="${cli.ha_ingresso}">
                <div class="staff-scanner__result-name">${cli.nome} ${cli.cognome}</div>
                ${statusBadge}
              </button>
            `;
          });
          html += '</div>';
          searchResults.innerHTML = html;

          // Add click handlers
          document.querySelectorAll('.staff-scanner__search-result').forEach(btn => {
            btn.addEventListener('click', function(e){
              e.preventDefault();
              const qr = this.dataset.qr;
              const hasIngresso = this.dataset.hasIngresso === 'true';
              
              qrHidden.value = qr;
              searchInput.value = this.querySelector('.staff-scanner__result-name').textContent;
              searchResults.innerHTML = '';
              
              if (hasIngresso) {
                updateStatus('found', 'Cliente selezionato e verificato ‚úì');
                fetchClienteInfo(qr);
              } else {
                updateStatus('error', 'Cliente non entrato a questo evento');
              }
            });
          });

          updateStatus('found', `${data.clienti.length} cliente/i trovato/i`);
        } catch (err) {
          console.error('Errore ricerca:', err);
          updateStatus('error', 'Errore durante la ricerca');
          searchResults.innerHTML = '<div class="staff-scanner__search-empty">‚ùå Errore durante la ricerca</div>';
        }
      }, 300);
    });
  }

  // Manual input
  if (qrManual) {
    const handleManualInput = function(){
      const val = qrManual.value.trim();
      if (!val) {
        clienteData = null;
        clienteAbilitato = false;
        errorText.textContent = 'Inserisci un QR valido.';
        errorBanner.style.display = 'block';
        setLockedUI(true);
        resetSelections();
        updateSectionsVisibility(false);
        confirmBanner.style.display = 'none';
        successBanner.style.display = 'none';
        updateStatus('idle', 'In attesa di scansione...');
        checkForm();
        return;
      }
      setTimeout(() => {
        resetSelections();
        setLockedUI(true);
        confirmBanner.style.display = 'none';
        successBanner.style.display = 'none';
        errorBanner.style.display = 'none';
        fetchClienteInfo(val);
      }, 300);
    };
    qrManual.addEventListener('input', handleManualInput);
    qrManual.addEventListener('blur', handleManualInput);
  }

  // Form submission - Show confirm banner
  form.addEventListener('submit', function(event){
    if (allowSubmit) return;
    event.preventDefault();
    
    const summary = [];
    document.querySelectorAll('.prodotto-checkbox:checked').forEach(cb => {
      const pid = cb.value;
      const nome = cb.dataset.nome || 'Prodotto';
      const qty = parseInt(document.querySelector(`input[name="quantita_${pid}"]`)?.value || '1', 10);
      summary.push(qty > 1 ? `${nome} x${qty}` : nome);
    });

    if (summary.length === 0) return;

    const nomeCliente = clienteData ? [clienteData.nome, clienteData.cognome].filter(Boolean).join(' ').trim() : 'Cliente';
    confirmText.innerHTML = `Addebita <strong>${summary.join(', ')}</strong> a <strong>${nomeCliente}</strong>?`;
    confirmBanner.style.display = 'flex';
    successBanner.style.display = 'none';
    errorBanner.style.display = 'none';
    confirmBanner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });

  // Confirm handlers
  confirmNo.addEventListener('click', function(){
    confirmBanner.style.display = 'none';
  });

  confirmYes.addEventListener('click', function(){
    const summary = [];
    document.querySelectorAll('.prodotto-checkbox:checked').forEach(cb => {
      const pid = cb.value;
      const nome = cb.dataset.nome || 'Prodotto';
      const qty = parseInt(document.querySelector(`input[name="quantita_${pid}"]`)?.value || '1', 10);
      summary.push(qty > 1 ? `${nome} x${qty}` : nome);
    });

    const nomeCliente = clienteData ? [clienteData.nome, clienteData.cognome].filter(Boolean).join(' ').trim() : 'Cliente';
    const summary_text = summary.join(', ');
    
    // Hide confirm, show success
    confirmBanner.style.display = 'none';
    successText.innerHTML = `Addebito di <strong>${summary_text}</strong> confermato per <strong>${nomeCliente}</strong>`;
    successBanner.style.display = 'flex';
    successBanner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Submit form after delay
    allowSubmit = true;
    confirmToken.value = Date.now().toString();
    setTimeout(() => form.submit(), 1500);
  });
});
</script>

{% endblock %}
