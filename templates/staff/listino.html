{% extends "staff/base.html" %}
{% from "staff/partials/qr_scanner.html" import render_qr_scanner %}
{% block staff_title %}Listino{% endblock %}

{% block extra_head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/qr-scanner.css') }}">
{% endblock %}

{% block staff_content %}
<section class="card">
  <h1 class="card__title">üìã Listino Prodotti</h1>
  <div class="card__meta">
    <strong>Evento:</strong> {{ evento.data_evento.strftime('%d/%m/%Y') }} ‚Äî {{ evento.nome_evento }}
  </div>
</section>

<!-- Scanner QR -->
<section class="card">
  <h2 class="card__title">üîç Scanner QR Cliente</h2>
  <p class="text--muted" style="margin-bottom: 1.5rem;">
    Scansiona il QR del cliente, poi seleziona i prodotti da addebitare.
  </p>
  
  <form id="listinoForm" method="post" action="{{ url_for('consumi.staff_listino_addebito') }}">
    {{ render_qr_scanner(container_id='qr-reader', form_id='listinoForm', auto_submit=False, show_manual_input=True, result_input_id='qr_hidden', manual_input_id='qr_manual', manual_input_label='QR Code Cliente', manual_input_placeholder='Oppure inserisci manualmente il QR code') }}

    <!-- Listino prodotti per categoria -->
    {% if prodotti_per_categoria %}
    <div class="form__group" style="margin-top: 2rem;">
      <label class="form__label">Seleziona Prodotti</label>
      
      {% for categoria, prodotti_cat in prodotti_per_categoria.items() %}
      <div style="margin-bottom: 2rem; padding: 1rem; background: rgba(212, 175, 55, 0.05); border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.1);">
        <h3 style="margin: 0 0 1rem 0; color: var(--gold-primary); font-size: 1.125rem;">{{ categoria }}</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
          {% for p in prodotti_cat %}
          <div style="padding: 1rem; background: var(--black-soft); border-radius: 6px; border: 1px solid rgba(212, 175, 55, 0.1);">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" name="prodotto_id" value="{{ p.id_prodotto }}" class="prodotto-checkbox" style="width: 20px; height: 20px;" disabled>
              <div style="flex: 1;">
                <strong style="display: block; color: var(--text-light);">{{ p.nome }}</strong>
                <span style="color: var(--gold-primary); font-weight: 600;">‚Ç¨{{ "%.2f"|format(p.prezzo) }}</span>
              </div>
            </label>
            <div style="margin-top: 0.5rem; display: none;" class="quantita-container">
              <label class="form__label" style="font-size: 0.75rem;">Quantit√†:</label>
              <input type="number" name="quantita_{{ p.id_prodotto }}" value="1" min="1" class="form__input" style="padding: 0.5rem; font-size: 0.875rem;" disabled>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div style="padding: 2rem; text-align: center; color: var(--text-muted);">
      <p>Nessun prodotto disponibile nel listino.</p>
      <p style="font-size: 0.875rem; margin-top: 0.5rem;">L'admin deve aggiungere prodotti al listino.</p>
    </div>
    {% endif %}

    {% if prodotti_per_categoria %}
    <div class="grid grid--2" style="margin-top: 1.5rem;">
      <div class="form__group">
        <label class="form__label">Punto Vendita</label>
        <select class="form__input" name="punto_vendita" required disabled>
          <option value="bar">Bar</option>
          <option value="tavolo">Tavolo</option>
          <option value="priv√®">Priv√®</option>
        </select>
      </div>
      <div class="form__group">
        <label class="form__label">Note</label>
        <input class="form__input" type="text" name="note" placeholder="Es. Tavolo 7" id="note_input" disabled>
        <small>Obbligatorio per Tavolo/Priv√®</small>
      </div>
    </div>

    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(212, 175, 55, 0.1); border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.2);">
      <strong style="display: block; margin-bottom: 0.5rem; color: var(--gold-primary);">Totale selezionato:</strong>
      <div id="totale" style="font-size: 1.5rem; font-weight: 700; color: var(--text-light);">‚Ç¨0.00</div>
      <small style="color: var(--text-muted);">Punti che verranno assegnati: <span id="punti">0</span></small>
    </div>

    <div class="form__actions" style="margin-top: 1.5rem;">
      <button class="btn btn--primary" type="submit" id="submit_btn" disabled>Addebita al Cliente</button>
      <a href="{{ url_for('staff.dashboard') }}" class="btn btn--ghost">Annulla</a>
    </div>
    {% endif %}
  </form>
</section>

<!-- html5-qrcode da CDN -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- Modulo scanner QR -->
<script src="{{ url_for('static', filename='js/qr-scanner.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const form = document.getElementById('listinoForm');
  const qrHidden = document.getElementById('qr_hidden');
  const qrManual = document.getElementById('qr_manual');
  const noteInput = document.getElementById('note_input');
  const puntoVendita = document.querySelector('select[name="punto_vendita"]');
  const submitBtn = document.getElementById('submit_btn');
  const totaleEl = document.getElementById('totale');
  const puntiEl = document.getElementById('punti');
  
  // Blocca elementi fino allo scan
  function setLockedUI(locked) {
    document.querySelectorAll('.prodotto-checkbox').forEach(cb => cb.disabled = locked);
    document.querySelectorAll('input[name^=\"quantita_\"]').forEach(inp => inp.disabled = locked);
    if (puntoVendita) puntoVendita.disabled = locked;
    if (noteInput) noteInput.disabled = locked;
  }
  setLockedUI(!qrHidden.value);

  // Sblocca al primo scan
  document.addEventListener('qr-scanned', function(){
    setLockedUI(false);
    checkForm();
  });

  // Calcola totale e punti - costruisci dizionario prezzi da tutti i prodotti
  const prezzi = {};
  {% if prodotti %}
  {% for p in prodotti %}
  prezzi[{{ p.id_prodotto }}] = {{ p.prezzo }};
  {% endfor %}
  {% endif %}
  {% if prodotti_per_categoria %}
  {% for categoria, prodotti_cat in prodotti_per_categoria.items() %}
  {% for p in prodotti_cat %}
  if (!prezzi[{{ p.id_prodotto }}]) {
    prezzi[{{ p.id_prodotto }}] = {{ p.prezzo }};
  }
  {% endfor %}
  {% endfor %}
  {% endif %}
  
  function updateTotale(){
    let totale = 0;
    document.querySelectorAll('.prodotto-checkbox:checked').forEach(cb => {
      const pid = parseInt(cb.value);
      const qty = parseInt(document.querySelector(`input[name="quantita_${pid}"]`)?.value || 1);
      totale += (prezzi[pid] || 0) * qty;
    });
    totaleEl.textContent = '‚Ç¨' + totale.toFixed(2);
    puntiEl.textContent = Math.floor(totale / 10);
    checkForm();
  }
  
  // Mostra/nascondi quantit√† quando si seleziona prodotto
  document.querySelectorAll('.prodotto-checkbox').forEach(cb => {
    cb.addEventListener('change', function(){
      const container = this.closest('div').querySelector('.quantita-container');
      if (this.checked) {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
        const qtyInput = container.querySelector('input[type="number"]');
        if (qtyInput) qtyInput.value = 1;
      }
      updateTotale();
    });
  });
  
  // Aggiorna totale quando cambia quantit√†
  document.querySelectorAll('input[name^="quantita_"]').forEach(input => {
    input.addEventListener('change', updateTotale);
    input.addEventListener('input', updateTotale);
  });
  
  // Validazione form
  function checkForm(){
    const hasQR = qrHidden.value.trim().length > 0;
    const hasProdotti = document.querySelectorAll('.prodotto-checkbox:checked').length > 0;
    const punto = puntoVendita.value;
    const hasNote = noteInput.value.trim().length > 0;
    
    let valid = hasQR && hasProdotti;
    
    if (punto === 'tavolo' || punto === 'priv√®') {
      valid = valid && hasNote;
    }
    
    submitBtn.disabled = !valid;
  }
  
  puntoVendita.addEventListener('change', checkForm);
  noteInput.addEventListener('input', checkForm);
  
  // Inizializza
  checkForm();
});
</script>
{% endblock %}

