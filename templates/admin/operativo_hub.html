{% extends "admin/base.html" %}
{% block admin_title %}Operativo{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}
{% from "admin/_secondary_nav.html" import render_secondary_nav %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_secondary_nav([
    {'url': url_for('prenotazioni.admin_hub'), 'endpoint': 'prenotazioni.admin_hub', 'label': 'Hub Operativo', 'icon': 'ğŸ“‹'},
    {'url': url_for('prenotazioni.admin_list'), 'endpoint': 'prenotazioni.admin_list', 'label': 'Prenotazioni', 'icon': 'ğŸ“'},
    {'url': url_for('ingressi.admin_list'), 'endpoint': 'ingressi.admin_list', 'label': 'Ingressi', 'icon': 'ğŸšª'},
    {'url': url_for('consumi.admin_list'), 'endpoint': 'consumi.admin_list', 'label': 'Consumi', 'icon': 'ğŸ’°'},
    {'url': url_for('feedback.admin_list'), 'endpoint': 'feedback.admin_list', 'label': 'Feedback', 'icon': 'ğŸ’¬'},
  ], current_endpoint=request.endpoint) }}
  
  {{ render_page_header(
    title="Gestione Operativa",
    subtitle="Prenotazioni, ingressi e consumi Â· Monitoraggio in tempo reale",
    actions=None,
    breadcrumbs=[
      {'label': 'Operativo', 'url': url_for('prenotazioni.admin_hub')}
    ]
  ) }}

<!-- Banner Evento Operativo -->
{% if evento_operativo %}
<section class="card" style="margin-bottom: 2rem; border-left: 4px solid #10b981; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
        <span style="font-size: 1.5rem;">ğŸŸ¢</span>
        <span style="font-weight: 600; color: #10b981;">EVENTO OPERATIVO IN CORSO</span>
      </div>
      <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem;">{{ evento_operativo.nome_evento }}</h2>
      <p class="text--muted" style="margin: 0;">
        ğŸ“… {{ evento_operativo.data_evento.strftime('%d/%m/%Y') if evento_operativo.data_evento else 'Data da definire' }}
        {% if evento_operativo.categoria %} â€¢ {{ evento_operativo.categoria|capitalize }}{% endif %}
      </p>
    </div>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      <a href="{{ url_for('eventi.admin_evento_detail', evento_id=evento_operativo.id_evento) }}" class="btn btn--primary">
        ğŸ“Š Dashboard Evento
      </a>
    </div>
  </div>
  
  <!-- Statistiche Evento Corrente -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
    <div style="text-align: center;">
      <div class="text--muted" style="font-size: 0.85rem;">Prenotazioni</div>
      <div style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;">{{ tot_prenotazioni_oggi }}</div>
    </div>
    <div style="text-align: center;">
      <div class="text--muted" style="font-size: 0.85rem;">Ingressi</div>
      <div style="font-size: 1.75rem; font-weight: 700; color: #3b82f6;">{{ tot_ingressi_oggi }}</div>
    </div>
    <div style="text-align: center;">
      <div class="text--muted" style="font-size: 0.85rem;">Consumi</div>
      <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;">â‚¬{{ "%.0f"|format(tot_consumi_oggi) }}</div>
    </div>
  </div>
</section>
{% else %}
<section class="card" style="margin-bottom: 2rem; border-left: 4px solid #6b7280; background: rgba(107, 114, 128, 0.1);">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
        <span style="font-size: 1.5rem;">âšª</span>
        <span style="font-weight: 600; color: #6b7280;">NESSUN EVENTO OPERATIVO</span>
      </div>
      <p class="text--muted" style="margin: 0;">Imposta un evento operativo per visualizzare le statistiche in tempo reale.</p>
    </div>
    <a href="{{ url_for('eventi.admin_evento_attivo') }}" class="btn btn--secondary">
      ğŸ¯ Imposta Evento
    </a>
  </div>
</section>
{% endif %}

<!-- Statistiche Globali -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
  <div class="card" style="padding: 1.25rem; text-align: center; border-left: 4px solid #f59e0b;">
    <div style="font-size: 2.5rem; font-weight: 700; color: #f59e0b;">{{ tot_prenotazioni_attive }}</div>
    <div class="text--muted" style="margin-top: 0.5rem; font-size: 0.9rem;">Prenotazioni Attive</div>
    <div class="text--muted" style="margin-top: 0.25rem; font-size: 0.75rem;">(tutti gli eventi)</div>
  </div>
</div>

<!-- Sezioni Operative -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem;">
  
  <!-- Prenotazioni -->
  <section class="card">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
      <span style="font-size: 1.75rem;">ğŸ“‹</span>
      <div>
        <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Prenotazioni</h2>
        <p class="text--muted" style="margin: 0; font-size: 0.85rem;">Gestione liste e tavoli</p>
      </div>
    </div>
    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
      <a href="{{ url_for('prenotazioni.admin_list') }}" class="btn btn--primary" style="width: 100%; justify-content: flex-start;">
        ğŸ“‹ Tutte le Prenotazioni
      </a>
      {% if evento_operativo %}
      <a href="{{ url_for('prenotazioni.admin_list', evento_id=evento_operativo.id_evento) }}" class="btn btn--ghost" style="width: 100%; justify-content: flex-start;">
        ğŸ¯ Prenotazioni Evento Attivo
      </a>
      {% endif %}
      <a href="{{ url_for('prenotazioni.admin_new') }}" class="btn btn--ghost" style="width: 100%; justify-content: flex-start;">
        â• Nuova Prenotazione
      </a>
    </div>
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <p class="text--muted" style="margin: 0; font-size: 0.8rem;">
        Gestisci prenotazioni in lista (ğŸ“‹) e tavoli (ğŸª‘)
      </p>
    </div>
  </section>

  <!-- Ingressi -->
  <section class="card">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
      <span style="font-size: 1.75rem;">ğŸšª</span>
      <div>
        <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Ingressi</h2>
        <p class="text--muted" style="margin: 0; font-size: 0.85rem;">Check-in e registro accessi</p>
      </div>
    </div>
    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
      <a href="{{ url_for('ingressi.admin_list') }}" class="btn btn--primary" style="width: 100%; justify-content: flex-start;">
        ğŸ“‹ Tutti gli Ingressi
      </a>
      {% if evento_operativo %}
      <a href="{{ url_for('ingressi.admin_list', evento_id=evento_operativo.id_evento) }}" class="btn btn--ghost" style="width: 100%; justify-content: flex-start;">
        ğŸ¯ Ingressi Evento Attivo
      </a>
      {% endif %}
      <a href="{{ url_for('ingressi.admin_new') }}" class="btn btn--ghost" style="width: 100%; justify-content: flex-start;">
        â• Nuovo Ingresso
      </a>
    </div>
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <p class="text--muted" style="margin: 0; font-size: 0.8rem;">
        Registra ingressi tramite QR code o manualmente
      </p>
    </div>
  </section>

  <!-- Consumi -->
  <section class="card">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
      <span style="font-size: 1.75rem;">ğŸ’°</span>
      <div>
        <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Consumi</h2>
        <p class="text--muted" style="margin: 0; font-size: 0.85rem;">Ordini e vendite</p>
      </div>
    </div>
    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
      <a href="{{ url_for('consumi.admin_list') }}" class="btn btn--primary" style="width: 100%; justify-content: flex-start;">
        ğŸ“‹ Tutti i Consumi
      </a>
      {% if evento_operativo %}
      <a href="{{ url_for('consumi.admin_list', evento_id=evento_operativo.id_evento) }}" class="btn btn--ghost" style="width: 100%; justify-content: flex-start;">
        ğŸ¯ Consumi Evento Attivo
      </a>
      {% endif %}
      <a href="{{ url_for('consumi.admin_new') }}" class="btn btn--ghost" style="width: 100%; justify-content: flex-start;">
        â• Nuovo Consumo
      </a>
    </div>
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <p class="text--muted" style="margin: 0; font-size: 0.8rem;">
        Traccia vendite e genera punti fedeltÃ 
      </p>
    </div>
  </section>

  <!-- Feedback -->
  <section class="card">
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
      <span style="font-size: 1.75rem;">ğŸ’¬</span>
      <div>
        <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0;">Feedback</h2>
        <p class="text--muted" style="margin: 0; font-size: 0.85rem;">Valutazioni clienti</p>
      </div>
    </div>
    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
      <a href="{{ url_for('feedback.admin_list') }}" class="btn btn--primary" style="width: 100%; justify-content: flex-start;">
        ğŸ“‹ Tutti i Feedback
      </a>
      {% if evento_operativo %}
      <a href="{{ url_for('feedback.admin_list', evento_id=evento_operativo.id_evento) }}" class="btn btn--ghost" style="width: 100%; justify-content: flex-start;">
        ğŸ¯ Feedback Evento Attivo
      </a>
      {% endif %}
    </div>
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <p class="text--muted" style="margin: 0; font-size: 0.8rem;">
        Recensioni su musica, ingresso, ambiente e servizio
      </p>
    </div>
  </section>
</div>

<!-- Filtro Rapido per Evento -->
{% if eventi_recenti %}
<section class="card" style="margin-top: 2rem;">
  <h2 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;">ğŸ” Accesso Rapido per Evento</h2>
  <p class="text--muted" style="margin-bottom: 1rem; font-size: 0.9rem;">Seleziona un evento per visualizzare i dati filtrati:</p>
  <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
    {% for e in eventi_recenti[:6] %}
    <a href="{{ url_for('eventi.admin_evento_detail', evento_id=e.id_evento) }}" class="btn btn--ghost btn--small" style="flex: 1 1 180px; justify-content: flex-start; text-align: left;">
      <span style="margin-right: 0.5rem;">
        {% if e.stato_pubblico == 'attivo' %}ğŸŸ¢{% elif e.stato_pubblico == 'programmato' %}ğŸ“…{% else %}âšª{% endif %}
      </span>
      <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
        {{ e.nome_evento[:20] }}{% if e.nome_evento|length > 20 %}...{% endif %}
      </span>
    </a>
    {% endfor %}
  </div>
</section>
{% endif %}

</div>
{% endblock %}

