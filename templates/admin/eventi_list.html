{% extends "admin/base.html" %}
{% block admin_title %}Eventi{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_page_header(
    title="Gestione Eventi",
    subtitle="Oggi: " ~ (oggi.strftime('%d/%m/%Y') if oggi else 'N/A'),
    actions=[
      {'type': 'link', 'url': url_for('eventi.admin_new'), 'label': '+ Nuovo Evento', 'class': 'btn--primary'}
    ],
    breadcrumbs=[
      {'label': 'Eventi', 'url': url_for('eventi.admin_list')}
    ]
  ) }}

  <!-- Statistiche rapide -->
  <div class="grid grid--auto">
    <div class="stat-card" style="border-left: 4px solid var(--admin-accent); text-align: center;">
      <div class="stat-card__value" style="font-size: var(--font-size-2xl);">{{ eventi|length }}</div>
      <div class="stat-card__label">Totale Eventi</div>
    </div>
    <div class="stat-card" style="border-left: 4px solid var(--color-green-accent); text-align: center;">
      <div class="stat-card__value" style="font-size: var(--font-size-2xl); color: var(--color-green-accent);">{{ eventi_programmati|length }}</div>
      <div class="stat-card__label">Programmati</div>
    </div>
    <div class="stat-card" style="border-left: 4px solid #6b7280; text-align: center;">
      <div class="stat-card__value" style="font-size: var(--font-size-2xl); color: #6b7280;">{{ eventi_passati|length }}</div>
      <div class="stat-card__label">Passati</div>
    </div>
  </div>

  <!-- Filtri -->
  <section class="card">
    <form method="get" class="form__actions" style="border-top: none; padding-top: 0; margin-top: 0;">
      <div class="form__group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
        <label class="form__label">Filtra per stato</label>
        <select class="form__select" name="stato" onchange="this.form.submit()">
          <option value="">Tutti gli stati</option>
          <option value="programmato" {% if stato=='programmato' %}selected{% endif %}>Programmato</option>
          <option value="attivo" {% if stato=='attivo' %}selected{% endif %}>Attivo (pubblico)</option>
          <option value="chiuso" {% if stato=='chiuso' %}selected{% endif %}>Chiuso</option>
        </select>
      </div>
      <div class="form__group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
        <label class="form__label">Filtra per periodo</label>
        <select class="form__select" name="periodo" onchange="this.form.submit()">
          <option value="">Tutti</option>
          <option value="programmati" {% if periodo=='programmati' %}selected{% endif %}>Solo futuri</option>
          <option value="passati" {% if periodo=='passati' %}selected{% endif %}>Solo passati</option>
        </select>
      </div>
      {% if stato or periodo %}
      <div class="form__group" style="margin-bottom: 0;">
        <a href="{{ url_for('eventi.admin_list') }}" class="btn btn--ghost">Reset</a>
      </div>
      {% endif %}
    </form>
  </section>

  <!-- Lista eventi programmati -->
  {% if not periodo or periodo == 'programmati' %}
  {% if eventi_programmati %}
  <section class="card">
    <div class="card__header">
      <h2 class="card__title">üìÖ Eventi Programmati ({{ eventi_programmati|length }})</h2>
    </div>
    <div class="card__content">
      <div style="display: flex; flex-direction: column; gap: var(--spacing-4);">
        {% for e in eventi_programmati %}
        <article class="card" style="border-left: 4px solid {% if e.is_staff_operativo %}var(--color-green-accent){% elif e.stato_pubblico == 'attivo' %}#3b82f6{% else %}#6b7280{% endif %}; margin-bottom: 0;">
          <div style="display: flex; gap: var(--spacing-4); flex-wrap: wrap;">
            {% if e.cover_url %}
            <div style="flex-shrink: 0;">
              <img src="{{ url_for('static', filename='uploads/eventi/' + e.cover_url) }}" 
                   alt="{{ e.nome_evento }}" 
                   style="width: 120px; height: 80px; object-fit: cover; border-radius: var(--radius-md);">
            </div>
            {% endif %}
            <div style="flex: 1; min-width: 250px;">
              <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--spacing-3); flex-wrap: wrap; margin-bottom: var(--spacing-3);">
                <div style="flex: 1;">
                  <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin: 0 0 var(--spacing-2); color: var(--admin-text);">
                    {{ e.nome_evento }}
                  </h3>
                  <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-2); align-items: center;">
                    <span class="badge {% if e.stato_pubblico == 'attivo' %}badge--success{% elif e.stato_pubblico == 'programmato' %}badge--secondary{% else %}badge--secondary{% endif %}">
                      {% if e.stato_pubblico == 'attivo' %}‚úÖ ATTIVO{% elif e.stato_pubblico == 'programmato' %}üìã PROGRAMMATO{% else %}üîí CHIUSO{% endif %}
                    </span>
                    <span class="badge badge--secondary">{{ e.categoria|capitalize }}</span>
                  </div>
                </div>
              </div>
              <div class="text--muted" style="font-size: var(--font-size-sm); margin-bottom: var(--spacing-3);">
                <div style="margin-bottom: var(--spacing-1);">
                  <strong>üìÖ Data:</strong> {{ e.data_evento.strftime('%d/%m/%Y') if e.data_evento else 'N/A' }}
                  {% if e.dj_artista %} ‚Ä¢ <strong>DJ:</strong> {{ e.dj_artista }}{% endif %}
                </div>
                {% if e.capienza_max %}
                <div>
                  <strong>üë• Ingressi:</strong> {{ ingressi_map.get(e.id_evento, 0) }} / {{ e.capienza_max }}
                  {% set saturazione = ((ingressi_map.get(e.id_evento, 0) / e.capienza_max * 100) if e.capienza_max > 0 else 0)|round(0) %}
                  <span style="color: {% if saturazione >= 80 %}var(--color-red-accent){% elif saturazione >= 50 %}var(--color-gold-dark){% else %}var(--color-green-accent){% endif %};">
                    ({{ saturazione }}%)
                  </span>
                </div>
                {% endif %}
              </div>
              <div style="display: flex; gap: var(--spacing-2); flex-wrap: wrap;">
                <a href="{{ url_for('eventi.admin_evento_detail', evento_id=e.id_evento) }}" class="btn btn--primary btn--small">
                  üìä Dashboard
                </a>
                <a href="{{ url_for('eventi.admin_edit', evento_id=e.id_evento) }}" class="btn btn--ghost btn--small">
                  ‚úèÔ∏è Modifica
                </a>
                <!-- Menu Stato Evento -->
                <div class="dropdown-container" style="position: relative; display: inline-block;">
                  <button type="button" class="btn btn--secondary btn--small dropdown-toggle" data-event-id="{{ e.id_evento }}" style="display: flex; align-items: center; gap: var(--spacing-1); cursor: pointer;">
                    ‚öôÔ∏è Cambia Stato
                    <span style="font-size: 0.7em; margin-left: 2px;">‚ñº</span>
                  </button>
                  <div class="dropdown-menu" id="dropdown-{{ e.id_evento }}" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 4px; background: #1a1a1a; border: 2px solid rgba(212, 175, 55, 0.6); border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.1), 0 0 20px rgba(212, 175, 55, 0.3); z-index: 10000; min-width: 240px; padding: 12px;">
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                      <form method="post" action="{{ url_for('eventi.admin_set_stato', evento_id=e.id_evento, stato='programmato') }}" style="margin: 0;">
                        <button type="submit" class="dropdown-item" style="width: 100%; justify-content: flex-start; padding: 12px 16px; text-align: left; border-radius: 6px; border: none; background: {% if e.stato_pubblico == 'programmato' %}rgba(212, 175, 55, 0.25); color: #d4af37; font-weight: 600; cursor: not-allowed;{% else %}transparent; color: #ffffff; cursor: pointer;{% endif %}; transition: all 0.2s;" {% if e.stato_pubblico == 'programmato' %}disabled{% endif %} onmouseover="if(!this.disabled) {this.style.background='rgba(255,255,255,0.15)';}" onmouseout="if(!this.disabled) {this.style.background='transparent';}">
                          üìã Programmato{% if e.stato_pubblico == 'programmato' %} <span style="opacity: 0.7;">(attuale)</span>{% endif %}
                        </button>
                      </form>
                      <form method="post" action="{{ url_for('eventi.admin_set_stato', evento_id=e.id_evento, stato='attivo') }}" style="margin: 0;">
                        <button type="submit" class="dropdown-item" style="width: 100%; justify-content: flex-start; padding: 12px 16px; text-align: left; border-radius: 6px; border: none; background: {% if e.stato_pubblico == 'attivo' %}rgba(59, 130, 246, 0.25); color: #60a5fa; font-weight: 600; cursor: not-allowed;{% else %}transparent; color: #ffffff; cursor: pointer;{% endif %}; transition: all 0.2s;" onclick="if(!this.disabled) return confirm('Attivare l\'evento? Staff e pubblico saranno attivati automaticamente.');" {% if e.stato_pubblico == 'attivo' %}disabled{% endif %} onmouseover="if(!this.disabled) {this.style.background='rgba(255,255,255,0.15)';}" onmouseout="if(!this.disabled) {this.style.background='transparent';}">
                          ‚úÖ Attivo{% if e.stato_pubblico == 'attivo' %} <span style="opacity: 0.7;">(attuale)</span>{% endif %}
                        </button>
                      </form>
                      <form method="post" action="{{ url_for('eventi.admin_set_stato', evento_id=e.id_evento, stato='chiuso') }}" style="margin: 0;">
                        <button type="submit" class="dropdown-item" style="width: 100%; justify-content: flex-start; padding: 12px 16px; text-align: left; border-radius: 6px; border: none; background: {% if e.stato_pubblico == 'chiuso' %}rgba(107, 114, 128, 0.25); color: #9ca3af; font-weight: 600; cursor: not-allowed;{% else %}transparent; color: #ffffff; cursor: pointer;{% endif %}; transition: all 0.2s;" onclick="if(!this.disabled) return confirm('Chiudere l\'evento? Staff e pubblico saranno disattivati automaticamente.');" {% if e.stato_pubblico == 'chiuso' %}disabled{% endif %} onmouseover="if(!this.disabled) {this.style.background='rgba(255,255,255,0.15)';}" onmouseout="if(!this.disabled) {this.style.background='transparent';}">
                          üîí Chiuso{% if e.stato_pubblico == 'chiuso' %} <span style="opacity: 0.7;">(attuale)</span>{% endif %}
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
    </div>
  </section>
  {% else %}
  <section class="card">
    <div class="admin-empty-state">
      <span class="admin-empty-state__icon">üìÖ</span>
      <p class="admin-empty-state__message">Nessun evento programmato.</p>
    </div>
  </section>
  {% endif %}
  {% endif %}

  <!-- Lista eventi passati -->
  {% if not periodo or periodo == 'passati' %}
  {% if eventi_passati %}
  <section class="card">
    <div class="card__header">
      <h2 class="card__title">üìö Eventi Passati ({{ eventi_passati|length }})</h2>
    </div>
    <div class="card__content">
      <div style="display: flex; flex-direction: column; gap: var(--spacing-4);">
        {% for e in eventi_passati %}
        <article class="card" style="border-left: 4px solid #6b7280; opacity: 0.85; margin-bottom: 0;">
          <div style="display: flex; gap: var(--spacing-4); flex-wrap: wrap;">
            {% if e.cover_url %}
            <div style="flex-shrink: 0;">
              <img src="{{ url_for('static', filename='uploads/eventi/' + e.cover_url) }}" 
                   alt="{{ e.nome_evento }}" 
                   style="width: 100px; height: 70px; object-fit: cover; border-radius: var(--radius-md); opacity: 0.7;">
            </div>
            {% endif %}
            <div style="flex: 1; min-width: 250px;">
              <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--spacing-3); flex-wrap: wrap; margin-bottom: var(--spacing-2);">
                <div style="flex: 1;">
                  <h3 style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); margin: 0 0 var(--spacing-2); color: var(--admin-text);">
                    {{ e.nome_evento }}
                  </h3>
                  <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-2); align-items: center;">
                    <span class="badge badge--secondary">üîí CHIUSO</span>
                    <span class="badge badge--secondary">{{ e.categoria|capitalize }}</span>
                  </div>
                </div>
              </div>
              <div class="text--muted" style="font-size: var(--font-size-xs); margin-bottom: var(--spacing-3);">
                <div>
                  <strong>Data:</strong> {{ e.data_evento.strftime('%d/%m/%Y') if e.data_evento else 'N/A' }}
                  {% if e.dj_artista %} ‚Ä¢ <strong>DJ:</strong> {{ e.dj_artista }}{% endif %}
                  {% if e.capienza_max %} ‚Ä¢ <strong>Ingressi:</strong> {{ ingressi_map.get(e.id_evento, 0) }} / {{ e.capienza_max }}{% endif %}
                </div>
              </div>
              <div style="display: flex; gap: var(--spacing-2); flex-wrap: wrap;">
                <a href="{{ url_for('eventi.admin_evento_detail', evento_id=e.id_evento) }}" class="btn btn--ghost btn--small">
                  üìä Dettagli
                </a>
                <a href="{{ url_for('eventi.admin_edit', evento_id=e.id_evento) }}" class="btn btn--ghost btn--small">
                  ‚úèÔ∏è Modifica
                </a>
              </div>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
    </div>
  </section>
  {% else %}
  <section class="card">
    <div class="admin-empty-state">
      <span class="admin-empty-state__icon">üìö</span>
      <p class="admin-empty-state__message">Nessun evento passato.</p>
    </div>
  </section>
  {% endif %}
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Gestione dropdown menu stato evento
  const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
  
  function positionDropdownMenu(toggle, menu) {
    const toggleRect = toggle.getBoundingClientRect();
    menu.style.position = 'fixed';
    menu.style.top = (toggleRect.bottom + 4) + 'px';
    menu.style.left = toggleRect.left + 'px';
    menu.style.zIndex = '99999';
  }
  
  function resetDropdownMenu(menu) {
    menu.style.position = 'absolute';
    menu.style.top = '';
    menu.style.left = '';
    menu.style.zIndex = '';
  }
  
  dropdownToggles.forEach(function(toggle) {
    toggle.addEventListener('click', function(e) {
      e.stopPropagation();
      e.preventDefault();
      
      const eventoId = this.getAttribute('data-event-id');
      const menu = document.getElementById('dropdown-' + eventoId);
      
      if (!menu) {
        console.error('Menu non trovato per evento:', eventoId);
        return;
      }
      
      // Chiudi tutti gli altri menu
      document.querySelectorAll('.dropdown-menu').forEach(function(m) {
        if (m.id !== 'dropdown-' + eventoId) {
          m.style.display = 'none';
          resetDropdownMenu(m);
        }
      });
      
      // Toggle del menu corrente
      if (menu.style.display === 'none' || menu.style.display === '') {
        positionDropdownMenu(toggle, menu);
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
        resetDropdownMenu(menu);
      }
    });
  });
  
  // Chiudi i menu quando si clicca fuori
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown-container')) {
      document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
        menu.style.display = 'none';
        resetDropdownMenu(menu);
      });
    }
  });
  
  // Chiudi i menu quando si scrolla o si ridimensiona la finestra
  window.addEventListener('scroll', function() {
    document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
      if (menu.style.display === 'block') {
        const toggle = document.querySelector('[data-event-id="' + menu.id.replace('dropdown-', '') + '"]');
        if (toggle) {
          positionDropdownMenu(toggle, menu);
        }
      }
    });
  }, true);
  
  window.addEventListener('resize', function() {
    document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
      if (menu.style.display === 'block') {
        const toggle = document.querySelector('[data-event-id="' + menu.id.replace('dropdown-', '') + '"]');
        if (toggle) {
          positionDropdownMenu(toggle, menu);
        }
      }
    });
  });
});
</script>
{% endblock %}
