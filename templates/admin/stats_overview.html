{% extends "admin/base.html" %}
{% block admin_title %}Overview Statistiche{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}
{% from "admin/_secondary_nav.html" import render_secondary_nav %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_secondary_nav([
    {'url': url_for('stats.admin_hub'), 'endpoint': 'stats.admin_hub', 'label': 'Hub Statistiche', 'icon': 'üìà'},
    {'url': url_for('stats.admin_overview'), 'endpoint': 'stats.admin_overview', 'label': 'Overview', 'icon': 'üìä'},
    {'url': url_for('stats.admin_ingressi'), 'endpoint': 'stats.admin_ingressi', 'label': 'Ingressi', 'icon': 'üö™'},
    {'url': url_for('stats.admin_prenotazioni'), 'endpoint': 'stats.admin_prenotazioni', 'label': 'Prenotazioni', 'icon': 'üìã'},
    {'url': url_for('stats.admin_consumi'), 'endpoint': 'stats.admin_consumi', 'label': 'Consumi', 'icon': 'üí∞'},
  ], current_endpoint=request.endpoint) }}
  
  {{ render_page_header(
    title="Overview Statistiche",
    subtitle="Dashboard completa con le metriche pi√π importanti ¬∑ Filtra per evento e periodo",
    actions=None,
    breadcrumbs=[
      {'label': 'Statistiche', 'url': url_for('stats.admin_hub')},
      {'label': 'Overview'}
    ]
  ) }}

  <!-- Filtri -->
  <section class="card" style="margin-bottom: var(--spacing-5);">
    <form method="get" class="form__actions" style="border-top: none; padding-top: 0; margin-top: 0;">
      <div class="form__group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
        <label class="form__label">Evento</label>
        <select class="form__select" name="evento_id" onchange="this.form.submit()">
          <option value="">Tutti gli eventi</option>
          {% for e in eventi %}
          <option value="{{ e.id_evento }}" {% if evento_selezionato_id == e.id_evento %}selected{% endif %}>
            {{ e.nome_evento }} - {{ e.data_evento.strftime('%d/%m/%Y') if e.data_evento else 'N/A' }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="form__group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
        <label class="form__label">Periodo</label>
        <select class="form__select" name="giorni" onchange="this.form.submit()">
          <option value="7" {% if giorni == 7 %}selected{% endif %}>Ultimi 7 giorni</option>
          <option value="30" {% if giorni == 30 %}selected{% endif %}>Ultimi 30 giorni</option>
          <option value="90" {% if giorni == 90 %}selected{% endif %}>Ultimi 90 giorni</option>
        </select>
      </div>
      {% if evento_selezionato_id %}
      <div class="form__group" style="margin-bottom: 0;">
        <a href="{{ url_for('stats.admin_overview') }}" class="btn btn--ghost">Reset</a>
      </div>
      {% endif %}
    </form>
  </section>

  <!-- KPI Cards -->
  <div class="grid grid--auto" style="margin-bottom: var(--spacing-6);">
    <div class="stat-card" style="border-left: 4px solid var(--color-green-accent); text-align: center; background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(12, 12, 12, 0.9) 100%);">
      <div class="stat-card__value" style="color: var(--color-green-accent); font-size: var(--font-size-4xl); font-weight: var(--font-weight-bold);">‚Ç¨{{ "%.0f"|format(consumi_stats.revenue_totale) }}</div>
      <div class="stat-card__label" style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">Revenue Totale</div>
      <div class="stat-card__meta">Scontrino medio: ‚Ç¨{{ "%.2f"|format(consumi_stats.scontrino_medio) }}</div>
    </div>

    <div class="stat-card" style="border-left: 4px solid #3b82f6; text-align: center;">
      <div class="stat-card__value" style="color: #3b82f6; font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold);">{{ ingressi_stats.totale }}</div>
      <div class="stat-card__label" style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">Ingressi</div>
    </div>

    <div class="stat-card" style="border-left: 4px solid var(--admin-accent); text-align: center;">
      <div class="stat-card__value" style="color: var(--admin-accent); font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold);">{{ prenotazioni_stats.totale }}</div>
      <div class="stat-card__label" style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">Prenotazioni</div>
      {% if prenotazioni_stats.tavoli_in_attesa > 0 %}
      <div class="stat-card__meta" style="color: #ef4444; font-weight: var(--font-weight-semibold);">{{ prenotazioni_stats.tavoli_in_attesa }} tavoli in attesa</div>
      {% endif %}
    </div>
  </div>

  <!-- Grafici Principali -->
  <div class="grid grid--2" style="margin-bottom: var(--spacing-6);">
    <!-- Trend Revenue -->
    <section class="card chart-card">
      <div class="card__header">
        <h2 class="card__title">üí∞ Trend Revenue</h2>
        <p class="card__meta" style="margin: 0;">Andamento vendite giornaliero</p>
      </div>
      <div class="card__content">
        <canvas id="chartRevenue"></canvas>
      </div>
    </section>

    <!-- Trend Ingressi -->
    <section class="card chart-card">
      <div class="card__header">
        <h2 class="card__title">üö™ Trend Ingressi</h2>
        <p class="card__meta" style="margin: 0;">Andamento accessi giornaliero</p>
      </div>
      <div class="card__content">
        <canvas id="chartIngressi"></canvas>
      </div>
    </section>
  </div>

  <!-- Top Prodotti -->
  {% if consumi_stats.top_prodotti %}
  <section class="card">
    <div class="card__header">
      <h2 class="card__title">üèÜ Top 10 Prodotti per Revenue</h2>
      <p class="card__meta" style="margin: 0;">I prodotti pi√π venduti</p>
    </div>
    <div class="card__content">
      <div class="table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th class="admin-table__header">#</th>
              <th class="admin-table__header">Prodotto</th>
              <th class="admin-table__header">Categoria</th>
              <th class="admin-table__header">Quantit√†</th>
              <th class="admin-table__header admin-table__header--actions">Revenue</th>
            </tr>
          </thead>
          <tbody>
            {% for prodotto in consumi_stats.top_prodotti[:10] %}
            <tr class="admin-table__row">
              <td class="admin-table__cell" style="color: var(--admin-accent); font-weight: var(--font-weight-semibold);">{{ loop.index }}</td>
              <td class="admin-table__cell" style="font-weight: var(--font-weight-medium);">{{ prodotto.nome }}</td>
              <td class="admin-table__cell">{{ prodotto.categoria }}</td>
              <td class="admin-table__cell">{{ prodotto.quantita }}</td>
              <td class="admin-table__cell admin-table__cell--actions" style="color: var(--color-green-accent); font-weight: var(--font-weight-semibold);">‚Ç¨{{ "%.2f"|format(prodotto.revenue) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>
  {% endif %}
</div>

<script>
// Chart Revenue
const ctxRevenue = document.getElementById('chartRevenue');
if (ctxRevenue) {
  new Chart(ctxRevenue, {
    type: 'line',
    data: {
      labels: {{ consumi_stats.trend_revenue | map(attribute='data') | list | tojson }},
      datasets: [{
        label: 'Revenue (‚Ç¨)',
        data: {{ consumi_stats.trend_revenue | map(attribute='revenue') | list | tojson }},
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.15)',
        tension: 0.4,
        fill: true,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '‚Ç¨' + value.toFixed(0);
            }
          }
        }
      }
    }
  });
}

// Chart Ingressi
const ctxIngressi = document.getElementById('chartIngressi');
if (ctxIngressi) {
  new Chart(ctxIngressi, {
    type: 'line',
    data: {
      labels: {{ ingressi_stats.trend_giornaliero | map(attribute='data') | list | tojson }},
      datasets: [{
        label: 'Ingressi',
        data: {{ ingressi_stats.trend_giornaliero | map(attribute='count') | list | tojson }},
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.15)',
        tension: 0.4,
        fill: true,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 }
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}
</script>
{% endblock %}
