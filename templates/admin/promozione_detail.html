{% extends "admin/base.html" %}
{% block admin_title %}{{ promozione.nome }}{% endblock %}

{% block admin_content %}
<div class="evento-detail">
  <!-- Header con info principali -->
  <section class="card">
    <div class="cliente-header">
      <div class="cliente-header__main">
        <h1 class="card__title">{{ promozione.nome }}</h1>
        <div class="cliente-header__meta">
          <span class="badge badge--{{ 'success' if promozione.attiva else 'secondary' }}">
            {{ 'Attiva' if promozione.attiva else 'Disattiva' }}
          </span>
          <span class="badge badge--warning">{{ promozione.tipo|replace('_', ' ')|title }}</span>
          {% if promozione.auto_assegnazione %}
          <span class="badge">Auto-assegnazione</span>
          {% endif %}
        </div>
      </div>
      <div class="cliente-header__actions">
        <a href="{{ url_for('promozioni.admin_list') }}" class="btn btn--secondary">← Torna alla lista</a>
      </div>
    </div>
  </section>

  <!-- Statistiche rapide -->
  <div class="dashboard__stats">
    <div class="stat-card">
      <div class="stat-card__value">{{ tot_assegnate }}</div>
      <div class="stat-card__label">Totale Assegnate</div>
    </div>
    <div class="stat-card">
      <div class="stat-card__value">{{ tot_usate }}</div>
      <div class="stat-card__label">Usate</div>
    </div>
    <div class="stat-card">
      <div class="stat-card__value">{{ tot_attive }}</div>
      <div class="stat-card__label">Attive</div>
    </div>
  </div>

  <!-- Informazioni promozione e CRUD -->
  <div class="grid grid--2">
    <section class="card">
      <h2 class="card__title">Informazioni Promozione</h2>
      <div class="info-list">
        {% if promozione.descrizione %}
        <div class="info-item" style="flex-direction: column; align-items: flex-start;">
          <span class="info-label">Descrizione:</span>
          <span class="info-value" style="margin-top: 0.5rem;">{{ promozione.descrizione }}</span>
        </div>
        {% endif %}
        <div class="info-item">
          <span class="info-label">Tipo:</span>
          <span class="info-value">{{ promozione.tipo|replace('_', ' ')|title }}</span>
        </div>
        {% if promozione.valore %}
        <div class="info-item">
          <span class="info-label">Valore:</span>
          <span class="info-value">
            {% if promozione.tipo == 'sconto_percentuale' %}
              {{ promozione.valore }}%
            {% else %}
              €{{ "%.2f"|format(promozione.valore) }}
            {% endif %}
          </span>
        </div>
        {% endif %}
        {% if promozione.condizioni %}
        <div class="info-item" style="flex-direction: column; align-items: flex-start;">
          <span class="info-label">Condizioni:</span>
          <span class="info-value" style="margin-top: 0.5rem;">{{ promozione.condizioni }}</span>
        </div>
        {% endif %}
        {% if promozione.data_inizio or promozione.data_fine %}
        <div class="info-item">
          <span class="info-label">Periodo:</span>
          <span class="info-value">
            {{ promozione.data_inizio.strftime('%d/%m/%Y') if promozione.data_inizio else '—' }} - 
            {{ promozione.data_fine.strftime('%d/%m/%Y') if promozione.data_fine else '—' }}
          </span>
        </div>
        {% endif %}
        {% if promozione.livello_richiesto %}
        <div class="info-item">
          <span class="info-label">Livello richiesto:</span>
          <span class="info-value">{{ promozione.livello_richiesto|upper }}</span>
        </div>
        {% endif %}
        {% if promozione.punti_richiesti %}
        <div class="info-item">
          <span class="info-label">Punti richiesti:</span>
          <span class="info-value">{{ promozione.punti_richiesti }}</span>
        </div>
        {% endif %}
      </div>
    </section>

    <!-- Gestione Promozione -->
    <section class="card">
      <h2 class="card__title">Gestione Promozione</h2>
      
      <div class="form__actions" style="margin-bottom: 1.5rem;">
        <a href="{{ url_for('promozioni.admin_edit', promozione_id=promozione.id_promozione) }}" class="btn btn--primary">Modifica Promozione</a>
      </div>

      <div class="form__actions" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(212, 175, 55, 0.1);">
        <form method="post" action="{{ url_for('promozioni.admin_delete', promozione_id=promozione.id_promozione) }}" style="display:inline" onsubmit="return confirm('Eliminare definitivamente questa promozione? Questa azione non può essere annullata.');">
          <button class="btn btn--danger">Elimina Promozione</button>
        </form>
      </div>
    </section>
  </div>

  <!-- Ultime assegnazioni -->
  <section class="card">
    <h2 class="card__title">Ultime Assegnazioni</h2>
    {% if ultime_assegnazioni %}
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Data Assegnazione</th>
            <th>Scadenza</th>
            <th>Stato</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody>
          {% for cp, cli in ultime_assegnazioni %}
          <tr>
            <td>
              <a href="{{ url_for('clienti.admin_cliente_detail', cliente_id=cli.id_cliente) }}" style="text-decoration: none; color: var(--gold-primary);">
                {{ cli.nome }} {{ cli.cognome }}
              </a>
            </td>
            <td>{{ cp.data_assegnazione.strftime('%d/%m/%Y %H:%M') if cp.data_assegnazione else '—' }}</td>
            <td>{{ cp.data_scadenza.strftime('%d/%m/%Y') if cp.data_scadenza else '—' }}</td>
            <td>
              {% if cp.usata %}
                <span class="badge badge--secondary">Usata</span>
              {% elif cp.data_scadenza and cp.data_scadenza < oggi %}
                <span class="badge badge--secondary">Scaduta</span>
              {% else %}
                <span class="badge badge--success">Attiva</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('clienti.admin_cliente_detail', cliente_id=cli.id_cliente) }}" class="btn btn--ghost btn--small">Vedi Cliente</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text--muted">Nessuna assegnazione registrata.</p>
    {% endif %}
  </section>
</div>
{% endblock %}

