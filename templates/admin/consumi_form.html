{% extends "admin/base.html" %}
{% block admin_title %}{{ 'Modifica' if e else 'Nuovo' }} Consumo{% endblock %}

{% block content %}
<section class="card">
  <h1 class="card__title">{{ 'Modifica' if e else 'Nuovo' }} consumo</h1>
  <form class="form" method="post">
    {% if not e %}
    <div class="grid grid--2">
      <div class="form__group">
        <label class="form__label">Cliente</label>
        <select class="form__input" name="cliente_id" required>
          {% for c in clienti %}
          <option value="{{ c.id_cliente }}">{{ c.cognome }} {{ c.nome }} — {{ c.telefono }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form__group">
        <label class="form__label">Evento</label>
        <select class="form__input" name="evento_id" required>
          {% for ev in eventi %}
          <option value="{{ ev.id_evento }}">{{ ev.data_evento }} — {{ ev.nome_evento }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    {% endif %}

    {% if prodotti and prodotti|length %}
    <div class="form__group">
      <label class="form__label">Prodotto da catalogo</label>
      <select class="form__input" name="prodotto_id" id="admin_prodotto_id">
        <option value="">—</option>
        {% for p in prodotti %}
        <option value="{{ p.id_prodotto }}" data-prezzo="{{ p.prezzo }}">{{ p.nome }} — € {{ '%.2f'|format(p.prezzo) }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <div class="grid grid--2">
      <div class="form__group">
        <label class="form__label">Prodotto (testo libero)</label>
        <input class="form__input" type="text" name="prodotto" value="{{ e.prodotto if e else '' }}">
      </div>
      <div class="form__group">
        <label class="form__label">Importo (€)</label>
        <input class="form__input" type="number" step="0.01" name="importo" id="admin_importo" value="{{ e.importo if e else '' }}">
      </div>
    </div>

    <div class="grid grid--2">
      <div class="form__group">
        <label class="form__label">Sconto (%)</label>
        <input class="form__input" type="number" step="1" name="sconto_pct" placeholder="0">
      </div>
      <div class="form__group">
        <label class="form__label">Punto vendita</label>
        <select class="form__input" name="punto_vendita" required>
          <option value="bar" {% if e and e.punto_vendita=='bar' %}selected{% endif %}>Bar</option>
          <option value="tavolo" {% if e and e.punto_vendita=='tavolo' %}selected{% endif %}>Tavolo</option>
          <option value="privè" {% if e and e.punto_vendita=='privè' %}selected{% endif %}>Privè</option>
        </select>
      </div>
    </div>

    <div class="form__group">
      <label class="form__label">Note</label>
      <input class="form__input" type="text" name="note" value="{{ e.note if e else '' }}" placeholder="Es. Tavolo 7 – VIP">
    </div>

    <div class="form__group">
      <label class="form__label">Staff</label>
      <select class="form__input" name="staff_id">
        <option value="">—</option>
        {% for s in staff_list %}
        <option value="{{ s.id_staff }}" {% if e and e.staff_id==s.id_staff %}selected{% endif %}>{{ s.nome }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form__actions">
      <button class="btn btn--primary">{{ 'Salva' if e else 'Crea' }}</button>
      <a class="btn btn--ghost" href="{{ url_for('consumi.admin_list') }}">Annulla</a>
    </div>
  </form>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function(){
  const select = document.getElementById('admin_prodotto_id');
  if (select){
    select.addEventListener('change', function(){
      const prezzo = this.options[this.selectedIndex].getAttribute('data-prezzo');
      if (prezzo){
        document.getElementById('admin_importo').value = prezzo;
      }
    });
  }
});
</script>
{% endblock %}