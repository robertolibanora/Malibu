{% extends "admin/base.html" %}
{% block admin_title %}Fedeltà Clienti{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}
{% from "admin/_secondary_nav.html" import render_secondary_nav %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_secondary_nav([
    {'url': url_for('clienti.admin_lista_clienti'), 'endpoint': 'clienti.admin_lista_clienti', 'label': 'Anagrafica', 'icon': None},
    {'url': url_for('fedelta.admin_list'), 'endpoint': 'fedelta.admin_list', 'label': 'Punti Fedeltà', 'icon': None},
  ], current_endpoint=request.endpoint) }}

  {{ render_page_header(
    title="Programma Fedeltà",
    subtitle="Monitora punti e le attività più recenti dei clienti fidelizzati",
    actions=[
      {'type': 'link', 'url': url_for('fedelta.admin_azzera_punti_form'), 'label': 'Azzera Punti', 'class': 'btn--danger'}
    ],
    breadcrumbs=[
      {'label': 'Clienti', 'url': url_for('clienti.admin_lista_clienti')},
      {'label': 'Punti Fedeltà'}
    ]
  ) }}

  <!-- Statistiche -->
  <div class="grid grid--auto">
    <div class="profile-metric">
      <span class="profile-metric__label">Clienti nel programma</span>
      <span class="profile-metric__value">{{ stats.totale_clienti }}</span>
      <span class="profile-metric__meta">Clienti con profilo fedeltà attivo</span>
    </div>
    <div class="profile-metric">
      <span class="profile-metric__label">Punti complessivi</span>
      <span class="profile-metric__value">{{ stats.punti_totali }}</span>
      <span class="profile-metric__meta">Somma dei punti attualmente assegnati</span>
    </div>
    <div class="profile-metric">
      <span class="profile-metric__label">Media punti per cliente</span>
      <span class="profile-metric__value">{{ stats.punti_medi }}</span>
      <span class="profile-metric__meta">Valore medio arrotondato</span>
    </div>
  </div>

  <!-- Top Clienti -->
  <div class="grid grid--auto">
    <!-- Top Clienti -->
    <section class="card" style="grid-column: span 2;">
      <div class="card__header">
        <div>
          <h2 class="card__title">Top clienti per punti</h2>
          <p class="card__meta">Prime {{ top_clienti|length }} posizioni</p>
        </div>
      </div>
      <div class="card__content">
        {% if top_clienti %}
        <div class="table-responsive">
          <table class="admin-table">
            <thead>
              <tr>
                <th class="admin-table__header">#</th>
                <th class="admin-table__header">Cliente</th>
                <th class="admin-table__header">Contatto</th>
                <th class="admin-table__header" style="text-align: right;">Punti</th>
                <th class="admin-table__header">Livello</th>
                <th class="admin-table__header">Prossimo livello</th>
              </tr>
            </thead>
            <tbody>
              {% for item in top_clienti %}
              <tr class="admin-table__row">
                <td class="admin-table__cell">{{ loop.index }}</td>
                <td class="admin-table__cell">
                  <strong>{{ item.cliente.cognome }} {{ item.cliente.nome }}</strong>
                </td>
                <td class="admin-table__cell">
                  {% if item.cliente.telefono %}
                    <a href="tel:{{ item.cliente.telefono }}">{{ item.cliente.telefono }}</a>
                  {% else %}
                    <span class="text--muted">n/d</span>
                  {% endif %}
                </td>
                <td class="admin-table__cell" style="text-align: right; font-weight: var(--font-weight-semibold);">{{ item.points }}</td>
                <td class="admin-table__cell">
                  <span class="badge badge--level badge--level-{{ item.level|lower }}">{{ item.level|capitalize }}</span>
                </td>
                <td class="admin-table__cell">
                  {% if item.next_level %}
                    {{ item.next_level|capitalize }} tra {{ item.points_to_next }} pt
                  {% else %}
                    <span class="text--muted">Livello massimo</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
          <span class="admin-empty-state__icon"></span>
          <p class="admin-empty-state__message">Non ci sono ancora clienti con punti da mostrare.</p>
        </div>
        {% endif %}
      </div>
    </section>

    <!-- Distribuzione livelli -->
    <section class="card">
      <div class="card__header">
        <div>
          <h2 class="card__title">Distribuzione livelli</h2>
          <p class="card__meta">Aggiornata automaticamente</p>
        </div>
      </div>
      <div class="card__content">
        {% if distribuzione %}
        <ul class="info-list">
          {% for lvl, count in distribuzione %}
          <li class="info-item">
            <span class="info-label">{{ lvl|capitalize }}</span>
            <span class="info-value">{{ count }} clienti</span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <div class="admin-empty-state">
          <span class="admin-empty-state__icon"></span>
          <p class="admin-empty-state__message">Nessun dato disponibile per i livelli.</p>
        </div>
        {% endif %}
      </div>
    </section>
  </div>
</div>
{% endblock %}
