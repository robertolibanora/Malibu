{% extends "admin/base.html" %}
{% block admin_title %}Fedelt√† Clienti{% endblock %}

{% block admin_content %}
<!-- Navigazione Secondaria Clienti -->
<div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.08);">
  <a href="{{ url_for('clienti.admin_lista_clienti') }}" class="btn btn--ghost btn--small">üë• Anagrafica</a>
  <a href="{{ url_for('fedelta.admin_list') }}" class="btn btn--primary btn--small">‚≠ê Punti Fedelt√†</a>
  <a href="{{ url_for('fedelta.admin_movimenti') }}" class="btn btn--ghost btn--small">üìä Movimenti</a>
  <a href="{{ url_for('fedelta.admin_analytics') }}" class="btn btn--ghost btn--small">üìà Analytics</a>
  <a href="{{ url_for('feedback.admin_list') }}" class="btn btn--ghost btn--small">üí¨ Feedback</a>
</div>

<div class="loyalty-hub">
  <header class="loyalty-hub__header fade-in">
    <div class="loyalty-hub__intro">
      <h1 class="loyalty-hub__title">Programma Fedelt√†</h1>
      <p class="loyalty-hub__subtitle">Monitora punti, soglie di livello e le attivit√† pi√π recenti dei clienti fidelizzati.</p>
    </div>
    <div class="loyalty-hub__actions">
      <a class="btn btn--ghost btn--small" href="{{ url_for('fedelta.admin_movimenti') }}">Movimenti completi</a>
      <a class="btn btn--ghost btn--small" href="{{ url_for('fedelta.admin_analytics') }}">Analytics fedelt√†</a>
      <a class="btn btn--primary" href="{{ url_for('fedelta.admin_movimenti') }}">Gestisci movimenti</a>
    </div>
  </header>

  <section class="loyalty-hub__stats fade-in" style="animation-delay: 80ms;">
    <article class="profile-metric">
      <span class="profile-metric__label">Clienti nel programma</span>
      <span class="profile-metric__value">{{ stats.totale_clienti }}</span>
      <span class="profile-metric__meta">Clienti con profilo fedelt√† attivo</span>
  </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Punti complessivi</span>
      <span class="profile-metric__value">{{ stats.punti_totali }}</span>
      <span class="profile-metric__meta">Somma dei punti attualmente assegnati</span>
  </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Media punti per cliente</span>
      <span class="profile-metric__value">{{ stats.punti_medi }}</span>
      <span class="profile-metric__meta">Valore medio arrotondato</span>
  </article>
</section>

  <section class="loyalty-grid fade-in" style="animation-delay: 140ms;">
    <article class="loyalty-card loyalty-card--wide">
      <div class="loyalty-card__header">
        <h2 class="loyalty-card__title">Top clienti per punti</h2>
        <span class="loyalty-card__meta">Prime {{ top_clienti|length }} posizioni</span>
  </div>
      {% if top_clienti %}
      <div class="table-responsive loyalty-table">
        <table class="table table--compact">
      <thead>
        <tr>
          <th>#</th>
          <th>Cliente</th>
          <th>Contatto</th>
          <th>Punti</th>
          <th>Livello</th>
          <th>Prossimo livello</th>
        </tr>
      </thead>
      <tbody>
        {% for item in top_clienti %}
        <tr>
          <td>{{ loop.index }}</td>
              <td>
                <strong>{{ item.cliente.cognome }} {{ item.cliente.nome }}</strong>
              </td>
          <td>
            {% if item.cliente.telefono %}
              <a href="tel:{{ item.cliente.telefono }}">{{ item.cliente.telefono }}</a>
            {% else %}
              <span class="text--muted">n/d</span>
            {% endif %}
          </td>
          <td><strong>{{ item.points }}</strong></td>
          <td>{{ item.level|capitalize }}</td>
          <td>
            {% if item.next_level %}
              {{ item.next_level|capitalize }} tra {{ item.points_to_next }} pt
            {% else %}
              <span class="text--muted">Livello massimo</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
      {% else %}
      <div class="empty-state">Non ci sono ancora clienti con punti da mostrare.</div>
      {% endif %}
    </article>

    <article class="loyalty-card">
      <div class="loyalty-card__header">
        <h2 class="loyalty-card__title">Soglie di livello</h2>
      {% if not can_edit_thresholds %}
      <span class="badge badge--warning">Sola lettura</span>
      {% endif %}
    </div>
    {% if can_edit_thresholds %}
      <form class="profile-form" method="post">
        <div class="loyalty-thresholds">
          <label>
            <span>Base</span>
            <input class="form__input" type="number" min="0" value="{{ thresholds.base }}" readonly>
          </label>
          <label>
            <span>Loyal</span>
          <input class="form__input" type="number" name="loyal" min="0" value="{{ thresholds.loyal }}" required>
          </label>
          <label>
            <span>Premium</span>
          <input class="form__input" type="number" name="premium" min="0" value="{{ thresholds.premium }}" required>
          </label>
          <label>
            <span>VIP</span>
            <input class="form__input" type="number" name="vip" min="0" value="{{ thresholds.vip }}" required>
          </label>
        </div>
        <div class="profile-form__actions">
          <button class="btn btn--primary btn--small" type="submit">Aggiorna soglie</button>
          <a class="btn btn--ghost btn--small" href="{{ url_for('fedelta.admin_list') }}">Annulla</a>
      </div>
    </form>
    {% else %}
      <ul class="loyalty-list">
      {% for lvl, pts in thresholds_sorted %}
      <li><strong>{{ lvl|capitalize }}</strong>: {{ pts }} pt</li>
      {% endfor %}
    </ul>
      <small class="profile-form__hint">Attiva la tabella <code>soglie_fedelta</code> per rendere le soglie modificabili.</small>
    {% endif %}
  </article>

    <article class="loyalty-card">
      <div class="loyalty-card__header">
        <h2 class="loyalty-card__title">Distribuzione livelli</h2>
        <span class="loyalty-card__meta">Aggiornata automaticamente</span>
    </div>
      {% if distribuzione %}
      <ul class="loyalty-list">
      {% for lvl, count in distribuzione %}
      <li><strong>{{ lvl|capitalize }}</strong>: {{ count }} clienti</li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="empty-state">Nessun dato disponibile per i livelli.</div>
      {% endif %}
    </article>
  </section>

  <section class="loyalty-card loyalty-card--timeline fade-in" style="animation-delay: 200ms;">
    <div class="loyalty-card__header">
      <h2 class="loyalty-card__title">Ultimi movimenti registrati</h2>
      <a class="btn btn--ghost btn--small" href="{{ url_for('fedelta.admin_movimenti') }}">Vai all‚Äôelenco ‚Üí</a>
    </div>
    {% if recent_movimenti %}
    <ul class="timeline-list">
      {% for mov in recent_movimenti %}
      {% set movimento = mov.movimento %}
      {% set cliente = mov.cliente %}
      {% set evento = mov.evento %}
      <li class="timeline-item">
        <div class="timeline-item__header">
          <strong>{{ cliente.cognome }} {{ cliente.nome }}</strong>
          <span class="badge">{{ movimento.punti }} pt</span>
        </div>
        <div class="timeline-item__meta">
          {{ movimento.data_assegnazione.strftime('%d/%m/%Y %H:%M') if movimento.data_assegnazione else 'Data n/d' }}
          {% if evento %}‚Ä¢ {{ evento.nome_evento }}{% endif %}
        </div>
        {% if movimento.motivo %}
        <p class="timeline-item__note">{{ movimento.motivo }}</p>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <div class="empty-state">Ancora nessun movimento registrato di recente.</div>
    {% endif %}
  </section>
  </div>
{% endblock %}