{% extends "admin/base.html" %}
{% block admin_title %}Staff{% endblock %}

{% block admin_content %}
{% set totale_staff = staff_list|length %}
{% set staff_attivi = staff_list|selectattr('attivo')|list|length %}
{% set staff_disattivi = totale_staff - staff_attivi %}
{% set role_counts = {} %}
{% for member in staff_list %}
  {% if member.ruolo in role_counts %}
    {% set _ = role_counts.update({member.ruolo: role_counts[member.ruolo] + 1}) %}
  {% else %}
    {% set _ = role_counts.update({member.ruolo: 1}) %}
  {% endif %}
{% endfor %}

<div class="staff-hub">
  <header class="staff-hub__header fade-in">
    <div class="staff-hub__intro">
      <h1 class="staff-hub__title">Team Operativo</h1>
      <p class="staff-hub__subtitle">Gestisci ruoli, abilitazioni e accessi del personale interno.</p>
  </div>
    <div class="staff-hub__actions">
      <form class="staff-hub__filters" method="get">
        <label class="staff-filter">
          <span>Ruolo</span>
          <select class="form__select form__select--dense" name="ruolo" onchange="this.form.submit()">
            <option value="" {% if not filtro.ruolo %}selected{% endif %}>Tutti</option>
          <option value="admin" {% if filtro.ruolo=='admin' %}selected{% endif %}>Admin</option>
          <option value="staff" {% if filtro.ruolo=='staff' %}selected{% endif %}>Staff</option>
          <option value="barista" {% if filtro.ruolo=='barista' %}selected{% endif %}>Barista</option>
          <option value="cassa" {% if filtro.ruolo=='cassa' %}selected{% endif %}>Cassa</option>
        </select>
        </label>
        <label class="staff-filter">
          <span>Stato</span>
          <select class="form__select form__select--dense" name="attivo" onchange="this.form.submit()">
            <option value="" {% if not filtro.attivo %}selected{% endif %}>Tutti</option>
          <option value="true" {% if filtro.attivo=='true' %}selected{% endif %}>Attivi</option>
          <option value="false" {% if filtro.attivo=='false' %}selected{% endif %}>Disattivi</option>
        </select>
        </label>
        {% if filtro.ruolo or filtro.attivo %}
        <a class="btn btn--ghost btn--small" href="{{ url_for('staff_admin.admin_list') }}">Reset</a>
        {% endif %}
      </form>
      <a href="{{ url_for('staff_admin.admin_new') }}" class="btn btn--primary btn--large">+ Nuovo membro staff</a>
    </div>
  </header>

  <section class="staff-hub__stats fade-in" style="animation-delay: 120ms;">
    <article class="profile-metric">
      <span class="profile-metric__label">Totale membri</span>
      <span class="profile-metric__value">{{ totale_staff }}</span>
    </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Attivi</span>
      <span class="profile-metric__value">{{ staff_attivi }}</span>
      <span class="profile-metric__meta">Disponibili in turno</span>
    </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Disattivi</span>
      <span class="profile-metric__value">{{ staff_disattivi }}</span>
      <span class="profile-metric__meta">In pausa o fuori organico</span>
    </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Ruoli coperti</span>
      <span class="profile-metric__value">{{ role_counts|length }}</span>
      <span class="profile-metric__meta">Admin, Staff, Barista, Cassa…</span>
    </article>
</section>

  <section class="staff-grid fade-in" style="animation-delay: 180ms;">
    {% if staff_list %}
  {% for s in staff_list %}
      <article class="staff-card">
        <header class="staff-card__header">
      <div>
            <h2 class="staff-card__name">{{ s.nome }}</h2>
            <div class="staff-card__tags">
              <span class="badge badge--{{ 'success' if s.attivo else 'secondary' }}">{{ s.ruolo|capitalize }}</span>
              {% if not s.attivo %}<span class="badge badge--secondary">Disattivo</span>{% endif %}
      </div>
    </div>
          <div class="staff-card__status {{ 'staff-card__status--active' if s.attivo else 'staff-card__status--inactive' }}">
            {{ 'Disponibile' if s.attivo else 'Non attivo' }}
          </div>
        </header>

        <dl class="staff-card__meta">
          <div>
            <dt>Username</dt>
            <dd>{{ s.username }}</dd>
          </div>
          <div>
            <dt>Ruolo</dt>
            <dd>{{ s.ruolo|capitalize }}</dd>
          </div>
        </dl>

        <footer class="staff-card__footer">
          <div class="staff-card__actions">
            <a href="{{ url_for('staff_admin.admin_edit', staff_id=s.id_staff) }}" class="btn btn--primary btn--small">Modifica</a>
            <form method="post" action="{{ url_for('staff_admin.admin_delete', staff_id=s.id_staff) }}" onsubmit="return confirm('Eliminare definitivamente questo membro dello staff? L’operazione non è reversibile.');">
              <button class="btn btn--danger btn--small" type="submit">Elimina</button>
            </form>
    </div>
          <small class="staff-card__hint">Aggiorna ruolo e credenziali prima di ogni evento operativo.</small>
        </footer>
  </article>
      {% endfor %}
  {% else %}
      <div class="empty-state">Nessun membro dello staff trovato con i filtri selezionati.</div>
    {% endif %}
</section>
</div>
{% endblock %}

