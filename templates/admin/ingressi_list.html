{% extends "admin/base.html" %}
{% block admin_title %}Ingressi{% endblock %}

{% block admin_content %}
<!-- Navigazione Secondaria Operativo -->
<div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.08);">
  <a href="{{ url_for('prenotazioni.admin_hub') }}" class="btn btn--ghost btn--small">ğŸ  Hub Operativo</a>
  <a href="{{ url_for('prenotazioni.admin_list') }}" class="btn btn--ghost btn--small">ğŸ“‹ Prenotazioni</a>
  <a href="{{ url_for('ingressi.admin_list') }}" class="btn btn--primary btn--small">ğŸšª Ingressi</a>
  <a href="{{ url_for('consumi.admin_list') }}" class="btn btn--ghost btn--small">ğŸ’° Consumi</a>
  <a href="{{ url_for('feedback.admin_list') }}" class="btn btn--ghost btn--small">ğŸ’¬ Feedback</a>
</div>

<section class="card">
  <h1 class="card__title">Ingressi</h1>
  <form class="form" method="get">
    <div class="grid grid--2">
      <div class="form__group">
        <label class="form__label">Evento</label>
        <select class="form__input" name="evento_id">
          <option value="">Tutti</option>
          {% for ev in eventi %}
          <option value="{{ ev.id_evento }}" {% if filtro.evento_id==ev.id_evento %}selected{% endif %}>
            {{ ev.data_evento }} â€” {{ ev.nome_evento }}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="form__group">
        <label class="form__label">Tipo</label>
        <select class="form__input" name="tipo_ingresso">
          <option value="">Tutti</option>
          <option value="lista" {% if filtro.tipo=='lista' %}selected{% endif %}>Lista</option>
          <option value="tavolo" {% if filtro.tipo=='tavolo' %}selected{% endif %}>Tavolo</option>
          <option value="omaggio" {% if filtro.tipo=='omaggio' %}selected{% endif %}>Omaggio</option>
          <option value="prevendita" {% if filtro.tipo=='prevendita' %}selected{% endif %}>Prevendita</option>
        </select>
      </div>
      <div class="form__group">
        <label class="form__label">Staff</label>
        <select class="form__input" name="staff_id">
          <option value="">Tutti</option>
          {% for s in staff_list %}
          <option value="{{ s.id_staff }}" {% if filtro.staff_id==s.id_staff %}selected{% endif %}>{{ s.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form__group">
        <label class="form__label">Dal</label>
        <input class="form__input" type="date" name="dal" value="{{ filtro.dal or '' }}">
      </div>
      <div class="form__group">
        <label class="form__label">Al</label>
        <input class="form__input" type="date" name="al" value="{{ filtro.al or '' }}">
      </div>
    </div>
    <div class="form__actions">
      <button class="btn btn--primary">Filtra</button>
      {% if filtro.evento_id or filtro.tipo or filtro.staff_id or filtro.dal or filtro.al %}
      <a href="{{ url_for('ingressi.admin_list') }}" class="btn btn--ghost">Reset</a>
      {% endif %}
      <a class="btn btn--secondary" href="{{ url_for('ingressi.admin_new') }}">Nuovo</a>
    </div>
  </form>
</section>

<!-- Info paginazione -->
{% if total > 0 %}
<section class="card" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <strong>Mostrando {{ ((page - 1) * per_page) + 1 }} - {{ (page * per_page if page * per_page < total else total) }} di {{ total }} ingressi</strong>
    </div>
    <div style="display: flex; gap: 0.75rem; align-items: center;">
      <label class="form__label" style="margin: 0; white-space: nowrap;">Per pagina:</label>
      <select class="form__input" style="width: auto; min-width: 80px;" onchange="updatePerPage(this.value)">
        <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
        <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
        <option value="200" {% if per_page==200 %}selected{% endif %}>200</option>
      </select>
    </div>
  </div>
  <script>
    function updatePerPage(value) {
      const url = new URL(window.location.href);
      url.searchParams.set('per_page', value);
      url.searchParams.set('page', '1');
      window.location.href = url.toString();
    }
  </script>
</section>
{% endif %}

<section class="list">
  {% for i, c, e in rows %}
  <article class="card list__item">
    <div class="list__item-header">
      <div>
        <a href="{{ url_for('ingressi.admin_ingresso_detail', ingresso_id=i.id_ingresso) }}" style="text-decoration: none; display: block;">
          <strong style="font-size: 1.125rem; background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 600;">
            {{ c.nome }} {{ c.cognome }}
          </strong>
        </a>
        <div style="margin-top: 0.25rem; color: var(--text-muted); font-size: 0.875rem;">
          {{ e.data_evento }} â€” {{ e.nome_evento }}
        </div>
        <div style="margin-top:0.5rem; display:flex; flex-wrap:wrap; gap:0.5rem;">
          <span class="badge badge--muted">{{ i.tipo_ingresso|capitalize }}</span>
          {% if i.prenotazione_id %}
          <span class="badge badge--success" style="background: rgba(212,175,55,0.15); color: var(--gold-primary); border: 1px solid rgba(212,175,55,0.35);">
            Via prenotazione
          </span>
          {% endif %}
          {% if i.note and 'Capienza superata' in i.note %}
          <span class="badge badge--danger">Overbooking autorizzato</span>
          {% endif %}
        </div>
      </div>
      <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:flex-end;">
        <a href="{{ url_for('ingressi.admin_ingresso_detail', ingresso_id=i.id_ingresso) }}" class="btn btn--primary btn--small">Dettagli</a>
        <small class="text--muted">{{ i.orario_ingresso.strftime('%d/%m/%Y %H:%M') if i.orario_ingresso else 'â€”' }}</small>
      </div>
    </div>
    <div class="card__meta" style="margin-top:0.75rem; display:flex; flex-direction:column; gap:0.35rem;">
      <span><strong>Registrato da:</strong> {{ i.staff.nome if i.staff else 'â€”' }}</span>
      {% if i.note %}
      <span class="text--muted">{{ i.note }}</span>
      {% endif %}
    </div>
  </article>
  {% else %}
    <div class="card"><p class="text--muted">Nessun ingresso.</p></div>
  {% endfor %}
</section>

<!-- Paginazione -->
{% if total_pages > 1 %}
<section class="card" style="padding: 1.5rem; margin-top: 2rem;">
  <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
    {% if page > 1 %}
    <a href="{{ url_for('ingressi.admin_list', page=1, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">Â« Prima</a>
    <a href="{{ url_for('ingressi.admin_list', page=page-1, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">â€¹ Precedente</a>
    {% endif %}
    
    <div style="display: flex; gap: 0.25rem; align-items: center; margin: 0 1rem;">
      {% set start_page = pages_list[0] if pages_list else 1 %}
      {% set end_page = pages_list[-1] if pages_list else total_pages %}
      
      {% if start_page > 1 %}
      <a href="{{ url_for('ingressi.admin_list', page=1, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">1</a>
      {% if start_page > 2 %}
      <span class="text--muted" style="padding: 0 0.5rem;">...</span>
      {% endif %}
      {% endif %}
      
      {% for p in pages_list %}
      {% if p == page %}
      <span class="btn btn--primary btn--small" style="pointer-events: none;">{{ p }}</span>
      {% else %}
      <a href="{{ url_for('ingressi.admin_list', page=p, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">{{ p }}</a>
      {% endif %}
      {% endfor %}
      
      {% if end_page < total_pages %}
      {% if end_page < total_pages - 1 %}
      <span class="text--muted" style="padding: 0 0.5rem;">...</span>
      {% endif %}
      <a href="{{ url_for('ingressi.admin_list', page=total_pages, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">{{ total_pages }}</a>
      {% endif %}
    </div>
    
    {% if page < total_pages %}
    <a href="{{ url_for('ingressi.admin_list', page=page+1, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">Successiva â€º</a>
    <a href="{{ url_for('ingressi.admin_list', page=total_pages, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">Ultima Â»</a>
    {% endif %}
  </div>
  
  <div style="text-align: center; margin-top: 1rem;">
    <small class="text--muted">Pagina {{ page }} di {{ total_pages }}</small>
  </div>
</section>
{% endif %}
{% endblock %}