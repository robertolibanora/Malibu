{% extends "admin/base.html" %}
{% block admin_title %}Ingressi{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}
{% from "admin/_secondary_nav.html" import render_secondary_nav %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_secondary_nav([
    {'url': url_for('prenotazioni.admin_hub'), 'endpoint': 'prenotazioni.admin_hub', 'label': 'Hub Operativo', 'icon': 'ğŸ“‹'},
    {'url': url_for('prenotazioni.admin_list'), 'endpoint': 'prenotazioni.admin_list', 'label': 'Prenotazioni', 'icon': 'ğŸ“'},
    {'url': url_for('prenotazioni.admin_prenotazioni_tavolo_attesa'), 'endpoint': 'prenotazioni.admin_prenotazioni_tavolo_attesa', 'label': 'Tavoli in Attesa', 'icon': 'ğŸª‘'},
    {'url': url_for('ingressi.admin_list'), 'endpoint': 'ingressi.admin_list', 'label': 'Ingressi', 'icon': 'ğŸšª'},
    {'url': url_for('consumi.admin_list'), 'endpoint': 'consumi.admin_list', 'label': 'Consumi', 'icon': 'ğŸ’°'},
    {'url': url_for('feedback.admin_list'), 'endpoint': 'feedback.admin_list', 'label': 'Feedback', 'icon': 'ğŸ’¬'},
  ], current_endpoint=request.endpoint) }}

  {{ render_page_header(
    title="Ingressi",
    subtitle="Check-in e registro accessi Â· Gestione ingressi in tempo reale",
    actions=[
      {'type': 'link', 'url': url_for('ingressi.admin_new'), 'label': '+ Nuovo Ingresso', 'class': 'btn--secondary'}
    ],
    breadcrumbs=[
      {'label': 'Operativo', 'url': url_for('prenotazioni.admin_hub')},
      {'label': 'Ingressi'}
    ]
  ) }}

  <!-- Filtri -->
  <section class="card">
    <form class="form" method="get">
      <div class="grid grid--2">
        <div class="form__group">
          <label class="form__label">Evento</label>
          <select class="form__select" name="evento_id">
            <option value="">Tutti</option>
            {% for ev in eventi %}
            <option value="{{ ev.id_evento }}" {% if filtro.evento_id==ev.id_evento %}selected{% endif %}>
              {{ ev.data_evento }} â€” {{ ev.nome_evento }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="form__group">
          <label class="form__label">Tipo</label>
          <select class="form__select" name="tipo_ingresso">
            <option value="">Tutti</option>
            <option value="lista" {% if filtro.tipo=='lista' %}selected{% endif %}>Lista</option>
            <option value="tavolo" {% if filtro.tipo=='tavolo' %}selected{% endif %}>Tavolo</option>
            <option value="omaggio" {% if filtro.tipo=='omaggio' %}selected{% endif %}>Omaggio</option>
            <option value="prevendita" {% if filtro.tipo=='prevendita' %}selected{% endif %}>Prevendita</option>
          </select>
        </div>
        <div class="form__group">
          <label class="form__label">Staff</label>
          <select class="form__select" name="staff_id">
            <option value="">Tutti</option>
            {% for s in staff_list %}
            <option value="{{ s.id_staff }}" {% if filtro.staff_id==s.id_staff %}selected{% endif %}>{{ s.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form__group">
          <label class="form__label">Dal</label>
          <input class="form__input" type="date" name="dal" value="{{ filtro.dal or '' }}">
        </div>
        <div class="form__group">
          <label class="form__label">Al</label>
          <input class="form__input" type="date" name="al" value="{{ filtro.al or '' }}">
        </div>
      </div>
      <div class="form__actions">
        <button class="btn btn--primary" type="submit">Filtra</button>
        {% if filtro.evento_id or filtro.tipo or filtro.staff_id or filtro.dal or filtro.al %}
        <a href="{{ url_for('ingressi.admin_list') }}" class="btn btn--ghost">Reset</a>
        {% endif %}
      </div>
    </form>
  </section>

  <!-- Info paginazione -->
  {% if total > 0 %}
  <section class="card">
    <div class="card__content">
      <div class="management">
        <div class="management__info">
          <strong>Mostrando {{ ((page - 1) * per_page) + 1 }} - {{ (page * per_page if page * per_page < total else total) }} di {{ total }} ingressi</strong>
        </div>
        <div class="management__actions">
          <label class="form__label" style="margin: 0; white-space: nowrap;">Per pagina:</label>
          <select class="form__select" style="width: auto; min-width: 80px;" onchange="updatePerPage(this.value)">
            <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
            <option value="200" {% if per_page==200 %}selected{% endif %}>200</option>
          </select>
        </div>
      </div>
    </div>
  </section>
  <script>
    function updatePerPage(value) {
      const url = new URL(window.location.href);
      url.searchParams.set('per_page', value);
      url.searchParams.set('page', '1');
      window.location.href = url.toString();
    }
  </script>
  {% endif %}

  <!-- Lista Ingressi -->
  {% if rows %}
  <section class="list">
    {% for i, c, e in rows %}
    <article class="card list__item">
      <div class="list__item-header">
        <div>
          <a href="{{ url_for('ingressi.admin_ingresso_detail', ingresso_id=i.id_ingresso) }}" class="list__item-title-link">
            <strong>{{ c.nome }} {{ c.cognome }}</strong>
          </a>
          <div class="list__item-meta">
            {{ e.data_evento }} â€” {{ e.nome_evento }}
          </div>
          <div class="list__item-badges">
            <span class="badge badge--{{ 'success' if i.tipo_ingresso == 'lista' else 'primary' if i.tipo_ingresso == 'tavolo' else 'warning' if i.tipo_ingresso == 'omaggio' else 'secondary' }}">
              {{ i.tipo_ingresso|capitalize }}
            </span>
            {% if i.prenotazione_id %}
            <span class="badge badge--success">Via prenotazione</span>
            {% endif %}
            {% if i.note and 'Capienza superata' in i.note %}
            <span class="badge badge--danger">Overbooking autorizzato</span>
            {% endif %}
          </div>
        </div>
        <div class="list__item-actions">
          <a href="{{ url_for('ingressi.admin_ingresso_detail', ingresso_id=i.id_ingresso) }}" class="btn btn--primary btn--small">Dettagli</a>
          <small class="text--muted">{{ i.orario_ingresso.strftime('%d/%m/%Y %H:%M') if i.orario_ingresso else 'â€”' }}</small>
        </div>
      </div>
      <div class="card__meta">
        <span><strong>Registrato da:</strong> {{ i.staff.nome if i.staff else 'â€”' }}</span>
        {% if i.note %}
        <span class="text--muted">{{ i.note }}</span>
        {% endif %}
      </div>
    </article>
    {% endfor %}
  </section>
  {% else %}
  <section class="card">
    <div class="admin-empty-state">
      <span class="admin-empty-state__icon">ğŸšª</span>
      <p class="admin-empty-state__message">Nessun ingresso trovato.</p>
    </div>
  </section>
  {% endif %}

  <!-- Paginazione -->
  {% if total_pages > 1 %}
  <section class="card">
    <div class="card__content">
      <nav class="management__pagination">
        <div class="pagination__controls">
          {% if page > 1 %}
          <a href="{{ url_for('ingressi.admin_list', page=1, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">Â« Prima</a>
          <a href="{{ url_for('ingressi.admin_list', page=page-1, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">â€¹ Precedente</a>
          {% endif %}
          
          <span class="pagination__pages">
            {% set start_page = pages_list[0] if pages_list else 1 %}
            {% set end_page = pages_list[-1] if pages_list else total_pages %}
            
            {% if start_page > 1 %}
            <a href="{{ url_for('ingressi.admin_list', page=1, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="pagination__page">1</a>
            {% if start_page > 2 %}
            <span class="text--muted" style="padding: 0 var(--spacing-2);">...</span>
            {% endif %}
            {% endif %}
            
            {% for p in pages_list %}
            {% if p == page %}
            <span class="pagination__page pagination__page--active">{{ p }}</span>
            {% else %}
            <a href="{{ url_for('ingressi.admin_list', page=p, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="pagination__page">{{ p }}</a>
            {% endif %}
            {% endfor %}
            
            {% if end_page < total_pages %}
            {% if end_page < total_pages - 1 %}
            <span class="text--muted" style="padding: 0 var(--spacing-2);">...</span>
            {% endif %}
            <a href="{{ url_for('ingressi.admin_list', page=total_pages, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="pagination__page">{{ total_pages }}</a>
            {% endif %}
          </span>
          
          {% if page < total_pages %}
          <a href="{{ url_for('ingressi.admin_list', page=page+1, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">Successiva â€º</a>
          <a href="{{ url_for('ingressi.admin_list', page=total_pages, per_page=per_page, evento_id=filtro.evento_id, tipo_ingresso=filtro.tipo, staff_id=filtro.staff_id, dal=filtro.dal, al=filtro.al) }}" class="btn btn--ghost btn--small">Ultima Â»</a>
          {% endif %}
        </div>
        <div style="text-align: center; margin-top: var(--spacing-3);">
          <small class="text--muted">Pagina {{ page }} di {{ total_pages }}</small>
        </div>
      </nav>
    </div>
  </section>
  {% endif %}
</div>
{% endblock %}
