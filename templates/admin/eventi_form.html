{% extends "admin/base.html" %}
{% block admin_title %}{{ 'Modifica' if e else 'Nuovo' }} Evento{% endblock %}

{% block admin_content %}
<section class="card">
  <h1 class="card__title">{{ 'Modifica' if e else 'Nuovo' }} evento</h1>
  <p class="text--muted" style="margin-bottom:1.5rem;">
    <strong>Nota:</strong> un evento appena creato parte in stato <em>programmato</em> e non è operativo per lo staff finché non lo imposti dal pannello “Evento operativo”.
  </p>
  <form class="form" method="post" enctype="multipart/form-data" id="eventoForm">
    {% if not e %}
    <div class="form__group">
      <label class="form__label">Format *</label>
      <select class="form__input" name="template_evento" id="template_evento" required>
        <option value="">— Seleziona un format —</option>
        {% if FORMATS and FORMATS|length %}
          {% for f in FORMATS %}
          <option value="db-{{ f.id_template }}"
                  data-nome="{{ f.nome }}"
                  data-categoria="{{ f.categoria }}"
                  data-tipo-musica="{{ f.tipo_musica or '' }}"
                  data-capienza="{{ f.capienza or '' }}">
            {{ f.nome }} ({{ f.categoria|capitalize }})
          </option>
          {% endfor %}
        {% else %}
          {% for idx in range(TEMPLATE_EVENTI|length) %}
          {% set template = TEMPLATE_EVENTI[idx] %}
          <option value="{{ idx }}" {% if template_selezionato and template_selezionato|int == idx %}selected{% endif %}
                  data-nome="{{ template.nome }}"
                  data-categoria="{{ template.categoria }}"
                  data-tipo-musica="{{ template.tipo_musica }}"
                  data-capienza="{{ template.capienza }}">
            {{ template.nome }} ({{ template.categoria|capitalize }})
          </option>
          {% endfor %}
        {% endif %}
        <option value="custom">— Personalizzato —</option>
      </select>
      <small>Il format selezionato viene salvato sull'evento e precompila i campi. Scegli "Personalizzato" per inserire manualmente.</small>
    </div>
    {% endif %}
    
    <div class="form__group">
      <label class="form__label">Nome evento *</label>
      <input class="form__input" name="nome_evento" id="nome_evento" value="{{ e.nome_evento if e else '' }}" required>
    </div>
    <div class="form__group">
      <label class="form__label">Data evento</label>
      <input class="form__input" type="date" name="data_evento" value="{{ e.data_evento if e else '' }}" required>
    </div>
    <div class="form__group">
      <label class="form__label">Tipo musica</label>
      <input class="form__input" name="tipo_musica" id="tipo_musica" value="{{ e.tipo_musica if e else '' }}">
    </div>
    <div class="form__group">
      <label class="form__label">DJ / Artista</label>
      <input class="form__input" name="dj_artista" value="{{ e.dj_artista if e else '' }}">
    </div>
    <div class="form__group">
      <label class="form__label">Promozione</label>
      <input class="form__input" name="promozione" value="{{ e.promozione if e else '' }}">
    </div>
    <div class="form__group">
      <label class="form__label">Capienza max</label>
      <input class="form__input" type="number" min="0" name="capienza_max" id="capienza_max" value="{{ e.capienza_max if e else 2000 }}" required>
    </div>
    <div class="form__group">
      <label class="form__label">Stato pubblico</label>
      <select class="form__input" name="stato_pubblico" required>
        {% if e %}
          <option value="programmato" {% if e.stato_pubblico == 'programmato' %}selected{% endif %}>Programmato</option>
          <option value="attivo" {% if e.stato_pubblico == 'attivo' %}selected{% endif %}>Attivo</option>
          <option value="chiuso" {% if e.stato_pubblico == 'chiuso' %}selected{% endif %}>Chiuso</option>
        {% else %}
          <option value="programmato" selected>Programmato</option>
          <option value="attivo">Attivo</option>
          <option value="chiuso">Chiuso</option>
        {% endif %}
      </select>
      <small class="text--muted">Lo staff può operare solo sugli eventi con stato pubblico "attivo" e impostati come "operativi".</small>
    </div>
    
    <div class="form__group" style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem; margin-top: 1rem;">
      <h3 style="margin-bottom: 1rem; color: var(--admin-accent);">⏰ Apertura e Chiusura Automatica</h3>
      <p class="text--muted" style="margin-bottom: 1rem; font-size: 0.9rem;">
        Imposta gli orari per l'apertura e chiusura automatica dell'evento. L'evento passerà automaticamente a "attivo" all'orario di apertura e a "chiuso" all'orario di chiusura.
      </p>
    </div>
    
    <div class="grid grid--2">
      <div class="form__group">
        <label class="form__label">Data e Ora Apertura Automatica</label>
        <input class="form__input" type="datetime-local" name="data_ora_apertura_auto" id="data_ora_apertura_auto" 
               value="{% if e and e.data_ora_apertura_auto %}{{ e.data_ora_apertura_auto.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
        <small class="text--muted">Quando l'evento deve passare automaticamente a "attivo"</small>
      </div>
      <div class="form__group">
        <label class="form__label">Data e Ora Chiusura Automatica</label>
        <input class="form__input" type="datetime-local" name="data_ora_chiusura_auto" id="data_ora_chiusura_auto" 
               value="{% if e and e.data_ora_chiusura_auto %}{{ e.data_ora_chiusura_auto.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
        <small class="text--muted">Quando l'evento deve passare automaticamente a "chiuso"</small>
      </div>
    </div>
    
    <div class="form__group">
      <label class="form__label">Immagine Copertina (JPG/PNG) {% if not e %}*{% endif %}</label>
      <input class="form__input" type="file" name="cover_image" id="cover_image" accept="image/jpeg,image/jpg,image/png" {% if not e %}required{% endif %}>
      {% if e and e.cover_url %}
      <div style="margin-top: 1rem;">
        <img src="{{ url_for('static', filename='uploads/eventi/' + e.cover_url) }}" alt="Cover evento" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.2);">
        <div style="margin-top: 0.5rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="remove_cover" value="1">
            <span>Rimuovi immagine attuale</span>
          </label>
        </div>
      </div>
      {% endif %}
      <small>Formati supportati: JPG, PNG (max 16MB). {% if not e %}<strong>L'immagine è obbligatoria per nuovi eventi.</strong>{% endif %}</small>
    </div>

    <div class="form__actions">
      <button class="btn btn--primary">{{ 'Salva' if e else 'Crea' }}</button>
      {% if e %}
      <a class="btn btn--ghost" href="{{ url_for('eventi.admin_evento_detail', evento_id=e.id_evento) }}">Annulla</a>
      {% else %}
      <a class="btn btn--ghost" href="{{ url_for('eventi.admin_list') }}">Annulla</a>
      {% endif %}
    </div>
  </form>
</section>

{% if not e %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const templateSelect = document.getElementById('template_evento');
  const nomeInput = document.getElementById('nome_evento');
  const tipoMusicaInput = document.getElementById('tipo_musica');
  const capienzaInput = document.getElementById('capienza_max');
  const statoSelect = document.querySelector('select[name="stato_pubblico"]');
  
  templateSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    
    if (selectedOption.value && selectedOption.value !== 'custom' && selectedOption.value !== '') {
      // Precompila i campi con i valori del format
      nomeInput.value = selectedOption.getAttribute('data-nome') || '';
      tipoMusicaInput.value = selectedOption.getAttribute('data-tipo-musica') || '';
      capienzaInput.value = selectedOption.getAttribute('data-capienza') || '2500';
      if (statoSelect) {
        statoSelect.value = 'programmato';
      }
    } else if (selectedOption.value === 'custom') {
      // Pulisci i campi per permettere inserimento personalizzato
      nomeInput.value = '';
      tipoMusicaInput.value = '';
      capienzaInput.value = '2500';
      if (statoSelect) {
        statoSelect.value = 'programmato';
      }
    }
  });
});
</script>
{% endif %}
{% endblock %}