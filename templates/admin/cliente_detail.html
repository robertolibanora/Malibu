{% extends "admin/base.html" %}
{% block admin_title %}{{ cliente.nome }} {{ cliente.cognome }}{% endblock %}

{% block admin_content %}
{% set last_ingresso = ultimo_ingresso.ingresso if ultimo_ingresso else None %}
{% set last_ingresso_event = ultimo_ingresso.evento if ultimo_ingresso else None %}
{% set last_prenotazione = ultima_prenotazione.prenotazione if ultima_prenotazione else None %}
{% set last_prenotazione_event = ultima_prenotazione.evento if ultima_prenotazione else None %}
{% set last_consumo = ultimo_consumo.consumo if ultimo_consumo else None %}
{% set last_consumo_event = ultimo_consumo.evento if ultimo_consumo else None %}

<div class="profile">
  <header class="profile__header fade-in">
    <div class="profile__headline">
      <a href="{{ url_for('clienti.admin_lista_clienti') }}" class="btn btn--ghost profile__back">← Torna alla lista</a>
      <div class="profile__identity">
        <h1 class="profile__title">{{ cliente.nome }} {{ cliente.cognome }}</h1>
        <div class="profile__badges">
          <span class="badge badge--{{ 'success' if cliente.stato_account == 'attivo' else 'secondary' }}">{{ cliente.stato_account|capitalize }}</span>
          <span class="badge badge--warning">{{ cliente.livello|upper }}</span>
          <span class="profile__id">ID • {{ cliente.id_cliente }}</span>
        </div>
        <div class="profile__meta">
          <span>Registrato il {{ cliente.data_registrazione.strftime('%d/%m/%Y %H:%M') if cliente.data_registrazione else '—' }}</span>
          <span>
            Ultimo ingresso:
            {% if last_ingresso %}
              {{ last_ingresso.orario_ingresso.strftime('%d/%m/%Y %H:%M') if last_ingresso.orario_ingresso else '—' }}
              {% if last_ingresso_event %} • {{ last_ingresso_event.nome_evento }}{% endif %}
            {% else %}
              mai registrato
            {% endif %}
          </span>
          {% if cliente.qr_code %}
          <span>QR Code: <code class="profile__code">{{ cliente.qr_code }}</code></span>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="profile__actions">
      <form method="post" action="{{ url_for('clienti.admin_delete', cliente_id=cliente.id_cliente) }}" onsubmit="return confirm('Eliminare definitivamente questo cliente? L’operazione non è reversibile.');">
        <button class="btn btn--danger btn--small">Elimina cliente</button>
      </form>
    </div>
  </header>

  <section class="profile__stats fade-in" style="animation-delay: 80ms;">
    <article class="profile-metric">
      <span class="profile-metric__label">Prenotazioni totali</span>
      <span class="profile-metric__value">{{ tot_prenotazioni }}</span>
      {% if last_prenotazione %}
      <span class="profile-metric__meta">Ultima: {{ last_prenotazione_event.data_evento.strftime('%d/%m/%Y') if last_prenotazione_event and last_prenotazione_event.data_evento else '—' }} • {{ last_prenotazione.tipo|capitalize }}</span>
      {% endif %}
    </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Ingressi totali</span>
      <span class="profile-metric__value">{{ tot_ingressi }}</span>
      {% if last_ingresso %}
      <span class="profile-metric__meta">Ultimo: {{ last_ingresso.orario_ingresso.strftime('%d/%m/%Y') if last_ingresso.orario_ingresso else '—' }}</span>
      {% endif %}
    </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Consumi</span>
      <span class="profile-metric__value">€{{ "%.2f"|format(tot_consumi) }}</span>
      {% if last_consumo %}
      <span class="profile-metric__meta">Ultimo: {{ last_consumo_event.nome_evento if last_consumo_event else '—' }}</span>
      {% endif %}
    </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Punti fedeltà</span>
      <span class="profile-metric__value">{{ cliente.punti_fedelta or 0 }}</span>
      <span class="profile-metric__meta">{{ tot_punti }} assegnati complessivi</span>
    </article>
  </section>

  <div class="profile__grid fade-in" style="animation-delay: 140ms;">
    <section class="profile-card profile-card--info">
      <h2 class="profile-card__title">Dettagli cliente</h2>
      <dl class="profile-list">
        <div>
          <dt>Telefono</dt>
          <dd>{{ cliente.telefono or '—' }}</dd>
        </div>
        {% if cliente.data_nascita %}
        <div>
          <dt>Data di nascita</dt>
          <dd>{{ cliente.data_nascita.strftime('%d/%m/%Y') if cliente.data_nascita.__class__.__name__ == 'date' else cliente.data_nascita }}</dd>
        </div>
        {% endif %}
        {% if cliente.citta %}
        <div>
          <dt>Città</dt>
          <dd>{{ cliente.citta }}</dd>
        </div>
        {% endif %}
        <div>
          <dt>Ultimo ingresso</dt>
          <dd>
            {% if last_ingresso %}
              {{ last_ingresso.orario_ingresso.strftime('%d/%m/%Y %H:%M') if last_ingresso.orario_ingresso else '—' }}
              {% if last_ingresso_event %}<span class="profile-list__meta">• {{ last_ingresso_event.nome_evento }}</span>{% endif %}
            {% else %}
              Mai registrato
            {% endif %}
          </dd>
        </div>
        <div>
          <dt>Ultimo consumo</dt>
          <dd>
            {% if last_consumo %}
              {{ last_consumo.data_consumo.strftime('%d/%m/%Y %H:%M') if last_consumo.data_consumo else '—' }}
              {% if last_consumo_event %}<span class="profile-list__meta">• {{ last_consumo_event.nome_evento }}</span>{% endif %}
            {% else %}
              Nessun consumo registrato
            {% endif %}
          </dd>
        </div>
      </dl>
    </section>

    <section class="profile-card profile-card--actions">
      <h2 class="profile-card__title">Gestione account</h2>

      <form class="profile-form" method="post" action="{{ url_for('clienti.admin_set_level', cliente_id=cliente.id_cliente) }}">
        <label class="profile-form__label">Livello fedeltà</label>
        <div class="profile-form__row">
          <select class="form__select" name="livello">
            {% for lvl in ['base','loyal','premium','vip'] %}
            <option value="{{ lvl }}" {% if cliente.livello==lvl %}selected{% endif %}>{{ lvl|upper }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn--primary btn--small">Aggiorna</button>
        </div>
      </form>

      <form class="profile-form" method="post" action="{{ url_for('clienti.admin_adjust_points', cliente_id=cliente.id_cliente) }}">
        <label class="profile-form__label">Modifica punti</label>
        <div class="profile-form__row">
          <input class="form__input" name="delta" type="number" step="1" placeholder="+/- punti" required>
          <button type="submit" class="btn btn--secondary btn--small">Applica</button>
        </div>
        <small>Punti attuali: <strong>{{ cliente.punti_fedelta or 0 }}</strong></small>
      </form>

      <form class="profile-form" method="post" action="{{ url_for('clienti.admin_set_note', cliente_id=cliente.id_cliente) }}">
        <label class="profile-form__label">Nota staff</label>
        <textarea class="form__textarea" name="nota_staff" rows="3" placeholder="Annotazioni visibili solo allo staff...">{{ cliente.nota_staff or '' }}</textarea>
        <div class="profile-form__actions">
          <span class="profile-form__hint">Salvata per tutti gli operatori</span>
          <button type="submit" class="btn btn--ghost btn--small">Salva nota</button>
        </div>
      </form>
    </section>
  </div>

  <section class="profile-card fade-in" style="animation-delay: 180ms;">
    <div class="profile-card__header">
      <h2 class="profile-card__title">Storico punti fedeltà</h2>
    </div>
    {% if movimenti_fedelta %}
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Evento</th>
            <th>Punti</th>
            <th>Motivo</th>
          </tr>
        </thead>
        <tbody>
          {% for mov, ev in movimenti_fedelta %}
          <tr>
            <td>{{ mov.data_assegnazione.strftime('%d/%m/%Y %H:%M') if mov.data_assegnazione else '—' }}</td>
            <td>{{ ev.nome_evento if ev else '—' }}</td>
            <td><strong class="text--gold">{{ mov.punti }}</strong></td>
            <td>{{ mov.motivo or '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">Nessun movimento fedeltà registrato.</div>
    {% endif %}
  </section>

  <div class="profile__timeline fade-in" style="animation-delay: 220ms;">
    <section class="profile-card profile-card--timeline">
      <h2 class="profile-card__title">Ultime prenotazioni</h2>
      {% if ultime_prenotazioni %}
      <ul class="timeline-list">
        {% for pren, ev in ultime_prenotazioni %}
        <li class="timeline-item">
          <div class="timeline-item__header">
            <strong>{{ ev.nome_evento }}</strong>
            <span class="badge badge--{{ 'success' if pren.stato == 'attiva' else 'secondary' }}">{{ pren.stato }}</span>
          </div>
          <div class="timeline-item__meta">
            {{ ev.data_evento.strftime('%d/%m/%Y') if ev.data_evento else 'Data da definire' }} • {{ pren.tipo|capitalize }}
            {% if pren.num_persone %} • {{ pren.num_persone }} pax{% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="empty-state">Nessuna prenotazione recente.</div>
      {% endif %}
    </section>

    <section class="profile-card profile-card--timeline">
      <h2 class="profile-card__title">Ultimi ingressi</h2>
      {% if ultimi_ingressi %}
      <ul class="timeline-list">
        {% for ing, ev in ultimi_ingressi %}
        <li class="timeline-item">
          <div class="timeline-item__header">
            <strong>{{ ev.nome_evento }}</strong>
            <span class="badge badge--secondary">{{ ing.tipo_ingresso|capitalize }}</span>
          </div>
          <div class="timeline-item__meta">
            {{ ing.orario_ingresso.strftime('%d/%m/%Y %H:%M') if ing.orario_ingresso else '—' }}
          </div>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <div class="empty-state">Nessun ingresso registrato.</div>
      {% endif %}
    </section>
  </div>

  <section class="profile-card fade-in" style="animation-delay: 260ms;">
    <div class="profile-card__header">
      <h2 class="profile-card__title">Ultimi consumi</h2>
    </div>
    {% if ultimi_consumi %}
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Evento</th>
            <th>Prodotto</th>
            <th>Importo</th>
            <th>Punto vendita</th>
          </tr>
        </thead>
        <tbody>
          {% for cons, ev in ultimi_consumi %}
          <tr>
            <td>{{ cons.data_consumo.strftime('%d/%m/%Y %H:%M') if cons.data_consumo else '—' }}</td>
            <td>{{ ev.nome_evento if ev else '—' }}</td>
            <td>{{ cons.prodotto }}</td>
            <td><strong>€{{ "%.2f"|format(cons.importo) }}</strong></td>
            <td>{{ cons.punto_vendita|capitalize }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">Nessun consumo registrato.</div>
    {% endif %}
  </section>

  {% if feedback_list %}
  <section class="profile-card fade-in" style="animation-delay: 300ms;">
    <div class="profile-card__header">
      <h2 class="profile-card__title">Feedback degli eventi</h2>
    </div>
    <ul class="feedback-list">
      {% for fb, ev in feedback_list %}
      <li class="feedback-item">
        <div class="feedback-item__header">
          <strong>{{ ev.nome_evento }}</strong>
          <span class="feedback-item__date">{{ fb.data_feedback.strftime('%d/%m/%Y') if fb.data_feedback else '—' }}</span>
        </div>
        <div class="feedback-item__scores">
          <span>Musica <strong>{{ fb.voto_musica }}/10</strong></span>
          <span>Ingresso <strong>{{ fb.voto_ingresso }}/10</strong></span>
          <span>Ambiente <strong>{{ fb.voto_ambiente }}/10</strong></span>
        </div>
        {% if fb.note %}
        <p class="feedback-item__note">{{ fb.note }}</p>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <section class="profile-card fade-in" style="animation-delay: 340ms;">
    <div class="profile-card__header">
      <h2 class="profile-card__title">Promozioni</h2>
    </div>

    {% if promozioni_disponibili %}
    <div class="profile-promo__assign">
      <div class="profile-promo__title">Assegna promozione</div>
      <form method="post" id="assign-promo-form" class="profile-promo__form">
        <select name="promozione_id" id="promozione-select" class="form__select" required>
          <option value="">Seleziona promozione…</option>
          {% for prom in promozioni_disponibili %}
          <option value="{{ prom.id_promozione }}" data-url="{{ url_for('promozioni.admin_assign', cliente_id=cliente.id_cliente, promozione_id=prom.id_promozione) }}">
            {{ prom.nome }} ({{ prom.tipo|replace('_',' ')|title }})
          </option>
          {% endfor %}
        </select>
        <button type="submit" class="btn btn--primary btn--small">Assegna</button>
      </form>
    </div>
    {% endif %}

    {% if promozioni_cliente %}
    <div class="table-responsive">
      <table class="table table--compact">
        <thead>
          <tr>
            <th>Promozione</th>
            <th>Tipo</th>
            <th>Valore</th>
            <th>Assegnata</th>
            <th>Scadenza</th>
            <th>Stato</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for cp, prom in promozioni_cliente %}
          <tr>
            <td>
              <strong>{{ prom.nome }}</strong>
              {% if prom.descrizione %}
              <br><small class="text--muted">{{ prom.descrizione }}</small>
              {% endif %}
            </td>
            <td>{{ prom.tipo|replace('_',' ')|title }}</td>
            <td>
              {% if prom.valore %}
                {% if prom.tipo == 'sconto_percentuale' %}
                  {{ prom.valore }}%
                {% else %}
                  €{{ "%.2f"|format(prom.valore) }}
                {% endif %}
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ cp.data_assegnazione.strftime('%d/%m/%Y') if cp.data_assegnazione else '—' }}</td>
            <td>{{ cp.data_scadenza.strftime('%d/%m/%Y') if cp.data_scadenza else '—' }}</td>
            <td>
              {% if cp.usata %}
              <span class="badge badge--secondary">Usata</span>
              {% elif cp.data_scadenza and cp.data_scadenza < oggi %}
              <span class="badge badge--secondary">Scaduta</span>
              {% else %}
              <span class="badge badge--success">Attiva</span>
              {% endif %}
            </td>
            <td>
              {% if not cp.usata %}
              <form method="post" action="{{ url_for('promozioni.admin_unassign', cliente_id=cliente.id_cliente, promozione_id=prom.id_promozione) }}" onsubmit="return confirm('Rimuovere questa promozione?');">
                <button class="btn btn--ghost btn--small">Rimuovi</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">Nessuna promozione attiva per questo cliente.</div>
    {% endif %}
  </section>
</div>

<script>
  const promoForm = document.getElementById('assign-promo-form');
  if (promoForm) {
    promoForm.addEventListener('submit', function (event) {
      const select = document.getElementById('promozione-select');
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption && selectedOption.value) {
        this.action = selectedOption.getAttribute('data-url');
      } else {
        event.preventDefault();
        alert('Seleziona una promozione');
      }
    });
  }
</script>
{% endblock %}

