{% extends "admin/base.html" %}
{% block admin_title %}{{ cliente.nome }} {{ cliente.cognome }}{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}
{% from "admin/_secondary_nav.html" import render_secondary_nav %}

{% block admin_content %}
{% set last_ingresso = ultimo_ingresso.ingresso if ultimo_ingresso else None %}
{% set last_ingresso_event = ultimo_ingresso.evento if ultimo_ingresso else None %}
{% set last_prenotazione = ultima_prenotazione.prenotazione if ultima_prenotazione else None %}
{% set last_prenotazione_event = ultima_prenotazione.evento if ultima_prenotazione else None %}
{% set last_consumo = ultimo_consumo.consumo if ultimo_consumo else None %}
{% set last_consumo_event = ultimo_consumo.evento if ultimo_consumo else None %}

<div class="admin-shell__content">
  {{ render_secondary_nav([
    {'url': url_for('clienti.admin_lista_clienti'), 'endpoint': 'clienti.admin_lista_clienti', 'label': 'Anagrafica', 'icon': 'üë•'},
    {'url': url_for('fedelta.admin_list'), 'endpoint': 'fedelta.admin_list', 'label': 'Punti Fedelt√†', 'icon': '‚≠ê'},
  ], current_endpoint=None) }}

  {{ render_page_header(
    title=cliente.nome ~ " " ~ cliente.cognome,
    subtitle="Profilo cliente completo ¬∑ Gestione account e fedelt√†",
    actions=[
      {'type': 'link', 'url': url_for('clienti.admin_lista_clienti'), 'label': '‚Üê Lista Clienti', 'class': 'btn--ghost'},
      {'type': 'button', 'label': 'Elimina cliente', 'class': 'btn--danger', 'onclick': "if(confirm('Eliminare definitivamente questo cliente? L\\'operazione non √® reversibile.')) { document.getElementById('delete-form').submit(); }"}
    ],
    breadcrumbs=[
      {'label': 'Clienti', 'url': url_for('clienti.admin_lista_clienti')},
      {'label': cliente.nome ~ " " ~ cliente.cognome}
    ]
  ) }}

  <form id="delete-form" method="post" action="{{ url_for('clienti.admin_delete', cliente_id=cliente.id_cliente) }}" style="display: none;"></form>

  <!-- Badge e Info Principali -->
  <section class="card">
    <div class="card__header">
      <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-2); align-items: center;">
        <span class="badge badge--{{ 'success' if cliente.stato_account == 'attivo' else 'secondary' }}">{{ cliente.stato_account|capitalize }}</span>
        <span class="badge badge--level badge--level-{{ cliente.livello|lower if cliente.livello else 'base' }}">{{ cliente.livello|upper if cliente.livello else 'BASE' }}</span>
        <span class="badge badge--secondary">ID: {{ cliente.id_cliente }}</span>
        {% if cliente.qr_code %}
        <span class="badge badge--secondary">QR: {{ cliente.qr_code }}</span>
        {% endif %}
      </div>
    </div>
    <div class="card__content">
      <dl class="info-list">
        <div class="info-list__item">
          <dt class="info-list__label">Registrato il</dt>
          <dd class="info-list__value">{{ cliente.data_registrazione.strftime('%d/%m/%Y %H:%M') if cliente.data_registrazione else '‚Äî' }}</dd>
        </div>
        <div class="info-list__item">
          <dt class="info-list__label">Ultimo ingresso</dt>
          <dd class="info-list__value">
            {% if last_ingresso %}
              {{ last_ingresso.orario_ingresso.strftime('%d/%m/%Y %H:%M') if last_ingresso.orario_ingresso else '‚Äî' }}
              {% if last_ingresso_event %} ‚Ä¢ {{ last_ingresso_event.nome_evento }}{% endif %}
            {% else %}
              Mai registrato
            {% endif %}
          </dd>
        </div>
        {% if cliente.telefono %}
        <div class="info-list__item">
          <dt class="info-list__label">Telefono</dt>
          <dd class="info-list__value"><a href="tel:{{ cliente.telefono }}">{{ cliente.telefono }}</a></dd>
        </div>
        {% endif %}
        {% if cliente.data_nascita %}
        <div class="info-list__item">
          <dt class="info-list__label">Data di nascita</dt>
          <dd class="info-list__value">{{ cliente.data_nascita.strftime('%d/%m/%Y') if cliente.data_nascita.__class__.__name__ == 'date' else cliente.data_nascita }}</dd>
        </div>
        {% endif %}
        {% if cliente.citta %}
        <div class="info-list__item">
          <dt class="info-list__label">Citt√†</dt>
          <dd class="info-list__value">{{ cliente.citta }}</dd>
        </div>
        {% endif %}
      </dl>
    </div>
  </section>

  <!-- Statistiche Principali -->
  <div class="grid grid--auto">
    <a href="{{ url_for('prenotazioni.admin_list', cliente_id=cliente.id_cliente) }}" class="stat-card" style="text-decoration: none; cursor: pointer; transition: all var(--transition-base); border-left: 4px solid #3b82f6;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform=''; this.style.boxShadow='var(--shadow-card)'">
      <div class="stat-card__label">üìã Prenotazioni</div>
      <div class="stat-card__value" style="color: #3b82f6;">{{ tot_prenotazioni }}</div>
      {% if last_prenotazione %}
      <div class="stat-card__meta">Ultima: {{ last_prenotazione_event.data_evento.strftime('%d/%m/%Y') if last_prenotazione_event and last_prenotazione_event.data_evento else '‚Äî' }}</div>
      {% endif %}
    </a>

    <a href="{{ url_for('ingressi.admin_list', cliente_id=cliente.id_cliente) }}" class="stat-card" style="text-decoration: none; cursor: pointer; transition: all var(--transition-base); border-left: 4px solid #8b5cf6;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform=''; this.style.boxShadow='var(--shadow-card)'">
      <div class="stat-card__label">üö™ Ingressi</div>
      <div class="stat-card__value" style="color: #8b5cf6;">{{ tot_ingressi }}</div>
      {% if last_ingresso %}
      <div class="stat-card__meta">Ultimo: {{ last_ingresso.orario_ingresso.strftime('%d/%m/%Y') if last_ingresso.orario_ingresso else '‚Äî' }}</div>
      {% endif %}
    </a>

    <a href="{{ url_for('consumi.admin_list', cliente_id=cliente.id_cliente) }}" class="stat-card" style="text-decoration: none; cursor: pointer; transition: all var(--transition-base); border-left: 4px solid #3fc380;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='var(--shadow-lg)'" onmouseout="this.style.transform=''; this.style.boxShadow='var(--shadow-card)'">
      <div class="stat-card__label">üí∞ Consumi</div>
      <div class="stat-card__value" style="color: #3fc380;">‚Ç¨{{ "%.2f"|format(tot_consumi) }}</div>
      {% if last_consumo %}
      <div class="stat-card__meta">Ultimo: {{ last_consumo_event.nome_evento if last_consumo_event else '‚Äî' }}</div>
      {% endif %}
    </a>

    <div class="stat-card" style="border-left: 4px solid #d4af37;">
      <div class="stat-card__label">‚≠ê Punti Fedelt√†</div>
      <div class="stat-card__value" style="color: #d4af37;">{{ cliente.punti_fedelta or 0 }}</div>
      <div class="stat-card__meta">{{ tot_punti }} assegnati complessivi</div>
    </div>
  </div>

  <!-- Gestione Account e Dettagli -->
  <div class="grid grid--2">
    <!-- Gestione Account -->
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Gestione Account</h2>
        <p class="card__subtitle">Modifica livello, punti e note</p>
      </div>
      <div class="card__content">
        <form class="form" method="post" action="{{ url_for('clienti.admin_set_level', cliente_id=cliente.id_cliente) }}">
          <div class="form__group">
            <label class="form__label">Livello fedelt√†</label>
            <div style="display: flex; gap: var(--spacing-2);">
              <select class="form__select" name="livello" style="flex: 1;">
                {% for lvl in ['base','loyal','premium','vip'] %}
                <option value="{{ lvl }}" {% if cliente.livello==lvl %}selected{% endif %}>{{ lvl|upper }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="btn btn--primary btn--small">Aggiorna</button>
            </div>
          </div>
        </form>

        <form class="form" method="post" action="{{ url_for('clienti.admin_adjust_points', cliente_id=cliente.id_cliente) }}" style="margin-top: var(--spacing-4);">
          <div class="form__group">
            <label class="form__label">Modifica punti</label>
            <div style="display: flex; gap: var(--spacing-2);">
              <input class="form__input" name="delta" type="number" step="1" placeholder="+/- punti" required style="flex: 1;">
              <button type="submit" class="btn btn--secondary btn--small">Applica</button>
            </div>
            <small class="form__hint">Punti attuali: <strong>{{ cliente.punti_fedelta or 0 }}</strong></small>
          </div>
        </form>

        <form class="form" method="post" action="{{ url_for('clienti.admin_set_note', cliente_id=cliente.id_cliente) }}" style="margin-top: var(--spacing-4);">
          <div class="form__group">
            <label class="form__label">Nota staff</label>
            <textarea class="form__textarea" name="nota_staff" rows="3" placeholder="Annotazioni visibili solo allo staff...">{{ cliente.nota_staff or '' }}</textarea>
            <small class="form__hint">Salvata per tutti gli operatori</small>
          </div>
          <div class="form__actions">
            <button type="submit" class="btn btn--ghost btn--small">Salva nota</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Storico Punti Fedelt√† -->
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Storico Punti Fedelt√†</h2>
      </div>
      <div class="card__content">
        {% if movimenti_fedelta %}
        <div class="table-responsive">
          <table class="table table--compact">
            <thead>
              <tr>
                <th>Data</th>
                <th>Evento</th>
                <th>Punti</th>
                <th>Motivo</th>
              </tr>
            </thead>
            <tbody>
              {% for mov, ev in movimenti_fedelta[:10] %}
              <tr>
                <td>{{ mov.data_assegnazione.strftime('%d/%m/%Y %H:%M') if mov.data_assegnazione else '‚Äî' }}</td>
                <td>{{ ev.nome_evento if ev else '‚Äî' }}</td>
                <td><strong class="text--gold">{{ mov.punti }}</strong></td>
                <td>{{ mov.motivo or '‚Äî' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if movimenti_fedelta|length > 10 %}
        <div style="margin-top: var(--spacing-3); text-align: center;">
          <span class="text--muted">Mostrati i primi 10 di {{ movimenti_fedelta|length }} movimenti</span>
        </div>
        {% endif %}
        {% else %}
        <div class="admin-empty-state">
          <span class="admin-empty-state__icon">‚≠ê</span>
          <p class="admin-empty-state__message">Nessun movimento fedelt√† registrato.</p>
        </div>
        {% endif %}
      </div>
    </section>
  </div>

  <!-- Timeline: Prenotazioni e Ingressi -->
  <div class="grid grid--2">
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Ultime Prenotazioni</h2>
        <a href="{{ url_for('prenotazioni.admin_list', cliente_id=cliente.id_cliente) }}" class="btn btn--ghost btn--small">Vedi tutte ‚Üí</a>
      </div>
      <div class="card__content">
        {% if ultime_prenotazioni %}
        <ul class="timeline-list">
          {% for pren, ev in ultime_prenotazioni[:5] %}
          <li class="timeline-item">
            <div class="timeline-item__header">
              <strong>{{ ev.nome_evento }}</strong>
              <span class="badge badge--{{ 'success' if pren.stato == 'attiva' else 'secondary' }}">{{ pren.stato|capitalize }}</span>
            </div>
            <div class="timeline-item__meta">
              {{ ev.data_evento.strftime('%d/%m/%Y') if ev.data_evento else 'Data da definire' }} ‚Ä¢ {{ pren.tipo|capitalize }}
              {% if pren.num_persone %} ‚Ä¢ {{ pren.num_persone }} pax{% endif %}
            </div>
            {% if pren.note %}
            <p class="timeline-item__note">{{ pren.note }}</p>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% if ultime_prenotazioni|length > 5 %}
        <div style="margin-top: var(--spacing-3); text-align: center;">
          <a href="{{ url_for('prenotazioni.admin_list', cliente_id=cliente.id_cliente) }}" class="btn btn--ghost btn--small">Vedi tutte ({{ ultime_prenotazioni|length }})</a>
        </div>
        {% endif %}
        {% else %}
        <div class="admin-empty-state">
          <span class="admin-empty-state__icon">üìã</span>
          <p class="admin-empty-state__message">Nessuna prenotazione recente.</p>
        </div>
        {% endif %}
      </div>
    </section>

    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Ultimi Ingressi</h2>
        <a href="{{ url_for('ingressi.admin_list', cliente_id=cliente.id_cliente) }}" class="btn btn--ghost btn--small">Vedi tutti ‚Üí</a>
      </div>
      <div class="card__content">
        {% if ultimi_ingressi %}
        <ul class="timeline-list">
          {% for ing, ev in ultimi_ingressi[:5] %}
          <li class="timeline-item">
            <div class="timeline-item__header">
              <strong>{{ ev.nome_evento }}</strong>
              <span class="badge badge--secondary">{{ ing.tipo_ingresso|capitalize }}</span>
            </div>
            <div class="timeline-item__meta">
              {{ ing.orario_ingresso.strftime('%d/%m/%Y %H:%M') if ing.orario_ingresso else '‚Äî' }}
            </div>
            {% if ing.note %}
            <p class="timeline-item__note">{{ ing.note }}</p>
            {% endif %}
          </li>
          {% endfor %}
        </ul>
        {% if ultimi_ingressi|length > 5 %}
        <div style="margin-top: var(--spacing-3); text-align: center;">
          <a href="{{ url_for('ingressi.admin_list', cliente_id=cliente.id_cliente) }}" class="btn btn--ghost btn--small">Vedi tutti ({{ ultimi_ingressi|length }})</a>
        </div>
        {% endif %}
        {% else %}
        <div class="admin-empty-state">
          <span class="admin-empty-state__icon">üö™</span>
          <p class="admin-empty-state__message">Nessun ingresso registrato.</p>
        </div>
        {% endif %}
      </div>
    </section>
  </div>

  <!-- Consumi Recenti -->
  <section class="card">
    <div class="card__header">
      <h2 class="card__title">Ultimi Consumi</h2>
      <a href="{{ url_for('consumi.admin_list', cliente_id=cliente.id_cliente) }}" class="btn btn--ghost btn--small">Vedi tutti ‚Üí</a>
    </div>
    <div class="card__content">
      {% if ultimi_consumi %}
      <div class="table-responsive">
        <table class="table table--compact">
          <thead>
            <tr>
              <th>Data</th>
              <th>Evento</th>
              <th>Prodotto</th>
              <th>Importo</th>
              <th>Punto vendita</th>
            </tr>
          </thead>
          <tbody>
            {% for cons, ev in ultimi_consumi[:10] %}
            <tr>
              <td>{{ cons.data_consumo.strftime('%d/%m/%Y %H:%M') if cons.data_consumo else '‚Äî' }}</td>
              <td>{{ ev.nome_evento if ev else '‚Äî' }}</td>
              <td>{{ cons.prodotto }}</td>
              <td><strong>‚Ç¨{{ "%.2f"|format(cons.importo) }}</strong></td>
              <td>{{ cons.punto_vendita|capitalize }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if ultimi_consumi|length > 10 %}
      <div style="margin-top: var(--spacing-3); text-align: center;">
        <a href="{{ url_for('consumi.admin_list', cliente_id=cliente.id_cliente) }}" class="btn btn--ghost btn--small">Vedi tutti ({{ ultimi_consumi|length }})</a>
      </div>
      {% endif %}
      {% else %}
      <div class="admin-empty-state">
        <span class="admin-empty-state__icon">üí∞</span>
        <p class="admin-empty-state__message">Nessun consumo registrato.</p>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Feedback -->
  {% if feedback_list %}
  <section class="card">
    <div class="card__header">
      <h2 class="card__title">Feedback degli Eventi</h2>
    </div>
    <div class="card__content">
      <div style="display: flex; flex-direction: column; gap: var(--spacing-3);">
        {% for fb, ev in feedback_list %}
        <div class="card" style="margin-bottom: 0; background: rgba(255,255,255,0.03);">
          <div class="card__header">
            <div>
              <strong>{{ ev.nome_evento }}</strong>
              <p class="card__meta" style="margin: 0;">{{ fb.data_feedback.strftime('%d/%m/%Y %H:%M') if fb.data_feedback else '‚Äî' }}</p>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-2);">
              <span class="badge badge--primary">Musica: {{ fb.voto_musica }}</span>
              <span class="badge badge--primary">Ingresso: {{ fb.voto_ingresso }}</span>
              <span class="badge badge--primary">Ambiente: {{ fb.voto_ambiente }}</span>
              <span class="badge badge--primary">Servizio: {{ fb.voto_servizio }}</span>
            </div>
          </div>
          {% if fb.note %}
          <div class="card__content">
            <p class="text--muted" style="margin: 0;">{{ fb.note }}</p>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- Promozioni -->
  <section class="card">
    <div class="card__header">
      <h2 class="card__title">Promozioni</h2>
    </div>
    <div class="card__content">
      {% if promozioni_disponibili %}
      <form method="post" id="assign-promo-form" class="form" style="margin-bottom: var(--spacing-4);">
        <div class="form__group">
          <label class="form__label">Assegna promozione</label>
          <div style="display: flex; gap: var(--spacing-2);">
            <select name="promozione_id" id="promozione-select" class="form__select" required style="flex: 1;">
              <option value="">Seleziona promozione‚Ä¶</option>
              {% for prom in promozioni_disponibili %}
              <option value="{{ prom.id_promozione }}" data-url="{{ url_for('promozioni.admin_assign', cliente_id=cliente.id_cliente, promozione_id=prom.id_promozione) }}">
                {{ prom.nome }} ({{ prom.tipo|replace('_',' ')|title }})
              </option>
              {% endfor %}
            </select>
            <button type="submit" class="btn btn--primary btn--small">Assegna</button>
          </div>
        </div>
      </form>
      {% endif %}

      {% if promozioni_cliente %}
      <div class="table-responsive">
        <table class="table table--compact">
          <thead>
            <tr>
              <th>Promozione</th>
              <th>Tipo</th>
              <th>Valore</th>
              <th>Assegnata</th>
              <th>Scadenza</th>
              <th>Stato</th>
              <th class="table__header--actions">Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for cp, prom in promozioni_cliente %}
            <tr>
              <td>
                <strong>{{ prom.nome }}</strong>
                {% if prom.descrizione %}
                <br><small class="text--muted">{{ prom.descrizione }}</small>
                {% endif %}
              </td>
              <td>{{ prom.tipo|replace('_',' ')|title }}</td>
              <td>
                {% if prom.valore %}
                  {% if prom.tipo == 'sconto_percentuale' %}
                    {{ prom.valore }}%
                  {% else %}
                    ‚Ç¨{{ "%.2f"|format(prom.valore) }}
                  {% endif %}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
              <td>{{ cp.data_assegnazione.strftime('%d/%m/%Y') if cp.data_assegnazione else '‚Äî' }}</td>
              <td>{{ cp.data_scadenza.strftime('%d/%m/%Y') if cp.data_scadenza else '‚Äî' }}</td>
              <td>
                {% if cp.usata %}
                <span class="badge badge--secondary">Usata</span>
                {% elif cp.data_scadenza and cp.data_scadenza < oggi %}
                <span class="badge badge--secondary">Scaduta</span>
                {% else %}
                <span class="badge badge--success">Attiva</span>
                {% endif %}
              </td>
              <td class="table__cell--actions">
                {% if not cp.usata %}
                <form method="post" action="{{ url_for('promozioni.admin_unassign', cliente_id=cliente.id_cliente, promozione_id=prom.id_promozione) }}" 
                      onsubmit="return confirm('Rimuovere questa promozione?');" style="display: inline;">
                  <button class="btn btn--ghost btn--small" type="submit">Rimuovi</button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="admin-empty-state">
        <span class="admin-empty-state__icon">üéÅ</span>
        <p class="admin-empty-state__message">Nessuna promozione attiva per questo cliente.</p>
      </div>
      {% endif %}
    </div>
  </section>
</div>

<script>
  const promoForm = document.getElementById('assign-promo-form');
  if (promoForm) {
    promoForm.addEventListener('submit', function (event) {
      const select = document.getElementById('promozione-select');
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption && selectedOption.value) {
        this.action = selectedOption.getAttribute('data-url');
      } else {
        event.preventDefault();
        alert('Seleziona una promozione');
      }
    });
  }
</script>
{% endblock %}
