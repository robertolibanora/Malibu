{% extends "admin/base.html" %}
{% block admin_title %}Evento Attivo{% endblock %}

{% block admin_content %}
<section class="card" style="margin-bottom: 2rem;">
  <div class="card__header">
    <div>
      <h1 class="card__title">Gestione evento attivo</h1>
      <p class="card__meta">Lo staff utilizzerà questo evento per ingressi, consumi e dashboard live.</p>
    </div>
    <div class="card__actions" style="display:flex; gap:0.75rem; flex-wrap:wrap;">
      <a href="{{ url_for('eventi.admin_menu') }}" class="btn btn--ghost">← Menu eventi</a>
      <a href="{{ url_for('staff.home') }}" class="btn btn--secondary">Vai alla home staff</a>
    </div>
  </div>
  {% if evento_attivo %}
    <div class="banner banner--success" style="margin-top: 1rem;">
      <div style="display:flex;flex-direction:column;gap:0.25rem;">
        <strong>Evento operativo corrente</strong>
        <span>{{ evento_attivo.data_evento.strftime('%d/%m/%Y') }} • {{ evento_attivo.nome_evento }}</span>
        <span class="text--muted">
          Stato pubblico: {{ evento_attivo.stato_pubblico|capitalize }}{% if evento_attivo.stato_pubblico != 'attivo' %} (lo staff può operare solo su eventi <em>attivi</em>){% endif %}
        </span>
      </div>
    </div>
  {% else %}
    <div class="banner banner--warning" style="margin-top: 1rem;">
      Nessun evento operativo impostato. Lo staff non potrà registrare ingressi o consumi finché non ne selezioni uno.
    </div>
  {% endif %}
</section>

<section class="card">
  <h2 class="card__title">Seleziona evento</h2>
  <form class="form" method="post">
    <div class="list">
      {% for e in eventi %}
      <label class="list__item" style="display:flex;gap:12px;align-items:flex-start;">
        <input type="radio" name="evento_id" value="{{ e.id_evento }}" {% if evento_attivo and evento_attivo.id_evento == e.id_evento %}checked{% endif %}>
        <div>
          <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
            <strong>{{ e.nome_evento }}</strong>
            <span class="badge badge--{{ 'success' if e.stato_pubblico == 'attivo' else 'secondary' }}">{{ e.stato_pubblico|capitalize }}</span>
            {% if e.is_staff_operativo and (not evento_attivo or evento_attivo.id_evento == e.id_evento) %}
            <span class="badge badge--success" style="background: rgba(212,175,55,0.15); color: var(--gold-primary); border: 1px solid rgba(212,175,55,0.35);">
              Attuale operativo
            </span>
            {% endif %}
          </div>
          <div class="text--muted">{{ e.data_evento.strftime('%d/%m/%Y') }} • {{ e.tipo_musica or e.categoria }}</div>
          {% if e.capienza_max %}
          <small class="text--muted">Capienza {{ e.capienza_max }} • Ingressi registrati {{ ingressi_map.get(e.id_evento, 0) if ingressi_map else '0' }}</small>
          {% endif %}
        </div>
      </label>
      {% else %}
      <p class="text--muted">Nessun evento futuro disponibile.</p>
      {% endfor %}
    </div>
    <div class="form__actions" style="margin-top:1.5rem;">
      <button class="btn btn--primary" type="submit">Imposta evento</button>
      <button class="btn btn--ghost" name="evento_id" value="clear" type="submit">Azzera evento attivo</button>
    </div>
    <small class="text--muted">Suggerimento: scegli eventi con stato pubblico “attivo” per consentire allo staff di lavorare da mobile.</small>
  </form>
</section>
{% endblock %}