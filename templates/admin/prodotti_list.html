{% extends "admin/base.html" %}
{% block admin_title %}Listino Prodotti{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}
{% from "admin/_secondary_nav.html" import render_secondary_nav %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_secondary_nav([
    {'url': url_for('staff_admin.admin_hub'), 'endpoint': 'staff_admin.admin_hub', 'label': 'Hub Impostazioni', 'icon': None},
    {'url': url_for('staff_admin.admin_list'), 'endpoint': 'staff_admin.admin_list', 'label': 'Staff', 'icon': None},
    {'url': url_for('prodotti.admin_list'), 'endpoint': 'prodotti.admin_list', 'label': 'Prodotti', 'icon': None},
    {'url': url_for('fedelta.admin_soglie'), 'endpoint': 'fedelta.admin_soglie', 'label': 'Soglie', 'icon': None},
    {'url': url_for('log.list'), 'endpoint': 'log.list', 'label': 'Log', 'icon': None},
  ], current_endpoint=request.endpoint) }}

  {{ render_page_header(
    title="Listino Prodotti",
    subtitle="Gestisci disponibilit√†, prezzi e categorie per lo staff operativo",
    actions=[
      {'type': 'link', 'url': url_for('prodotti.admin_new'), 'label': '+ Nuovo prodotto', 'class': 'btn--primary'}
    ],
    breadcrumbs=[
      {'label': 'Configurazione', 'url': url_for('staff_admin.admin_hub')},
      {'label': 'Prodotti'}
    ]
  ) }}

  <!-- Filtri -->
  <section class="card">
    <form method="get" class="form__actions" style="border-top: none; padding-top: 0; margin-top: 0;">
      <div class="form__group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
        <label class="form__label">Categoria</label>
        <input type="text" name="categoria" value="{{ filtro.categoria }}" placeholder="Es. Drink, Priv√©" class="form__input">
      </div>
      {% if filtro.categoria %}
      <div class="form__group" style="margin-bottom: 0;">
        <a class="btn btn--ghost" href="{{ url_for('prodotti.admin_list') }}">Reset</a>
      </div>
      {% endif %}
      <div class="form__group" style="margin-bottom: 0;">
        <button type="submit" class="btn btn--secondary">Filtra</button>
      </div>
    </form>
  </section>

  <!-- Lista Prodotti -->
  <section>
    {% if prodotti %}
    <div class="grid grid--auto">
      {% for p in prodotti %}
      <article class="card">
        <div class="card__header">
          <div>
            <h2 class="card__title">{{ p.nome }}</h2>
            <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-2); margin-top: var(--spacing-2);">
              {% if p.categoria %}
              <span class="badge badge--secondary">{{ p.categoria }}</span>
              {% endif %}
            </div>
          </div>
          <div style="font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); color: var(--admin-accent);">
            ‚Ç¨{{ "%.2f"|format(p.prezzo) }}
          </div>
        </div>
        {% if p.descrizione %}
        <div class="card__content">
          <p style="margin: 0; font-size: var(--font-size-sm); color: var(--admin-text);">{{ p.descrizione }}</p>
        </div>
        {% endif %}
        <div class="card__footer">
          <div style="display: flex; gap: var(--spacing-2);">
            <a href="{{ url_for('prodotti.admin_edit', prodotto_id=p.id_prodotto) }}" class="btn btn--primary btn--small">Modifica</a>
            <form method="post" action="{{ url_for('prodotti.admin_delete', prodotto_id=p.id_prodotto) }}" onsubmit="return confirm('Eliminare questo prodotto?');" style="display: inline;">
              <button class="btn btn--danger btn--small" type="submit">Elimina</button>
            </form>
          </div>
          <small class="text--muted" style="font-size: var(--font-size-xs); margin-top: var(--spacing-2); display: block;">
            Ricordati di aggiornare i prezzi quando pubblichi nuove promozioni.
          </small>
        </div>
      </article>
      {% endfor %}
    </div>
    {% else %}
    <div class="admin-empty-state">
      <span class="admin-empty-state__icon">üçπ</span>
      <p class="admin-empty-state__message">Il listino √® vuoto. Aggiungi i primi prodotti per renderli disponibili allo staff.</p>
    </div>
    {% endif %}
  </section>
</div>
{% endblock %}
