{% extends "admin/base.html" %}
{% block admin_title %}Dashboard{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}

{% set has_trend_data = (ingressi_trend_values|sum > 0) or (consumi_trend_values|sum > 0) %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_page_header(
    title="Dashboard Admin",
    subtitle="Panoramica ultimi " ~ range_days ~ " giorni Â· Aggiornato: " ~ ultimo_aggiornamento.strftime("%d/%m/%Y %H:%M"),
    actions=[
      {'type': 'link', 'url': url_for('eventi.admin_new'), 'label': '+ Nuovo Evento', 'class': 'btn--primary'}
    ],
    breadcrumbs=None
  ) }}

  <!-- Filtro Periodo -->
  <section class="card" style="margin-bottom: 2rem;">
    <form method="get" style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
      <label class="form__label" for="dashboard-range" style="margin: 0;">Periodo analisi:</label>
      <select id="dashboard-range" name="range" class="form__input" style="width: auto; min-width: 200px;" onchange="this.form.submit()">
        {% for option in range_options %}
        <option value="{{ option }}" {% if option == range_days %}selected{% endif %}>Ultimi {{ option }} giorni</option>
        {% endfor %}
      </select>
    </form>
  </section>

  <!-- Quick Actions -->
  <section class="card" style="margin-bottom: 2rem; border-left: 4px solid var(--gold-primary); background: linear-gradient(135deg, rgba(212, 175, 55, 0.05), rgba(212, 175, 55, 0.02));">
    <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0 0 1rem; color: var(--admin-accent);">âš¡ Accesso Rapido</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
      <a href="{{ url_for('eventi.admin_list') }}" class="admin-quick-link">
        <span class="admin-quick-link__icon">ğŸ“…</span>
        <span class="admin-quick-link__text">
          <strong>Eventi</strong>
          <small>Gestione eventi</small>
        </span>
      </a>
      <a href="{{ url_for('prenotazioni.admin_hub') }}" class="admin-quick-link">
        <span class="admin-quick-link__icon">ğŸ“‹</span>
        <span class="admin-quick-link__text">
          <strong>Operativo</strong>
          <small>Prenotazioni e ingressi</small>
        </span>
      </a>
      <a href="{{ url_for('clienti.admin_lista_clienti') }}" class="admin-quick-link">
        <span class="admin-quick-link__icon">ğŸ‘¥</span>
        <span class="admin-quick-link__text">
          <strong>Clienti</strong>
          <small>Anagrafica e fedeltÃ </small>
        </span>
      </a>
      <a href="{{ url_for('staff_admin.admin_hub') }}" class="admin-quick-link">
        <span class="admin-quick-link__icon">âš™ï¸</span>
        <span class="admin-quick-link__text">
          <strong>Configurazione</strong>
          <small>Impostazioni sistema</small>
        </span>
      </a>
    </div>
  </section>

  <style>
  .admin-quick-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-3);
    padding: var(--spacing-3) var(--spacing-4);
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(212, 175, 55, 0.1);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--admin-text);
    transition: all var(--transition-base);
  }
  
  .admin-quick-link:hover {
    background: rgba(212, 175, 55, 0.1);
    border-color: rgba(212, 175, 55, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
  }
  
  .admin-quick-link__icon {
    font-size: 2rem;
    flex-shrink: 0;
  }
  
  .admin-quick-link__text {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-1);
  }
  
  .admin-quick-link__text strong {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    color: var(--admin-text);
  }
  
  .admin-quick-link__text small {
    font-size: var(--font-size-xs);
    color: rgba(255, 255, 255, 0.5);
  }
  </style>

<!-- Statistiche Principali -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
  <!-- Clienti -->
  <div class="card" style="padding: 1.5rem; border-left: 4px solid var(--gold-primary);">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
      <div>
        <div class="text--muted" style="font-size: 0.85rem; margin-bottom: 0.25rem;">ğŸ‘¥ Clienti Totali</div>
        <div style="font-size: 2.5rem; font-weight: 700; color: var(--gold-primary);">{{ tot_clienti }}</div>
        <div class="text--muted" style="font-size: 0.85rem; margin-top: 0.25rem;">{{ clienti_attivi }} attivi</div>
      </div>
    </div>
    <div style="padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <div class="text--muted" style="font-size: 0.85rem;">Nuovi ({{ range_days }} gg)</div>
      <div style="font-size: 1.5rem; font-weight: 600; margin-top: 0.25rem;">{{ nuovi_clienti }}</div>
      {% if nuovi_clienti_delta_abs != 0 %}
      <div style="font-size: 0.75rem; margin-top: 0.25rem; color: {% if nuovi_clienti_delta_abs > 0 %}#10b981{% else %}#ef4444{% endif %};">
        {% if nuovi_clienti_delta_abs > 0 %}+{% endif %}{{ nuovi_clienti_delta_abs }}
        {% if nuovi_clienti_delta_pct is not none %} ({% if nuovi_clienti_delta_pct > 0 %}+{% endif %}{{ "%.1f"|format(nuovi_clienti_delta_pct|abs) }}%){% endif %}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Ingressi -->
  <div class="card" style="padding: 1.5rem; border-left: 4px solid #3b82f6;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
      <div>
        <div class="text--muted" style="font-size: 0.85rem; margin-bottom: 0.25rem;">ğŸšª Ingressi ({{ range_days }} gg)</div>
        <div style="font-size: 2.5rem; font-weight: 700; color: #3b82f6;">{{ ingressi_recenti }}</div>
      </div>
    </div>
    {% if ingressi_delta_abs != 0 %}
    <div style="padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <div style="font-size: 0.75rem; color: {% if ingressi_delta_abs > 0 %}#10b981{% else %}#ef4444{% endif %};">
        {% if ingressi_delta_abs > 0 %}+{% endif %}{{ ingressi_delta_abs }}
        {% if ingressi_delta_pct is not none %} ({% if ingressi_delta_pct > 0 %}+{% endif %}{{ "%.1f"|format(ingressi_delta_pct|abs) }}%){% endif %}
        <span class="text--muted">vs periodo precedente</span>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Consumi -->
  <div class="card" style="padding: 1.5rem; border-left: 4px solid #10b981;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
      <div>
        <div class="text--muted" style="font-size: 0.85rem; margin-bottom: 0.25rem;">ğŸ’° Consumi ({{ range_days }} gg)</div>
        <div style="font-size: 2.5rem; font-weight: 700; color: #10b981;">â‚¬{{ "%.0f"|format(consumi_recenti) }}</div>
      </div>
    </div>
    {% if consumi_delta_abs != 0 %}
    <div style="padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.1);">
      <div style="font-size: 0.75rem; color: {% if consumi_delta_abs > 0 %}#10b981{% else %}#ef4444{% endif %};">
        {% if consumi_delta_abs > 0 %}+{% endif %}â‚¬{{ "%.0f"|format(consumi_delta_abs|abs) }}
        {% if consumi_delta_pct is not none %} ({% if consumi_delta_pct > 0 %}+{% endif %}{{ "%.1f"|format(consumi_delta_pct|abs) }}%){% endif %}
        <span class="text--muted">vs periodo precedente</span>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Eventi -->
  <div class="card" style="padding: 1.5rem; border-left: 4px solid #8b5cf6;">
    <div class="text--muted" style="font-size: 0.85rem; margin-bottom: 0.25rem;">ğŸ“… Eventi</div>
    <div style="font-size: 2.5rem; font-weight: 700; color: #8b5cf6;">{{ eventi_attivi }}</div>
    <div class="text--muted" style="font-size: 0.85rem; margin-top: 0.25rem;">{{ tot_eventi }} totali</div>
  </div>

  <!-- Prenotazioni -->
  <div class="card" style="padding: 1.5rem; border-left: 4px solid #f59e0b;">
    <div class="text--muted" style="font-size: 0.85rem; margin-bottom: 0.25rem;">ğŸ“‹ Prenotazioni Attive</div>
    <div style="font-size: 2.5rem; font-weight: 700; color: #f59e0b;">{{ prenotazioni_attive }}</div>
    <div class="text--muted" style="font-size: 0.85rem; margin-top: 0.25rem;">Stato "attiva"</div>
  </div>
</div>

<!-- Prossimo Evento -->
{% if prossimo_evento %}
{% set is_staff_operativo = evento_operativo and evento_operativo.id_evento == prossimo_evento.id_evento %}
<section class="card" style="margin-bottom: 2rem; border-left: 4px solid {% if is_staff_operativo %}#10b981{% else %}#3b82f6{% endif %}; background: {% if is_staff_operativo %}linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%){% else %}rgba(59, 130, 246, 0.05){% endif %};">
  <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1.5rem;">
    <div style="flex: 1; min-width: 250px;">
      <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
        <span style="font-size: 1.25rem; font-weight: 600;">ğŸ“… Prossimo Evento</span>
        {% if giorni_al_prossimo_evento is not none %}
        <span class="badge" style="background: {% if giorni_al_prossimo_evento <= 0 %}#10b981{% elif giorni_al_prossimo_evento == 1 %}#f59e0b{% else %}#3b82f6{% endif %}; color: white;">
          {% if giorni_al_prossimo_evento <= 0 %}IN CORSO{% elif giorni_al_prossimo_evento == 1 %}DOMANI{% else %}TRA {{ giorni_al_prossimo_evento }} GIORNI{% endif %}
        </span>
        {% endif %}
        <span class="badge badge--secondary">{{ prossimo_evento.stato_pubblico|upper }}</span>
        {% if is_staff_operativo %}
        <span class="badge" style="background: #10b981; color: white;">ğŸŸ¢ OPERATIVO STAFF</span>
        {% endif %}
      </div>
      <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.75rem;">{{ prossimo_evento.nome_evento }}</h2>
      <p class="text--muted" style="margin: 0 0 0.5rem;">
        ğŸ“… {{ prossimo_evento.data_evento.strftime("%d/%m/%Y") if prossimo_evento.data_evento else "Data da definire" }}
        {% if prossimo_evento.dj_artista %} Â· ğŸ§ {{ prossimo_evento.dj_artista }}{% endif %}
        {% if prossimo_evento.categoria %} Â· {{ prossimo_evento.categoria|capitalize }}{% endif %}
      </p>
      {% if prossimo_evento.capienza_max %}
      <p class="text--muted" style="margin: 0;">ğŸ‘¥ Capienza: {{ prossimo_evento.capienza_max }}</p>
      {% endif %}
    </div>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
      {% if not is_staff_operativo %}
      <form method="post" action="{{ url_for('eventi.admin_evento_attivo') }}" style="display: inline;">
        <button type="submit" class="btn btn--primary btn--small" name="evento_id" value="{{ prossimo_evento.id_evento }}">
          ğŸŸ¢ Attiva Staff
        </button>
      </form>
      {% else %}
      <form method="post" action="{{ url_for('eventi.admin_evento_attivo') }}" style="display: inline;">
        <input type="hidden" name="evento_id" value="clear">
        <button type="submit" class="btn btn--ghost btn--small">ğŸ”´ Disattiva Staff</button>
      </form>
      {% endif %}
      <a href="{{ url_for('eventi.admin_evento_detail', evento_id=prossimo_evento.id_evento) }}" class="btn btn--secondary btn--small">
        ğŸ“Š Dashboard
      </a>
      <a href="{{ url_for('eventi.admin_edit', evento_id=prossimo_evento.id_evento) }}" class="btn btn--ghost btn--small">
        âœï¸ Modifica
      </a>
    </div>
  </div>

  {% if prossimo_evento_stats %}
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
    <div>
      <div class="text--muted" style="font-size: 0.85rem;">Prenotazioni</div>
      <div style="font-size: 1.5rem; font-weight: 600; margin-top: 0.25rem;">{{ prossimo_evento_stats.prenotazioni_totali }}</div>
      <div class="text--muted" style="font-size: 0.75rem; margin-top: 0.25rem;">{{ prossimo_evento_stats.prenotazioni_attive }} attive</div>
    </div>
    <div>
      <div class="text--muted" style="font-size: 0.85rem;">Ingressi</div>
      <div style="font-size: 1.5rem; font-weight: 600; margin-top: 0.25rem;">{{ prossimo_evento_stats.ingressi_totali }}</div>
      {% if prossimo_evento_stats.capienza %}
      <div class="text--muted" style="font-size: 0.75rem; margin-top: 0.25rem;">{{ prossimo_evento_stats.occupancy_pct }}% capienza</div>
      {% endif %}
    </div>
    <div>
      <div class="text--muted" style="font-size: 0.85rem;">Consumi</div>
      <div style="font-size: 1.5rem; font-weight: 600; margin-top: 0.25rem;">â‚¬{{ "%.0f"|format(prossimo_evento_stats.consumi_totali) }}</div>
    </div>
    {% if prossimo_evento_stats.feedback_samples > 0 %}
    <div>
      <div class="text--muted" style="font-size: 0.85rem;">Feedback</div>
      <div style="font-size: 1.5rem; font-weight: 600; margin-top: 0.25rem;">{{ "%.1f"|format(prossimo_evento_stats.feedback_media_generale) }}/10</div>
      <div class="text--muted" style="font-size: 0.75rem; margin-top: 0.25rem;">{{ prossimo_evento_stats.feedback_samples }} valutazioni</div>
    </div>
    {% endif %}
  </div>
  {% endif %}
</section>
{% endif %}

<!-- Grafici e Insights -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
  <!-- Trend Grafico -->
  <section class="card">
    <div style="margin-bottom: 1rem;">
      <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0 0 0.25rem;">ğŸ“ˆ Trend AttivitÃ </h2>
      <p class="text--muted" style="margin: 0; font-size: 0.85rem;">Ingressi e consumi giornalieri ({{ range_days }} gg)</p>
    </div>
    {% if has_trend_data %}
    <div style="height: 300px; position: relative;">
      <canvas id="dashboard-trend-chart"></canvas>
    </div>
    {% else %}
    <p class="text--muted" style="text-align: center; padding: 2rem;">Nessun dato disponibile nel periodo selezionato.</p>
    {% endif %}
  </section>

  <!-- Distribuzione Livelli -->
  <section class="card">
    <div style="margin-bottom: 1rem;">
      <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0 0 0.25rem;">â­ Distribuzione Livelli FedeltÃ </h2>
      <p class="text--muted" style="margin: 0; font-size: 0.85rem;">Ripartizione clienti per tier</p>
    </div>
    {% set totale_livelli = livelli_dist.values()|sum %}
    {% if totale_livelli %}
    <div style="display: flex; flex-direction: column; gap: 1rem;">
      {% for livello, count in livelli_dist.items() %}
      {% set percent = (count / totale_livelli * 100) %}
      <div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
          <span style="font-weight: 500;">{{ livello|capitalize }}</span>
          <span class="badge badge--secondary">{{ count }} ({{ "%.1f"|format(percent) }}%)</span>
        </div>
        <div style="background: rgba(255,255,255,0.1); border-radius: 999px; height: 8px; overflow: hidden;">
          <div style="width: {{ percent }}%; height: 100%; background: var(--gold-primary); transition: width 0.3s;"></div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text--muted" style="text-align: center; padding: 2rem;">Nessun cliente con livelli assegnati.</p>
    {% endif %}
  </section>
</div>

<!-- Feedback e Eventi Recenti -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
  <!-- Media Feedback -->
  <section class="card">
    <div style="margin-bottom: 1rem;">
      <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0 0 0.25rem;">ğŸ’¬ Media Feedback</h2>
      <p class="text--muted" style="margin: 0; font-size: 0.85rem;">Valutazione media su scala 1-10</p>
    </div>
    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
        <span>ğŸµ Musica</span>
        <span style="font-size: 1.25rem; font-weight: 600;">{{ avg_musica }}/10</span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
        <span>ğŸšª Ingresso</span>
        <span style="font-size: 1.25rem; font-weight: 600;">{{ avg_ingresso }}/10</span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
        <span>ğŸŒŸ Ambiente</span>
        <span style="font-size: 1.25rem; font-weight: 600;">{{ avg_ambiente }}/10</span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
        <span>ğŸ½ï¸ Servizio</span>
        <span style="font-size: 1.25rem; font-weight: 600;">{{ avg_servizio }}/10</span>
      </div>
    </div>
  </section>

  <!-- Eventi Recenti -->
  <section class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <div>
        <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0 0 0.25rem;">ğŸ“… Eventi Recenti</h2>
        <p class="text--muted" style="margin: 0; font-size: 0.85rem;">Ultimi 5 eventi</p>
      </div>
      <a href="{{ url_for('eventi.admin_menu') }}" class="btn btn--ghost btn--small">Vedi tutti â†’</a>
    </div>
    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
      {% for evento in eventi_recenti %}
      <div style="padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
          <strong style="font-size: 0.95rem;">{{ evento.nome_evento }}</strong>
          <span class="badge badge--secondary" style="font-size: 0.75rem;">{{ evento.stato_pubblico|upper }}</span>
        </div>
        <div class="text--muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">
          {{ evento.data_evento.strftime("%d/%m/%Y") if evento.data_evento else "Data da definire" }}
          {% if evento.categoria %} Â· {{ evento.categoria|capitalize }}{% endif %}
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <a href="{{ url_for('eventi.admin_edit', evento_id=evento.id_evento) }}" class="btn btn--ghost btn--small" style="font-size: 0.75rem;">âœï¸ Modifica</a>
          <a href="{{ url_for('eventi.admin_analytics', evento_id=evento.id_evento) }}" class="btn btn--ghost btn--small" style="font-size: 0.75rem;">ğŸ“Š Analytics</a>
        </div>
      </div>
      {% else %}
      <p class="text--muted" style="text-align: center; padding: 1rem;">Nessun evento recente.</p>
      {% endfor %}
    </div>
  </section>
</div>

<!-- Top Clienti -->
<section class="card">
  <div style="margin-bottom: 1rem;">
    <h2 style="font-size: 1.1rem; font-weight: 600; margin: 0 0 0.25rem;">ğŸ† Top 5 Clienti per Punti</h2>
    <p class="text--muted" style="margin: 0; font-size: 0.85rem;">Clienti piÃ¹ fidelizzati</p>
  </div>
  <div style="overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
          <th style="text-align: left; padding: 0.75rem; font-weight: 600; font-size: 0.85rem;">Cliente</th>
          <th style="text-align: right; padding: 0.75rem; font-weight: 600; font-size: 0.85rem;">Punti</th>
          <th style="text-align: left; padding: 0.75rem; font-weight: 600; font-size: 0.85rem;">Livello</th>
          <th style="text-align: right; padding: 0.75rem; font-weight: 600; font-size: 0.85rem;">Azioni</th>
        </tr>
      </thead>
      <tbody>
        {% for cliente, punti in top_clienti %}
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
          <td style="padding: 0.75rem;">{{ cliente.nome }} {{ cliente.cognome }}</td>
          <td style="text-align: right; padding: 0.75rem; font-weight: 600;">{{ punti or 0 }}</td>
          <td style="padding: 0.75rem;"><span class="badge badge--secondary">{{ cliente.livello|capitalize }}</span></td>
          <td style="text-align: right; padding: 0.75rem;">
            <a href="{{ url_for('clienti.admin_lista_clienti') }}#cliente-{{ cliente.id_cliente }}" class="btn btn--ghost btn--small">Vedi</a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="4" class="text--muted" style="text-align: center; padding: 2rem;">Nessun cliente con punti registrati.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if has_trend_data %}
  <script>
    (function() {
      const canvas = document.getElementById('dashboard-trend-chart');
      if (!canvas || typeof Chart === 'undefined') return;
      const ctx = canvas.getContext('2d');
      const labels = {{ trend_labels|tojson }};
      const ingressiData = {{ ingressi_trend_values|tojson }};
      const consumiData = {{ consumi_trend_values|tojson }};
      const gradient = ctx.createLinearGradient(0, 0, 0, 280);
      gradient.addColorStop(0, 'rgba(212, 175, 55, 0.35)');
      gradient.addColorStop(1, 'rgba(212, 175, 55, 0)');
      new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Ingressi',
              data: ingressiData,
              borderColor: 'rgba(59, 130, 246, 0.95)',
              backgroundColor: 'rgba(59, 130, 246, 0.12)',
              tension: 0.35,
              borderWidth: 2,
              pointRadius: 0,
              fill: true
            },
            {
              label: 'Consumi (â‚¬)',
              data: consumiData,
              borderColor: 'rgba(212, 175, 55, 0.95)',
              backgroundColor: gradient,
              tension: 0.35,
              borderWidth: 2,
              pointRadius: 0,
              fill: true,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              labels: {
                color: 'rgba(255, 255, 255, 0.85)',
                usePointStyle: true,
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: '#141414',
              borderColor: 'rgba(255, 255, 255, 0.08)',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: function(context) {
                  if (context.datasetIndex === 1) {
                    return `${context.dataset.label}: â‚¬${context.parsed.y.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                  }
                  return `${context.dataset.label}: ${context.parsed.y}`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: 'rgba(255, 255, 255, 0.6)', maxRotation: 0 }
            },
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255, 255, 255, 0.06)' },
              ticks: { color: 'rgba(255, 255, 255, 0.7)' }
            },
            y1: {
              beginAtZero: true,
              position: 'right',
              grid: { drawOnChartArea: false },
              ticks: {
                color: 'rgba(255, 255, 255, 0.7)',
                callback: function(value) {
                  return 'â‚¬' + value.toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                }
              }
            }
          }
        }
      });
    })();
  </script>
  {% endif %}
{% endblock %}
