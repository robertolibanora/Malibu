{% extends "admin/base.html" %}

{% block admin_title %}Intelligence operativa{% endblock %}

{% block admin_content %}
<div class="analytics">
  <div class="analytics__header fade-in">
    <div class="analytics__intro">
      <h1 class="analytics__title">Intelligence Operativa</h1>
      <p class="analytics__subtitle">
        Analisi ultimi {{ range_days }} giorni · aggiornato il {{ analytics_generated_at.strftime("%d/%m/%Y %H:%M") }}
      </p>
      <div class="analytics__meta">
        <span>Ingressi storici: <strong>{{ tot_ingressi }}</strong></span>
        <span>Consumi storici: <strong>€{{ "%.2f"|format(tot_consumi) }}</strong></span>
        <span>Prenotazioni gestite: <strong>{{ tot_prenotazioni }}</strong></span>
      </div>
    </div>
    <form class="analytics__range" method="get" aria-label="Filtra periodo di analisi">
      <label for="analytics-range" class="analytics__range-label">Periodo</label>
      <select id="analytics-range" name="range" class="form__select form__select--dense" onchange="this.form.submit()">
        {% for option in range_options %}
        <option value="{{ option }}" {% if option == range_days %}selected{% endif %}>
          Ultimi {{ option }} giorni
        </option>
        {% endfor %}
      </select>
    </form>
      </div>

  <div class="analytics__summary">
    <article class="insight-card fade-in">
      <span class="insight-card__label">Ingressi periodo</span>
      <span class="insight-card__value">{{ ingressi_range }}</span>
      {% set ingressi_trend_class = 'insight-card__trend--neutral' %}
      {% if ingressi_delta_abs > 0 %}
        {% set ingressi_trend_class = 'insight-card__trend--up' %}
      {% elif ingressi_delta_abs < 0 %}
        {% set ingressi_trend_class = 'insight-card__trend--down' %}
      {% endif %}
      <div class="insight-card__trend {{ ingressi_trend_class }}">
        <span class="insight-card__trend-abs">
          {% if ingressi_delta_abs > 0 %}+{% elif ingressi_delta_abs < 0 %}-{% endif %}
          {{ ingressi_delta_abs|abs }}
        </span>
        {% if ingressi_delta_pct is not none %}
        <span class="insight-card__trend-pct">
          {% if ingressi_delta_pct > 0 %}+{% elif ingressi_delta_pct < 0 %}-{% endif %}
          {{ "%.1f"|format(ingressi_delta_pct|abs) }}%
        </span>
        <span class="insight-card__trend-note">vs periodo precedente</span>
        {% else %}
        <span class="insight-card__trend-note">
          {% if ingressi_delta_abs > 0 %}Nuovo picco{% elif ingressi_delta_abs < 0 %}In calo{% else %}Stabile{% endif %}
        </span>
        {% endif %}
      </div>
        </article>

    <article class="insight-card fade-in" style="animation-delay: 80ms;">
      <span class="insight-card__label">Ricavi periodo</span>
      <span class="insight-card__value">€{{ "%.2f"|format(consumi_range) }}</span>
      {% set consumi_trend_class = 'insight-card__trend--neutral' %}
      {% if consumi_delta_abs > 0 %}
        {% set consumi_trend_class = 'insight-card__trend--up' %}
      {% elif consumi_delta_abs < 0 %}
        {% set consumi_trend_class = 'insight-card__trend--down' %}
      {% endif %}
      <div class="insight-card__trend {{ consumi_trend_class }}">
        <span class="insight-card__trend-abs">
          {% if consumi_delta_abs > 0 %}+{% elif consumi_delta_abs < 0 %}-{% endif %}
          €{{ "%.2f"|format(consumi_delta_abs|abs) }}
        </span>
        {% if consumi_delta_pct is not none %}
        <span class="insight-card__trend-pct">
          {% if consumi_delta_pct > 0 %}+{% elif consumi_delta_pct < 0 %}-{% endif %}
          {{ "%.1f"|format(consumi_delta_pct|abs) }}%
        </span>
        <span class="insight-card__trend-note">vs periodo precedente</span>
        {% else %}
        <span class="insight-card__trend-note">
          {% if consumi_delta_abs > 0 %}Nuovo picco{% elif consumi_delta_abs < 0 %}In calo{% else %}Stabile{% endif %}
        </span>
        {% endif %}
      </div>
        </article>

    <article class="insight-card fade-in" style="animation-delay: 160ms;">
      <span class="insight-card__label">Feedback raccolti</span>
      <span class="insight-card__value">{{ feedback_range_count }}</span>
      <span class="insight-card__meta">
        Media complessiva: {{ feedback_range_avg if feedback_range_avg is not none else "—" }}
      </span>
      {% set feedback_trend_class = 'insight-card__trend--neutral' %}
      {% if feedback_delta_abs > 0 %}
        {% set feedback_trend_class = 'insight-card__trend--up' %}
      {% elif feedback_delta_abs < 0 %}
        {% set feedback_trend_class = 'insight-card__trend--down' %}
      {% endif %}
      <div class="insight-card__trend {{ feedback_trend_class }}">
        <span class="insight-card__trend-abs">
          {% if feedback_delta_abs > 0 %}+{% elif feedback_delta_abs < 0 %}-{% endif %}
          {{ feedback_delta_abs|abs }}
        </span>
        {% if feedback_delta_pct is not none %}
        <span class="insight-card__trend-pct">
          {% if feedback_delta_pct > 0 %}+{% elif feedback_delta_pct < 0 %}-{% endif %}
          {{ "%.1f"|format(feedback_delta_pct|abs) }}%
        </span>
        <span class="insight-card__trend-note">vs periodo precedente</span>
        {% else %}
        <span class="insight-card__trend-note">
          {% if feedback_delta_abs > 0 %}Maggiore coinvolgimento{% elif feedback_delta_abs < 0 %}Da attenzionare{% else %}Stabile{% endif %}
        </span>
        {% endif %}
      </div>
        </article>

    <article class="insight-card fade-in" style="animation-delay: 240ms;">
      <span class="insight-card__label">Valutazione storica</span>
          {% if feedback_global %}
      <span class="insight-card__value">{{ "%.1f"|format(feedback_global.average) }}</span>
      <span class="insight-card__meta">{{ feedback_global.samples }} feedback complessivi</span>
          {% else %}
      <span class="insight-card__value">—</span>
      <span class="insight-card__meta">In attesa di feedback</span>
          {% endif %}
        </article>
  </div>

  {% if top_ingressi_event or top_ricavi_event or top_feedback_event or top_prodotto %}
  <section class="analytics__highlights fade-in" style="animation-delay: 320ms;">
    {% if top_ingressi_event %}
    <article class="highlight-card">
      <span class="highlight-card__label">Evento più partecipato</span>
      <h3 class="highlight-card__title">{{ top_ingressi_event.label }}</h3>
      <div class="highlight-card__metrics">
        <span class="highlight-card__value">{{ top_ingressi_event.count }}</span>
        <span class="highlight-card__meta">Ingressi registrati</span>
      </div>
      <span class="pill pill--ghost">Categoria {{ top_ingressi_event.categoria|capitalize }}</span>
    </article>
    {% endif %}

    {% if top_ricavi_event %}
    <article class="highlight-card">
      <span class="highlight-card__label">Evento con più ricavi</span>
      <h3 class="highlight-card__title">{{ top_ricavi_event.label }}</h3>
      <div class="highlight-card__metrics">
        <span class="highlight-card__value">€{{ "%.2f"|format(top_ricavi_event.value) }}</span>
        <span class="highlight-card__meta">Ricavi generati</span>
      </div>
      <span class="pill pill--outline">Categoria {{ top_ricavi_event.categoria|capitalize }}</span>
    </article>
    {% endif %}

    {% if top_feedback_event %}
    <article class="highlight-card">
      <span class="highlight-card__label">Miglior feedback</span>
      <h3 class="highlight-card__title">{{ top_feedback_event.label }}</h3>
      <div class="highlight-card__metrics">
        <span class="highlight-card__value">{{ "%.2f"|format(top_feedback_event.overall) }}/10</span>
        <span class="highlight-card__meta">{{ top_feedback_event.samples }} feedback</span>
      </div>
      <span class="pill pill--ghost">Categoria {{ top_feedback_event.categoria|capitalize }}</span>
    </article>
    {% endif %}

    {% if top_prodotto %}
    <article class="highlight-card">
      <span class="highlight-card__label">Prodotto top</span>
      <h3 class="highlight-card__title">{{ top_prodotto.label }}</h3>
      <div class="highlight-card__metrics highlight-card__metrics--split">
        <div>
          <span class="highlight-card__value">{{ top_prodotto.count }}</span>
          <span class="highlight-card__meta">Vendite</span>
        </div>
        <div>
          <span class="highlight-card__value">€{{ "%.2f"|format(top_prodotto.revenue) }}</span>
          <span class="highlight-card__meta">Ricavi</span>
      </div>
    </div>
    </article>
    {% endif %}
  </section>
  {% endif %}

  <section class="analytics__grid">
    <article class="chart-card chart-card--full">
      <div class="chart-card__header">
        <h2 class="chart-card__title">Ingressi per evento (top <span id="labelIngressiLimite">10</span>)</h2>
        <div class="chart-controls">
          <label class="chart-label" for="filterIngressiCategoria">Categoria</label>
          <select id="filterIngressiCategoria" class="chart-select">
            <option value="__all">Tutte</option>
          {% for categoria in event_categories %}
              <option value="{{ categoria }}">{{ categoria|capitalize }}</option>
            {% endfor %}
          </select>
          <label class="chart-label" for="filterIngressiLimite">Top</label>
          <select id="filterIngressiLimite" class="chart-select">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>
      <canvas id="chartIngressiPerEvento"></canvas>
      <p class="chart-card__empty">Non ci sono ingressi sufficienti per mostrare il grafico.</p>
    </article>

    <article class="chart-card chart-card--wide">
      <div class="chart-card__header">
        <h2 class="chart-card__title">Flusso ingressi ultimi <span id="labelIngressiPeriodo">{{ range_days }}</span> giorni</h2>
        <div class="chart-controls">
          <label class="chart-label" for="filterIngressiPeriodo">Periodo</label>
          <select id="filterIngressiPeriodo" class="chart-select">
            <option value="7">7 gg</option>
            <option value="14">14 gg</option>
            <option value="30" selected>30 gg</option>
            <option value="60">60 gg</option>
            <option value="90">90 gg</option>
            <option value="120">120 gg</option>
          </select>
          <label class="chart-label" for="filterIngressiTipoGrafico">Visualizzazione</label>
          <select id="filterIngressiTipoGrafico" class="chart-select">
            <option value="line">Linea</option>
            <option value="bar">Barre</option>
          </select>
        </div>
      </div>
      <canvas id="chartIngressiTemporali"></canvas>
      <p class="chart-card__empty">Nessun ingresso registrato nel periodo selezionato.</p>
    </article>

    <article class="chart-card chart-card--tall">
      <div class="chart-card__header">
        <h2 class="chart-card__title">Prenotazioni per tipologia</h2>
        <div class="chart-controls" id="filterPrenotazioniContainer">
          {% for item in prenotazioni_per_tipo['items'] %}
            <label class="chart-checkbox">
              <input type="checkbox" class="filter-prenotazioni" data-label="{{ item.label }}" checked>
              {{ item.label|capitalize }}
            </label>
          {% endfor %}
        </div>
      </div>
      <canvas id="chartPrenotazioni"></canvas>
      <p class="chart-card__empty">Nessuna prenotazione registrata.</p>
    </article>

    <article class="chart-card chart-card--wide">
      <div class="chart-card__header">
        <h2 class="chart-card__title">Prodotti più venduti</h2>
        <div class="chart-controls">
          <label class="chart-label" for="filterProdottiMetric">Metrica</label>
          <select id="filterProdottiMetric" class="chart-select">
            <option value="count">Quantità</option>
            <option value="revenue">Ricavi</option>
            <option value="both" selected>Entrambi</option>
          </select>
          <label class="chart-label" for="filterProdottiLimite">Top</label>
          <select id="filterProdottiLimite" class="chart-select">
            <option value="5" selected>5</option>
            <option value="10">10</option>
          </select>
        </div>
      </div>
      <canvas id="chartProdotti"></canvas>
      <p class="chart-card__empty">Non risultano consumi registrati.</p>
    </article>

    <article class="chart-card chart-card--tall">
      <div class="chart-card__header">
        <h2 class="chart-card__title">Valutazione media per evento</h2>
        <div class="chart-controls">
          <label class="chart-label" for="filterFeedbackCategoria">Categoria</label>
          <select id="filterFeedbackCategoria" class="chart-select">
            <option value="__all">Tutte</option>
            {% for categoria in event_categories %}
              <option value="{{ categoria }}">{{ categoria|capitalize }}</option>
            {% endfor %}
          </select>
          <div class="chart-range-wrapper">
            <label class="chart-label" for="filterFeedbackMin">Feedback minimi</label>
            {% set max_feedback = feedback_per_evento.max_samples if feedback_per_evento.max_samples > 0 else 1 %}
            <input type="range" id="filterFeedbackMin" class="chart-range" min="0" max="{{ max_feedback }}" value="0">
            <span class="chart-range-output" id="filterFeedbackMinValue">0</span>
          </div>
        </div>
      </div>
      <canvas id="chartFeedbackEvento"></canvas>
      <p class="chart-card__empty">Nessun feedback disponibile.</p>
    </article>

    <article class="chart-card chart-card--full">
      <div class="chart-card__header">
        <h2 class="chart-card__title">Ricavi per evento (top <span id="labelRicaviLimite">10</span>)</h2>
        <div class="chart-controls">
          <label class="chart-label" for="filterRicaviCategoria">Categoria</label>
          <select id="filterRicaviCategoria" class="chart-select">
            <option value="__all">Tutte</option>
            {% for categoria in event_categories %}
              <option value="{{ categoria }}">{{ categoria|capitalize }}</option>
            {% endfor %}
          </select>
          <label class="chart-label" for="filterRicaviLimite">Top</label>
          <select id="filterRicaviLimite" class="chart-select">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>
      <canvas id="chartRicaviEvento"></canvas>
      <p class="chart-card__empty">Non risultano ricavi associati agli eventi.</p>
    </article>
  </section>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const GOLD = 'var(--admin-accent)';
    const GOLD_LIGHT = 'rgba(212, 175, 55, 0.25)';
    const GOLD_DARK = '#a37c00';
    const GOLD_PALETTE = ['var(--admin-accent)', '#f7d774', '#b8922b', '#ffe8a6', '#a37c00', '#c9aa43', '#8c6c00'];

    const charts = {};

    const ingressiPerEventoData = {{ ingressi_per_evento | tojson }};
    const ingressiTemporaliData = {{ ingressi_temporali | tojson }};
    const prodottiTopData = {{ prodotti_top | tojson }};
    const prenotazioniPerTipoData = {{ prenotazioni_per_tipo | tojson }};
    const feedbackPerEventoData = {{ feedback_per_evento | tojson }};
    const ricaviPerEventoData = {{ ricavi_per_evento | tojson }};

    function renderChart(canvasId, buildConfig) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const card = canvas.closest('.chart-card');
      const emptyMessage = card ? card.querySelector('.chart-card__empty') : null;

      if (typeof Chart === 'undefined') {
        canvas.style.display = 'none';
        if (emptyMessage) {
          emptyMessage.textContent = 'Impossibile caricare i grafici: libreria Chart.js non disponibile.';
          emptyMessage.style.display = 'block';
        }
        return;
      }

      const config = buildConfig();
      const datasets = (config && config.data && config.data.datasets) ? config.data.datasets : [];
      const labels = (config && config.data && config.data.labels) ? config.data.labels : [];
      const values = [];

      datasets.forEach(dataset => {
        (dataset.data || []).forEach(value => {
          const parsed = Number(value);
          if (!Number.isNaN(parsed)) values.push(parsed);
        });
      });

      const hasData = labels.length > 0 && values.some(val => val > 0);

      if (!hasData) {
        canvas.style.display = 'none';
        if (emptyMessage) emptyMessage.style.display = 'block';
        if (charts[canvasId]) {
          charts[canvasId].destroy();
          delete charts[canvasId];
        }
        return;
      }

      canvas.style.display = 'block';
      if (emptyMessage) emptyMessage.style.display = 'none';

      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      charts[canvasId] = new Chart(canvas, config);
    }

    function updateIngressiChart() {
      const categoria = document.getElementById('filterIngressiCategoria')?.value || '__all';
      const limite = parseInt(document.getElementById('filterIngressiLimite')?.value || '10', 10);
      const labelTarget = document.getElementById('labelIngressiLimite');
      if (labelTarget) labelTarget.textContent = limite;

      const filtered = (ingressiPerEventoData.items || [])
        .filter(item => categoria === '__all' || item.categoria === categoria)
        .sort((a, b) => b.count - a.count)
        .slice(0, limite);

      renderChart('chartIngressiPerEvento', () => ({
        type: 'bar',
        data: {
          labels: filtered.map(item => item.label),
          datasets: [{
            label: 'Ingressi',
            data: filtered.map(item => item.count),
            backgroundColor: GOLD,
            borderRadius: 10,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0, color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.08)' },
            },
            x: { grid: { display: false }, ticks: { color: '#ffffff' } },
          },
          plugins: { legend: { display: false } },
        },
      }));
    }

    function updateIngressiTemporaliChart() {
      const periodoSelect = document.getElementById('filterIngressiPeriodo');
      const tipoGraficoSelect = document.getElementById('filterIngressiTipoGrafico');
      const labelTarget = document.getElementById('labelIngressiPeriodo');

      const periodo = parseInt(periodoSelect?.value || ingressiTemporaliData.default_range_days || 30, 10);
      if (labelTarget) labelTarget.textContent = periodo;
      const tipoGrafico = tipoGraficoSelect?.value || 'line';

      const points = (ingressiTemporaliData.points || []);
      const sliced = periodo >= points.length ? points : points.slice(points.length - periodo);

      const dataset = {
        label: `Ingressi (${tipoGrafico === 'line' ? 'linea' : 'barre'})`,
        data: sliced.map(point => point.value),
      };

      if (tipoGrafico === 'line') {
        dataset.fill = true;
        dataset.borderColor = GOLD;
        dataset.backgroundColor = GOLD_LIGHT;
        dataset.tension = 0.35;
        dataset.pointRadius = 3;
      } else {
        dataset.backgroundColor = GOLD;
        dataset.borderRadius = 8;
      }

      renderChart('chartIngressiTemporali', () => ({
        type: tipoGrafico,
        data: {
          labels: sliced.map(point => point.label),
          datasets: [dataset],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0, color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.08)' },
            },
            x: { ticks: { color: '#ffffff' }, grid: { color: 'rgba(255,255,255,0.05)' } },
          },
          plugins: { legend: { display: false } },
        },
      }));
    }

    function updatePrenotazioniChart() {
      const checkboxes = document.querySelectorAll('.filter-prenotazioni');
      const activeLabels = [];
      checkboxes.forEach(cb => {
        if (cb.checked) activeLabels.push(cb.dataset.label);
      });

      const filtered = (prenotazioniPerTipoData.items || [])
        .filter(item => activeLabels.includes(item.label));

      renderChart('chartPrenotazioni', () => ({
        type: 'doughnut',
        data: {
          labels: filtered.map(item => item.label),
          datasets: [{
            data: filtered.map(item => item.value),
            backgroundColor: GOLD_PALETTE.slice(0, Math.max(filtered.length, 1)),
            borderWidth: 0,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#ffffff' },
            },
          },
        },
      }));
    }

    function updateProdottiChart() {
      const metric = document.getElementById('filterProdottiMetric')?.value || 'both';
      const limite = parseInt(document.getElementById('filterProdottiLimite')?.value || '5', 10);

      const items = (prodottiTopData.items || []).slice().sort((a, b) => b.count - a.count);
      const selected = items.slice(0, limite);

      const datasets = [];
      if (metric === 'count' || metric === 'both') {
        datasets.push({
          label: 'Quantità',
          data: selected.map(item => item.count),
          backgroundColor: GOLD,
          borderRadius: 10,
        });
      }
      if (metric === 'revenue' || metric === 'both') {
        datasets.push({
          label: 'Ricavi (€)',
          data: selected.map(item => Number(item.revenue || 0)),
          backgroundColor: GOLD_DARK,
          borderRadius: 10,
        });
      }

      renderChart('chartProdotti', () => ({
        type: 'bar',
        data: {
          labels: selected.map(item => item.label),
          datasets,
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.08)' },
            },
            x: { ticks: { color: '#ffffff' }, grid: { display: false } },
          },
          plugins: {
            legend: {
              labels: { color: '#ffffff' },
            },
          },
        },
      }));
    }

    function updateFeedbackChart() {
      const categoria = document.getElementById('filterFeedbackCategoria')?.value || '__all';
      const slider = document.getElementById('filterFeedbackMin');
      const minValue = parseInt(slider?.value || '0', 10);
      const output = document.getElementById('filterFeedbackMinValue');
      if (output) output.textContent = minValue;

      const filtered = (feedbackPerEventoData.items || [])
        .filter(item => item.samples >= minValue)
        .filter(item => categoria === '__all' || item.categoria === categoria)
        .sort((a, b) => b.overall - a.overall);

      renderChart('chartFeedbackEvento', () => ({
        type: 'bar',
        data: {
          labels: filtered.map(item => item.label),
          datasets: [{
            label: 'Valutazione media (1-10)',
            data: filtered.map(item => item.overall),
            backgroundColor: GOLD,
            borderRadius: 8,
            _samples: filtered.map(item => item.samples),
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              suggestedMax: 10,
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.08)' },
            },
            x: { ticks: { color: '#ffffff' }, grid: { display: false } },
          },
          plugins: {
            tooltip: {
              callbacks: {
                afterBody: ctx => {
                  const dataset = ctx[0]?.dataset;
                  const index = ctx[0]?.dataIndex ?? 0;
                  const samples = dataset && dataset._samples ? dataset._samples[index] : 0;
                  return `Feedback raccolti: ${samples}`;
                },
              },
            },
            legend: { display: false },
          },
        },
      }));
    }

    function updateRicaviChart() {
      const categoria = document.getElementById('filterRicaviCategoria')?.value || '__all';
      const limite = parseInt(document.getElementById('filterRicaviLimite')?.value || '10', 10);
      const labelTarget = document.getElementById('labelRicaviLimite');
      if (labelTarget) labelTarget.textContent = limite;

      const filtered = (ricaviPerEventoData.items || [])
        .filter(item => categoria === '__all' || item.categoria === categoria)
        .sort((a, b) => b.value - a.value)
        .slice(0, limite);

      renderChart('chartRicaviEvento', () => ({
        type: 'bar',
        data: {
          labels: filtered.map(item => item.label),
          datasets: [{
            label: 'Ricavi (€)',
            data: filtered.map(item => Number(item.value || 0)),
            backgroundColor: GOLD,
            borderRadius: 10,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#ffffff' },
              grid: { color: 'rgba(255,255,255,0.08)' },
            },
            x: { ticks: { color: '#ffffff' }, grid: { display: false } },
          },
          plugins: { legend: { display: false } },
        },
      }));
    }

    document.getElementById('filterIngressiCategoria')?.addEventListener('change', updateIngressiChart);
    document.getElementById('filterIngressiLimite')?.addEventListener('change', updateIngressiChart);

    const periodoSelect = document.getElementById('filterIngressiPeriodo');
    const defaultRange = String(ingressiTemporaliData.default_range_days || 30);
    if (periodoSelect) {
      periodoSelect.value = defaultRange;
      periodoSelect.addEventListener('change', updateIngressiTemporaliChart);
    }
    document.getElementById('filterIngressiTipoGrafico')?.addEventListener('change', updateIngressiTemporaliChart);

    document.querySelectorAll('.filter-prenotazioni').forEach(cb => {
      cb.addEventListener('change', updatePrenotazioniChart);
    });

    document.getElementById('filterProdottiMetric')?.addEventListener('change', updateProdottiChart);
    document.getElementById('filterProdottiLimite')?.addEventListener('change', updateProdottiChart);

    const feedbackSlider = document.getElementById('filterFeedbackMin');
    if (feedbackSlider) {
      feedbackSlider.addEventListener('input', () => {
        const output = document.getElementById('filterFeedbackMinValue');
        if (output) output.textContent = feedbackSlider.value;
      });
      feedbackSlider.addEventListener('change', updateFeedbackChart);
    }
    document.getElementById('filterFeedbackCategoria')?.addEventListener('change', updateFeedbackChart);

    document.getElementById('filterRicaviCategoria')?.addEventListener('change', updateRicaviChart);
    document.getElementById('filterRicaviLimite')?.addEventListener('change', updateRicaviChart);

    updateIngressiChart();
    updateIngressiTemporaliChart();
    updatePrenotazioniChart();
    updateProdottiChart();
    updateFeedbackChart();
    updateRicaviChart();
  </script>
{% endblock %}

