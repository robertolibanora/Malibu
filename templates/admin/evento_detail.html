{% extends "admin/base.html" %}
{% block admin_title %}{{ evento.nome_evento }}{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}
{% from "admin/_evento_header.html" import render_evento_header %}
{% from "admin/_evento_kpi.html" import render_evento_kpi %}

{% block extra_head %}
  {{ super() }}
  <style>
    .chart-card {
      border-radius: var(--radius-md);
      padding: var(--spacing-5);
      background: rgba(12, 12, 12, 0.6);
      border: 1px solid rgba(212, 175, 55, 0.1);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-4);
      min-height: 280px;
    }
    .chart-card__title {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      margin: 0 0 var(--spacing-2);
      color: var(--admin-text);
    }
    .chart-card canvas {
      max-height: 280px;
    }
    .chart-card__empty {
      display: none;
      margin: var(--spacing-8) 0;
      color: rgba(255, 255, 255, 0.5);
      font-size: var(--font-size-sm);
      text-align: center;
    }
    .evento-analytics-grid {
      display: grid;
      gap: var(--spacing-5);
      margin-top: var(--spacing-5);
    }
    @media (min-width: 1024px) {
      .evento-analytics-grid {
        grid-template-columns: repeat(12, 1fr);
      }
      .chart-card--wide {
        grid-column: span 8;
      }
      .chart-card--tall {
        grid-column: span 4;
      }
      .chart-card--full {
        grid-column: span 12;
      }
    }
  </style>
{% endblock %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_page_header(
    title="Dettaglio Evento",
    subtitle="Informazioni complete, dati operativi e analytics",
    actions=[
      {'type': 'link', 'url': url_for('eventi.admin_list'), 'label': '‚Üê Lista Eventi', 'class': 'btn--ghost'},
      {'type': 'link', 'url': url_for('prenotazioni.admin_tavoli_evento', evento_id=evento.id_evento), 'label': 'ü™ë Gestione Tavoli', 'class': 'btn--secondary'}
    ],
    breadcrumbs=[
      {'label': 'Eventi', 'url': url_for('eventi.admin_list')},
      {'label': evento.nome_evento}
    ]
  ) }}

  <!-- Header Evento Unificato -->
  {{ render_evento_header(evento) }}

  <!-- KPI Card -->
  {{ render_evento_kpi(
    tot_prenotazioni=tot_prenotazioni,
    tot_ingressi=tot_ingressi,
    tot_consumi=tot_consumi,
    tot_feedback=tot_feedback,
    avg_feedback=(avg_musica + avg_ingresso + avg_ambiente + avg_servizio) / 4 if tot_feedback > 0 else None,
    capienza_max=evento.capienza_max,
    scontrino_medio=scontrino_medio
  ) }}

  <!-- Navigazione Tab -->
  <div class="tabs" id="eventoTabs">
    <button class="tabs__item active" onclick="showTab('informazioni', event)">üìã Informazioni</button>
    <button class="tabs__item" onclick="showTab('prenotazioni', event)">üìã Prenotazioni</button>
    <button class="tabs__item" onclick="showTab('ingressi', event)">üö™ Ingressi</button>
    <button class="tabs__item" onclick="showTab('consumi', event)">üí∞ Consumi</button>
    <button class="tabs__item" onclick="showTab('feedback', event)">üí¨ Feedback</button>
    <button class="tabs__item" onclick="showTab('analytics', event)">üìà Analytics</button>
  </div>

  <!-- Tab: Informazioni -->
  <div id="tab-informazioni" class="tab-content active">
    <div class="grid grid--2">
      <section class="card">
        <div class="card__header">
          <h2 class="card__title">Informazioni Evento</h2>
        </div>
        <div class="card__content">
          <dl class="info-list">
            <div class="info-list__item">
              <dt class="info-list__label">Data</dt>
              <dd class="info-list__value">{{ evento.data_evento.strftime('%d/%m/%Y') if evento.data_evento else 'Data da definire' }}</dd>
            </div>
            {% if evento.dj_artista %}
            <div class="info-list__item">
              <dt class="info-list__label">DJ/Artista</dt>
              <dd class="info-list__value">{{ evento.dj_artista }}</dd>
            </div>
            {% endif %}
            {% if evento.tipo_musica %}
            <div class="info-list__item">
              <dt class="info-list__label">Tipo musica</dt>
              <dd class="info-list__value">{{ evento.tipo_musica }}</dd>
            </div>
            {% endif %}
            <div class="info-list__item">
              <dt class="info-list__label">Categoria</dt>
              <dd class="info-list__value">{{ evento.categoria|capitalize }}</dd>
            </div>
            <div class="info-list__item">
              <dt class="info-list__label">Capienza max</dt>
              <dd class="info-list__value">{{ evento.capienza_max }}</dd>
            </div>
            {% if evento.template %}
            <div class="info-list__item">
              <dt class="info-list__label">Format</dt>
              <dd class="info-list__value">{{ evento.template.nome }}</dd>
            </div>
            {% endif %}
            {% if evento.cover_url %}
            <div class="info-list__item" style="flex-direction: column; align-items: flex-start;">
              <dt class="info-list__label" style="margin-bottom: var(--spacing-2);">Immagine Copertina</dt>
              <dd class="info-list__value" style="width: 100%;">
                <img src="{{ url_for('static', filename='uploads/eventi/' + evento.cover_url) }}" alt="Cover {{ evento.nome_evento }}" style="max-width: 100%; max-height: 300px; border-radius: var(--radius-md); border: 1px solid rgba(212, 175, 55, 0.2);">
              </dd>
            </div>
            {% endif %}
          </dl>
        </div>
      </section>

      <section class="card">
        <div class="card__header">
          <h2 class="card__title">Azioni Evento</h2>
        </div>
        <div class="card__content">
          <div style="display: flex; flex-direction: column; gap: var(--spacing-3);">
            <a href="{{ url_for('eventi.admin_edit', evento_id=evento.id_evento) }}" class="btn btn--primary" style="width: 100%; justify-content: center;">‚úèÔ∏è Modifica Evento</a>
            
            <form method="post" action="{{ url_for('eventi.admin_duplicate', evento_id=evento.id_evento) }}">
              <div class="form__group">
                <label class="form__label">Duplica Evento</label>
                <div style="display: flex; gap: var(--spacing-2);">
                  <input class="form__input" type="date" name="data_evento" value="" required style="flex: 1;">
                  <button type="submit" class="btn btn--secondary btn--small">Duplica</button>
                </div>
                <small class="form__hint">La copia avr√† stato <strong>programmato</strong></small>
              </div>
            </form>
            
            <div style="padding-top: var(--spacing-3); border-top: 1px solid var(--admin-border);">
              {% if evento.stato_pubblico == 'programmato' %}
              <form method="post" action="{{ url_for('eventi.admin_set_stato', evento_id=evento.id_evento, stato='attivo') }}" 
                    onsubmit="return confirm('Aprire l\\'evento? Staff e pubblico saranno attivati automaticamente.');">
                <button class="btn btn--success" style="width: 100%;" type="submit">‚úÖ Apri Evento</button>
              </form>
              {% elif evento.stato_pubblico == 'attivo' %}
              <form method="post" action="{{ url_for('eventi.admin_close', evento_id=evento.id_evento) }}" 
                    onsubmit="return confirm('Confermi la chiusura dell\\'evento? Le prenotazioni attive saranno marcate come no-show.');">
                <button class="btn btn--danger" style="width: 100%;" type="submit">üîí Chiudi Evento</button>
              </form>
              {% elif evento.stato_pubblico == 'chiuso' %}
              <form method="post" action="{{ url_for('eventi.admin_set_stato', evento_id=evento.id_evento, stato='programmato') }}" 
                    onsubmit="return confirm('Riaprire l\\'evento?');">
                <button class="btn btn--secondary" style="width: 100%;" type="submit">üìã Riapri Evento</button>
              </form>
              {% endif %}
              
              <form method="post" action="{{ url_for('eventi.admin_delete', evento_id=evento.id_evento) }}" 
                    style="margin-top: var(--spacing-2);"
                    onsubmit="return confirm('Eliminare definitivamente questo evento? Questa azione non pu√≤ essere annullata.');">
                <button class="btn btn--danger" style="width: 100%;" type="submit">üóëÔ∏è Elimina Evento</button>
              </form>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Tab: Prenotazioni -->
  <div id="tab-prenotazioni" class="tab-content">
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Prenotazioni</h2>
        <a href="{{ url_for('prenotazioni.admin_list', evento_id=evento.id_evento) }}" class="btn btn--ghost btn--small">Vedi tutte ‚Üí</a>
      </div>
      <div class="card__content">
        <div class="grid grid--2" style="margin-bottom: var(--spacing-5);">
          <div class="card" style="margin-bottom: 0; background: rgba(255,255,255,0.02);">
            <div class="card__content">
              <h3 class="card__title" style="font-size: var(--font-size-base); margin-bottom: var(--spacing-3);">Per Tipo</h3>
              <dl class="info-list">
                {% for tipo, count in pren_by_tipo.items() %}
                <div class="info-list__item">
                  <dt class="info-list__label">{{ tipo|capitalize }}</dt>
                  <dd class="info-list__value">{{ count }}</dd>
                </div>
                {% endfor %}
              </dl>
            </div>
          </div>
          <div class="card" style="margin-bottom: 0; background: rgba(255,255,255,0.02);">
            <div class="card__content">
              <h3 class="card__title" style="font-size: var(--font-size-base); margin-bottom: var(--spacing-3);">Per Stato</h3>
              <dl class="info-list">
                {% for stato, count in pren_by_stato.items() %}
                <div class="info-list__item">
                  <dt class="info-list__label">{{ stato|capitalize }}</dt>
                  <dd class="info-list__value">{{ count }}</dd>
                </div>
                {% endfor %}
              </dl>
              {% if tavolo_persone > 0 %}
              <div style="margin-top: var(--spacing-3); padding: var(--spacing-3); background: rgba(212, 175, 55, 0.08); border-radius: var(--radius-md); border-left: 3px solid #d4af37;">
                <strong>Totale persone tavoli:</strong> <span class="text--gold">{{ tavolo_persone }}</span>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        {% if prenotazioni_evento %}
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Tipo</th>
                <th>Stato</th>
                <th>Persone</th>
                <th>Orario previsto</th>
                <th>Note</th>
                <th class="table__header--actions">Azioni</th>
              </tr>
            </thead>
            <tbody>
              {% for pren, cli in prenotazioni_evento %}
              <tr>
                <td>
                  <a href="{{ url_for('clienti.admin_cliente_detail', cliente_id=cli.id_cliente) }}" style="text-decoration: none; color: inherit; font-weight: var(--font-weight-medium);">
                    {{ cli.nome }} {{ cli.cognome }}
                  </a>
                </td>
                <td>
                  {% if pren.tipo == 'tavolo' %}
                    <span class="badge badge--primary">ü™ë Tavolo</span>
                  {% elif pren.tipo == 'lista' %}
                    <span class="badge badge--secondary">üìã Lista</span>
                  {% else %}
                    <span class="badge badge--secondary">{{ pren.tipo|capitalize }}</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge badge--{% if pren.stato == 'attiva' %}warning{% elif pren.stato == 'usata' %}success{% elif pren.stato == 'no-show' %}secondary{% else %}secondary{% endif %}">
                    {{ pren.stato|replace('_',' ')|capitalize }}
                  </span>
                </td>
                <td>
                  {% if pren.tipo == 'tavolo' %}
                    {% if pren.num_persone %}
                      <strong>{{ pren.num_persone }}</strong>
                    {% else %}
                      <span class="text--muted">Da confermare</span>
                    {% endif %}
                  {% else %}
                    {{ pren.num_persone or '‚Äî' }}
                  {% endif %}
                </td>
                <td>{{ pren.orario_previsto.strftime('%H:%M') if pren.orario_previsto else '‚Äî' }}</td>
                <td>
                  {% if pren.tipo == 'tavolo' and pren.note %}
                    <span class="text--gold">{{ pren.note }}</span>
                  {% else %}
                    {{ pren.note or '‚Äî' }}
                  {% endif %}
                </td>
                <td class="table__cell--actions">
                  <a href="{{ url_for('prenotazioni.admin_prenotazione_detail', pren_id=pren.id_prenotazione) }}" class="btn btn--ghost btn--small">Dettagli</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
          <span class="admin-empty-state__icon">üìã</span>
          <p class="admin-empty-state__message">Nessuna prenotazione per questo evento.</p>
        </div>
        {% endif %}
      </div>
    </section>
  </div>

  <!-- Tab: Ingressi -->
  <div id="tab-ingressi" class="tab-content">
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Ingressi</h2>
        <a href="{{ url_for('ingressi.admin_list', evento_id=evento.id_evento) }}" class="btn btn--ghost btn--small">Vedi tutti ‚Üí</a>
      </div>
      <div class="card__content">
        <div class="grid grid--2" style="margin-bottom: var(--spacing-5);">
          <div class="card" style="margin-bottom: 0; background: rgba(255,255,255,0.02);">
            <div class="card__content">
              <h3 class="card__title" style="font-size: var(--font-size-base); margin-bottom: var(--spacing-3);">Per Tipo</h3>
              <dl class="info-list">
                {% for tipo, count in ingressi_by_tipo.items() %}
                <div class="info-list__item">
                  <dt class="info-list__label">{{ tipo|capitalize }}</dt>
                  <dd class="info-list__value">{{ count }}</dd>
                </div>
                {% endfor %}
              </dl>
            </div>
          </div>
          {% if ingressi_by_staff %}
          <div class="card" style="margin-bottom: 0; background: rgba(255,255,255,0.02);">
            <div class="card__content">
              <h3 class="card__title" style="font-size: var(--font-size-base); margin-bottom: var(--spacing-3);">Per Staff (Top 10)</h3>
              <dl class="info-list">
                {% for nome, count in ingressi_by_staff %}
                <div class="info-list__item">
                  <dt class="info-list__label">{{ nome }}</dt>
                  <dd class="info-list__value">{{ count }}</dd>
                </div>
                {% endfor %}
              </dl>
            </div>
          </div>
          {% endif %}
        </div>

        {% if ingressi_evento %}
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Tipo</th>
                <th>Orario</th>
                <th>Staff</th>
                <th>Note</th>
                <th class="table__header--actions">Azioni</th>
              </tr>
            </thead>
            <tbody>
              {% for ing, cli, staff in ingressi_evento %}
              <tr>
                <td>
                  <a href="{{ url_for('clienti.admin_cliente_detail', cliente_id=cli.id_cliente) }}" style="text-decoration: none; color: inherit; font-weight: var(--font-weight-medium);">
                    {{ cli.nome }} {{ cli.cognome }}
                  </a>
                </td>
                <td><span class="badge badge--secondary">{{ ing.tipo_ingresso|capitalize }}</span></td>
                <td>{{ ing.orario_ingresso.strftime('%d/%m/%Y %H:%M') if ing.orario_ingresso else '‚Äî' }}</td>
                <td>{{ staff.nome if staff else '‚Äî' }}</td>
                <td>{{ ing.note or '‚Äî' }}</td>
                <td class="table__cell--actions">
                  <a href="{{ url_for('ingressi.admin_ingresso_detail', ingresso_id=ing.id_ingresso) }}" class="btn btn--ghost btn--small">Dettagli</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
          <span class="admin-empty-state__icon">üö™</span>
          <p class="admin-empty-state__message">Nessun ingresso registrato per questo evento.</p>
        </div>
        {% endif %}
      </div>
    </section>
  </div>

  <!-- Tab: Consumi -->
  <div id="tab-consumi" class="tab-content">
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Consumi</h2>
        <a href="{{ url_for('consumi.admin_list', evento_id=evento.id_evento) }}" class="btn btn--ghost btn--small">Vedi tutti ‚Üí</a>
      </div>
      <div class="card__content">
        <div class="grid grid--2" style="margin-bottom: var(--spacing-5);">
          <div class="card" style="margin-bottom: 0; background: rgba(255,255,255,0.02);">
            <div class="card__content">
              <h3 class="card__title" style="font-size: var(--font-size-base); margin-bottom: var(--spacing-3);">Per Punto Vendita</h3>
              <dl class="info-list">
                {% for punto, importo in consumi_by_punto.items() %}
                <div class="info-list__item">
                  <dt class="info-list__label">{{ punto|capitalize }}</dt>
                  <dd class="info-list__value"><strong class="text--gold">‚Ç¨{{ "%.2f"|format(importo) }}</strong></dd>
                </div>
                {% endfor %}
              </dl>
              <div style="margin-top: var(--spacing-3); padding: var(--spacing-3); background: rgba(212, 175, 55, 0.08); border-radius: var(--radius-md); border-left: 3px solid #d4af37;">
                <div style="margin-bottom: var(--spacing-1);"><strong>Clienti unici:</strong> <span class="text--gold">{{ clienti_consumi }}</span></div>
                <div><strong>Scontrino medio:</strong> <span class="text--gold">‚Ç¨{{ "%.2f"|format(scontrino_medio) }}</span></div>
              </div>
            </div>
          </div>
          {% if consumi_by_prodotto %}
          <div class="card" style="margin-bottom: 0; background: rgba(255,255,255,0.02);">
            <div class="card__content">
              <h3 class="card__title" style="font-size: var(--font-size-base); margin-bottom: var(--spacing-3);">Top Prodotti</h3>
              <dl class="info-list">
                {% for prodotto, importo, count in consumi_by_prodotto %}
                <div class="info-list__item">
                  <dt class="info-list__label">{{ prodotto }}</dt>
                  <dd class="info-list__value"><strong class="text--gold">‚Ç¨{{ "%.2f"|format(importo) }}</strong> <span class="text--muted">({{ count }})</span></dd>
                </div>
                {% endfor %}
              </dl>
            </div>
          </div>
          {% endif %}
        </div>

        {% if consumi_evento %}
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Prodotto</th>
                <th>Importo</th>
                <th>Punto Vendita</th>
                <th>Staff</th>
                <th>Note</th>
                <th class="table__header--actions">Azioni</th>
              </tr>
            </thead>
            <tbody>
              {% for cons, cli, staff in consumi_evento %}
              <tr>
                <td>
                  <a href="{{ url_for('clienti.admin_cliente_detail', cliente_id=cli.id_cliente) }}" style="text-decoration: none; color: inherit; font-weight: var(--font-weight-medium);">
                    {{ cli.nome }} {{ cli.cognome }}
                  </a>
                </td>
                <td>{{ cons.prodotto }}</td>
                <td><strong class="text--gold">‚Ç¨{{ "%.2f"|format(cons.importo) }}</strong></td>
                <td>{{ cons.punto_vendita|capitalize }}</td>
                <td>{{ staff.nome if staff else '‚Äî' }}</td>
                <td>{{ cons.note or '‚Äî' }}</td>
                <td class="table__cell--actions">
                  <a href="{{ url_for('consumi.admin_edit', consumo_id=cons.id_consumo) }}" class="btn btn--ghost btn--small">Modifica</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="admin-empty-state">
          <span class="admin-empty-state__icon">üí∞</span>
          <p class="admin-empty-state__message">Nessun consumo registrato per questo evento.</p>
        </div>
        {% endif %}
      </div>
    </section>
  </div>

  <!-- Tab: Feedback -->
  <div id="tab-feedback" class="tab-content">
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Feedback</h2>
      </div>
      <div class="card__content">
        {% if feedback_evento %}
        <div style="display: flex; flex-direction: column; gap: var(--spacing-4);">
          {% for fb, cliente in feedback_evento %}
          <div class="card" style="margin-bottom: 0; background: rgba(255,255,255,0.03); border-left: 3px solid #d4af37;">
            <div class="card__header">
              <div>
                <a href="{{ url_for('clienti.admin_cliente_detail', cliente_id=cliente.id_cliente) }}" style="text-decoration: none; color: inherit;">
                  <strong style="font-size: var(--font-size-base);">{{ cliente.nome }} {{ cliente.cognome }}</strong>
                </a>
                <p class="card__meta" style="margin: 0;">{{ fb.data_feedback.strftime('%d/%m/%Y %H:%M') if fb.data_feedback else '‚Äî' }}</p>
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-2);">
                <span class="badge badge--primary">üéµ {{ fb.voto_musica }}/10</span>
                <span class="badge badge--primary">üö™ {{ fb.voto_ingresso }}/10</span>
                <span class="badge badge--primary">üåü {{ fb.voto_ambiente }}/10</span>
                <span class="badge badge--primary">üçΩÔ∏è {{ fb.voto_servizio }}/10</span>
              </div>
            </div>
            {% if fb.note %}
            <div class="card__content">
              <p class="text--muted" style="margin: 0; font-style: italic;">"{{ fb.note }}"</p>
            </div>
            {% endif %}
            <div class="card__footer">
              <form method="post" action="{{ url_for('feedback.admin_delete', id_feedback=fb.id_feedback) }}" style="display: inline;">
                <input type="hidden" name="next" value="{{ url_for('eventi.admin_evento_detail', evento_id=evento.id_evento) }}">
                <button class="btn btn--danger btn--small" onclick="return confirm('Eliminare il feedback selezionato?');" type="submit">Elimina</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="admin-empty-state">
          <span class="admin-empty-state__icon">üí¨</span>
          <p class="admin-empty-state__message">Nessun feedback registrato per questo evento.</p>
        </div>
        {% endif %}
      </div>
    </section>
  </div>

  <!-- Tab: Analytics -->
  <div id="tab-analytics" class="tab-content">
    <section class="card">
      <div class="card__header">
        <h2 class="card__title">Analytics Evento</h2>
        <p class="card__subtitle">Panoramica visiva di ingressi, prenotazioni, prodotti e feedback</p>
      </div>
      <div class="card__content">
        <div class="evento-analytics-grid">
          <!-- Grafico ingressi temporali -->
          <article class="chart-card chart-card--wide">
            <h3 class="chart-card__title">Andamento ingressi (per ora)</h3>
            <canvas id="chartIngressiTemporali"></canvas>
            <p class="chart-card__empty">Nessun dato di ingresso orario disponibile per questo evento.</p>
          </article>

          <!-- Prenotazioni per tipo -->
          <article class="chart-card chart-card--tall">
            <h3 class="chart-card__title">Prenotazioni per tipologia</h3>
            <canvas id="chartPrenotazioni"></canvas>
            <p class="chart-card__empty">Nessuna prenotazione registrata.</p>
          </article>

          <!-- Prodotti pi√π venduti -->
          <article class="chart-card chart-card--wide">
            <h3 class="chart-card__title">Top prodotti</h3>
            <canvas id="chartProdotti"></canvas>
            <p class="chart-card__empty">Nessun consumo registrato per questo evento.</p>
          </article>

          <!-- Feedback -->
          <article class="chart-card chart-card--tall">
            <h3 class="chart-card__title">Feedback (media voti)</h3>
            <canvas id="chartFeedback"></canvas>
            <p class="chart-card__empty">Nessun feedback disponibile.</p>
          </article>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  // Tab navigation
  function showTab(tabName, event) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelectorAll('.tabs__item').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Activate button
    if (event && event.target) {
      event.target.classList.add('active');
    } else {
      const btn = document.querySelector(`.tabs__item[onclick*="${tabName}"]`);
      if (btn) btn.classList.add('active');
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Update URL hash
    window.location.hash = tabName;
  }
  
  // Check URL hash on load
  window.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash.replace('#', '');
    if (hash && ['informazioni', 'prenotazioni', 'ingressi', 'consumi', 'analytics', 'feedback'].includes(hash)) {
      setTimeout(() => {
        showTab(hash);
      }, 100);
    }
  });
  
</script>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/chart.umd.min.js') }}"></script>
  <script>
    const GOLD = 'rgba(212, 175, 55, 0.95)';
    const GOLD_LIGHT = 'rgba(212, 175, 55, 0.15)';
    const GOLD_DARK = 'rgba(212, 175, 55, 0.7)';
    
    // Dati per i grafici
    const ingressiData = {{ ingressi_temporali_data|tojson }};
    const prenotazioniData = {{ prenotazioni_chart_data|tojson }};
    const prodottiData = {{ prodotti_chart_data|tojson }};
    const feedbackData = {
      labels: ['Musica', 'Ingresso', 'Ambiente', 'Servizio'],
      values: [{{ avg_musica }}, {{ avg_ingresso }}, {{ avg_ambiente }}, {{ avg_servizio }}]
    };
    
    let chartInstances = {};
    
    function renderChart(canvasId, configFn) {
      const canvas = document.getElementById(canvasId);
      if (!canvas || typeof Chart === 'undefined') return;
      
      // Destroy existing chart
      if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
      }
      
      const ctx = canvas.getContext('2d');
      const config = configFn();
      chartInstances[canvasId] = new Chart(ctx, config);
    }
    
    // Ingressi temporali
    if (ingressiData && ingressiData.length > 0) {
      renderChart('chartIngressiTemporali', () => ({
        type: 'line',
        data: {
          labels: ingressiData.map(d => d.slot),
          datasets: [{
            label: 'Ingressi',
            data: ingressiData.map(d => d.value),
            borderColor: GOLD,
            backgroundColor: GOLD_LIGHT,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: GOLD
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: 'rgba(255,255,255,0.7)' },
              grid: { color: 'rgba(255,255,255,0.08)' }
            },
            x: {
              ticks: { color: 'rgba(255,255,255,0.7)' },
              grid: { display: false }
            }
          }
        }
      }));
    } else {
      document.querySelector('#chartIngressiTemporali').parentElement.querySelector('.chart-card__empty').style.display = 'block';
    }
    
    // Prenotazioni
    if (prenotazioniData && prenotazioniData.length > 0) {
      renderChart('chartPrenotazioni', () => ({
        type: 'doughnut',
        data: {
          labels: prenotazioniData.map(d => d.label),
          datasets: [{
            data: prenotazioniData.map(d => d.value),
            backgroundColor: [
              GOLD,
              GOLD_DARK,
              'rgba(212, 175, 55, 0.5)',
              'rgba(212, 175, 55, 0.3)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: 'rgba(255,255,255,0.8)' }
            }
          }
        }
      }));
    } else {
      document.querySelector('#chartPrenotazioni').parentElement.querySelector('.chart-card__empty').style.display = 'block';
    }
    
    // Prodotti
    if (prodottiData && prodottiData.length > 0) {
      const top5 = prodottiData.slice(0, 5);
      renderChart('chartProdotti', () => ({
        type: 'bar',
        data: {
          labels: top5.map(d => d.label),
          datasets: [{
            label: 'Ricavi (‚Ç¨)',
            data: top5.map(d => d.revenue),
            backgroundColor: GOLD,
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { 
                color: 'rgba(255,255,255,0.7)',
                callback: function(value) {
                  return '‚Ç¨' + value.toFixed(0);
                }
              },
              grid: { color: 'rgba(255,255,255,0.08)' }
            },
            x: {
              ticks: { color: 'rgba(255,255,255,0.7)' },
              grid: { display: false }
            }
          }
        }
      }));
    } else {
      document.querySelector('#chartProdotti').parentElement.querySelector('.chart-card__empty').style.display = 'block';
    }
    
    // Feedback
    if (feedbackData && feedbackData.values.some(v => v > 0)) {
      renderChart('chartFeedback', () => ({
        type: 'radar',
        data: {
          labels: feedbackData.labels,
          datasets: [{
            label: 'Valutazione media',
            data: feedbackData.values,
            backgroundColor: GOLD_LIGHT,
            borderColor: GOLD,
            pointBackgroundColor: GOLD,
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: GOLD
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 10,
              ticks: {
                stepSize: 2,
                color: 'rgba(255,255,255,0.7)',
                backdropColor: 'transparent'
              },
              grid: { color: 'rgba(255,255,255,0.1)' },
              pointLabels: { color: 'rgba(255,255,255,0.8)' }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      }));
    } else {
      document.querySelector('#chartFeedback').parentElement.querySelector('.chart-card__empty').style.display = 'block';
    }
  </script>
{% endblock %}
