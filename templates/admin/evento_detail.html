{% extends "admin/base.html" %}
{% block admin_title %}{{ evento.nome_evento }}{% endblock %}

{% block admin_content %}
<div class="evento-detail">
  <!-- Header con info principali -->
  <section class="card">
    <div class="cliente-header">
      <div class="cliente-header__main">
        <h1 class="card__title">{{ evento.nome_evento }}</h1>
        <div class="cliente-header__meta">
          <span class="badge badge--{{ 'success' if evento.stato == 'attivo' else 'secondary' }}">
            {{ evento.stato|capitalize }}
          </span>
          <span class="badge badge--warning">{{ evento.categoria|capitalize }}</span>
          {% if evento.template %}
          <span class="badge">Format: {{ evento.template.nome }}</span>
          {% endif %}
        </div>
      </div>
      <div class="cliente-header__actions">
        <a href="{{ url_for('eventi.admin_list') }}" class="btn btn--secondary">← Torna alla lista</a>
      </div>
    </div>
  </section>

  <!-- Statistiche rapide -->
  <div class="dashboard__stats">
    <div class="stat-card">
      <div class="stat-card__value">{{ tot_prenotazioni }}</div>
      <div class="stat-card__label">Prenotazioni</div>
    </div>
    <div class="stat-card">
      <div class="stat-card__value">{{ tot_ingressi }}</div>
      <div class="stat-card__label">Ingressi</div>
      <div class="stat-card__meta">Capienza: {{ evento.capienza_max }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-card__value">€{{ "%.2f"|format(tot_consumi) }}</div>
      <div class="stat-card__label">Totale Consumi</div>
      <div class="stat-card__meta">Media: €{{ "%.2f"|format(scontrino_medio) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-card__value">{{ tot_punti_fedelta }}</div>
      <div class="stat-card__label">Punti Assegnati</div>
    </div>
    <div class="stat-card">
      <div class="stat-card__value">{{ tot_feedback }}</div>
      <div class="stat-card__label">Feedback</div>
      {% if tot_feedback > 0 %}
      <div class="stat-card__meta">M: {{ avg_musica }} • I: {{ avg_ingresso }} • A: {{ avg_ambiente }}</div>
      {% endif %}
    </div>
  </div>

  <!-- Informazioni evento e gestione -->
  <div class="grid grid--2">
    <section class="card">
      <h2 class="card__title">Informazioni Evento</h2>
      <div class="info-list">
        <div class="info-item">
          <span class="info-label">Data:</span>
          <span class="info-value">{{ evento.data_evento }}</span>
        </div>
        {% if evento.dj_artista %}
        <div class="info-item">
          <span class="info-label">DJ/Artista:</span>
          <span class="info-value">{{ evento.dj_artista }}</span>
        </div>
        {% endif %}
        {% if evento.tipo_musica %}
        <div class="info-item">
          <span class="info-label">Tipo musica:</span>
          <span class="info-value">{{ evento.tipo_musica }}</span>
        </div>
        {% endif %}
        <div class="info-item">
          <span class="info-label">Categoria:</span>
          <span class="info-value">{{ evento.categoria|capitalize }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Capienza max:</span>
          <span class="info-value">{{ evento.capienza_max }}</span>
        </div>
        {% if evento.promozione %}
        <div class="info-item">
          <span class="info-label">Promozione:</span>
          <span class="info-value">{{ evento.promozione }}</span>
        </div>
        {% endif %}
        {% if evento.cover_url %}
        <div class="info-item" style="flex-direction: column; align-items: flex-start;">
          <span class="info-label" style="margin-bottom: 0.5rem;">Immagine Copertina:</span>
          <img src="{{ url_for('static', filename='uploads/eventi/' + evento.cover_url) }}" alt="Cover {{ evento.nome_evento }}" style="max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.2);">
        </div>
        {% endif %}
      </div>
    </section>

    <section class="card">
      <h2 class="card__title">Gestione Evento</h2>
      <div class="form__actions" style="margin-bottom: 1.5rem;">
        <a href="{{ url_for('eventi.admin_edit', evento_id=evento.id_evento) }}" class="btn btn--primary">Modifica Evento</a>
        <a href="{{ url_for('eventi.admin_analytics', evento_id=evento.id_evento) }}" class="btn btn--secondary">Analytics Dettagliati</a>
      </div>
      <form method="post" action="{{ url_for('eventi.admin_duplicate', evento_id=evento.id_evento) }}">
        <div class="form__group">
          <label class="form__label">Duplica Evento</label>
          <div class="form__inline">
            <input class="form__input" type="date" name="data_evento" value="{{ evento.data_evento }}" required>
            <button type="submit" class="btn btn--secondary">Duplica</button>
          </div>
          <small>Crea una copia dell'evento con una nuova data</small>
        </div>
      </form>
      <div class="form__actions" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(212, 175, 55, 0.1);">
        {% if evento.stato != 'chiuso' %}
        <form method="post" action="{{ url_for('eventi.admin_close', evento_id=evento.id_evento) }}" style="display:inline" onsubmit="return confirm('Chiudere questo evento?');">
          <button class="btn btn--secondary">Chiudi Evento</button>
        </form>
        {% endif %}
        <form method="post" action="{{ url_for('eventi.admin_delete', evento_id=evento.id_evento) }}" style="display:inline" onsubmit="return confirm('Eliminare definitivamente questo evento? Questa azione non può essere annullata.');">
          <button class="btn btn--danger">Elimina Evento</button>
        </form>
      </div>
    </section>
  </div>

  <!-- Prenotazioni -->
  <section class="card">
    <h2 class="card__title">Prenotazioni</h2>
    <div class="grid grid--2" style="margin-bottom: 1.5rem;">
      <div>
        <h3 style="color: var(--gold-primary); margin-bottom: 0.75rem;">Per Tipo</h3>
        <ul class="info-list">
          {% for tipo, count in pren_by_tipo.items() %}
          <li class="info-item">
            <span class="info-label">{{ tipo|capitalize }}:</span>
            <span class="info-value">{{ count }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
      <div>
        <h3 style="color: var(--gold-primary); margin-bottom: 0.75rem;">Per Stato</h3>
        <ul class="info-list">
          {% for stato, count in pren_by_stato.items() %}
          <li class="info-item">
            <span class="info-label">{{ stato|capitalize }}:</span>
            <span class="info-value">{{ count }}</span>
          </li>
          {% endfor %}
        </ul>
        {% if tavolo_persone > 0 %}
        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(212, 175, 55, 0.05); border-radius: 6px;">
          <strong>Totale persone tavoli:</strong> {{ tavolo_persone }}
        </div>
        {% endif %}
      </div>
    </div>

    {% if prenotazioni_evento %}
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Tipo</th>
            <th>Stato</th>
            <th>Persone</th>
            <th>Orario previsto</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for pren, cli in prenotazioni_evento %}
          <tr>
            <td>{{ cli.nome }} {{ cli.cognome }}</td>
            <td>{{ pren.tipo|capitalize }}</td>
            <td><span class="badge badge--{{ 'success' if pren.stato == 'attiva' else 'secondary' }}">{{ pren.stato }}</span></td>
            <td>{{ pren.num_persone or '—' }}</td>
            <td>{{ pren.orario_previsto.strftime('%H:%M') if pren.orario_previsto else '—' }}</td>
            <td>{{ pren.note or '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text--muted">Nessuna prenotazione per questo evento.</p>
    {% endif %}
  </section>

  <!-- Ingressi -->
  <section class="card">
    <h2 class="card__title">Ingressi</h2>
    <div class="grid grid--2" style="margin-bottom: 1.5rem;">
      <div>
        <h3 style="color: var(--gold-primary); margin-bottom: 0.75rem;">Per Tipo</h3>
        <ul class="info-list">
          {% for tipo, count in ingressi_by_tipo.items() %}
          <li class="info-item">
            <span class="info-label">{{ tipo|capitalize }}:</span>
            <span class="info-value">{{ count }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% if ingressi_by_staff %}
      <div>
        <h3 style="color: var(--gold-primary); margin-bottom: 0.75rem;">Per Staff (Top 10)</h3>
        <ul class="info-list">
          {% for nome, count in ingressi_by_staff %}
          <li class="info-item">
            <span class="info-label">{{ nome }}:</span>
            <span class="info-value">{{ count }}</span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>

    {% if ingressi_evento %}
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Tipo</th>
            <th>Orario</th>
            <th>Staff</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for ing, cli, staff in ingressi_evento %}
          <tr>
            <td>{{ cli.nome }} {{ cli.cognome }}</td>
            <td><span class="badge">{{ ing.tipo_ingresso|capitalize }}</span></td>
            <td>{{ ing.orario_ingresso.strftime('%d/%m/%Y %H:%M') if ing.orario_ingresso else '—' }}</td>
            <td>{{ staff.nome if staff else '—' }}</td>
            <td>{{ ing.note or '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text--muted">Nessun ingresso registrato per questo evento.</p>
    {% endif %}
  </section>

  <!-- Consumi -->
  <section class="card">
    <h2 class="card__title">Consumi</h2>
    <div class="grid grid--2" style="margin-bottom: 1.5rem;">
      <div>
        <h3 style="color: var(--gold-primary); margin-bottom: 0.75rem;">Per Punto Vendita</h3>
        <ul class="info-list">
          {% for punto, importo in consumi_by_punto.items() %}
          <li class="info-item">
            <span class="info-label">{{ punto|capitalize }}:</span>
            <span class="info-value">€{{ "%.2f"|format(importo) }}</span>
          </li>
          {% endfor %}
        </ul>
        <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(212, 175, 55, 0.05); border-radius: 6px;">
          <strong>Clienti unici:</strong> {{ clienti_consumi }}<br>
          <strong>Scontrino medio:</strong> €{{ "%.2f"|format(scontrino_medio) }}
        </div>
      </div>
      {% if consumi_by_prodotto %}
      <div>
        <h3 style="color: var(--gold-primary); margin-bottom: 0.75rem;">Top Prodotti</h3>
        <ul class="info-list">
          {% for prodotto, importo, count in consumi_by_prodotto %}
          <li class="info-item">
            <span class="info-label">{{ prodotto }}:</span>
            <span class="info-value">€{{ "%.2f"|format(importo) }} ({{ count }})</span>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>

    {% if consumi_evento %}
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Prodotto</th>
            <th>Importo</th>
            <th>Punto Vendita</th>
            <th>Staff</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody>
          {% for cons, cli, staff in consumi_evento %}
          <tr>
            <td>{{ cli.nome }} {{ cli.cognome }}</td>
            <td>{{ cons.prodotto }}</td>
            <td>€{{ "%.2f"|format(cons.importo) }}</td>
            <td>{{ cons.punto_vendita|capitalize }}</td>
            <td>{{ staff.nome if staff else '—' }}</td>
            <td>{{ cons.note or '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text--muted">Nessun consumo registrato per questo evento.</p>
    {% endif %}
  </section>

  <!-- Feedback -->
  <section class="card">
    <h2 class="card__title">Feedback</h2>
    {% if feedback_evento %}
    <div class="list">
      {% for fb, cliente in feedback_evento %}
      <div class="list__item">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
          <div>
            <strong>{{ cliente.nome }} {{ cliente.cognome }}</strong><br>
            <small class="text--muted">{{ fb.data_feedback.strftime('%d/%m/%Y %H:%M') if fb.data_feedback else '—' }}</small>
          </div>
          <div class="badge-group">
            <span class="badge">Musica: {{ fb.voto_musica }}</span>
            <span class="badge">Ingresso: {{ fb.voto_ingresso }}</span>
            <span class="badge">Ambiente: {{ fb.voto_ambiente }}</span>
          </div>
        </div>
        {% if fb.note %}
        <p class="text--muted" style="margin-top: 0.75rem;">{{ fb.note }}</p>
        {% endif %}
        <form method="post" action="{{ url_for('feedback.admin_delete', id_feedback=fb.id_feedback) }}" style="margin-top: 0.75rem;">
          <input type="hidden" name="next" value="{{ url_for('eventi.admin_evento_detail', evento_id=evento.id_evento) }}">
          <button class="btn btn--danger btn--small" onclick="return confirm('Eliminare il feedback selezionato?');" type="submit">Elimina</button>
        </form>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text--muted">Nessun feedback registrato per questo evento.</p>
    {% endif %}
  </section>
</div>
{% endblock %}

