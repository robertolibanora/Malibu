{% extends "admin/base.html" %}
{% block admin_title %}Consumi{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}
{% from "admin/_secondary_nav.html" import render_secondary_nav %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_secondary_nav([
    {'url': url_for('prenotazioni.admin_hub'), 'endpoint': 'prenotazioni.admin_hub', 'label': 'Hub Operativo', 'icon': 'ğŸ“‹'},
    {'url': url_for('prenotazioni.admin_list'), 'endpoint': 'prenotazioni.admin_list', 'label': 'Prenotazioni', 'icon': 'ğŸ“'},
    {'url': url_for('prenotazioni.admin_prenotazioni_tavolo_attesa'), 'endpoint': 'prenotazioni.admin_prenotazioni_tavolo_attesa', 'label': 'Tavoli in Attesa', 'icon': 'ğŸª‘'},
    {'url': url_for('ingressi.admin_list'), 'endpoint': 'ingressi.admin_list', 'label': 'Ingressi', 'icon': 'ğŸšª'},
    {'url': url_for('consumi.admin_list'), 'endpoint': 'consumi.admin_list', 'label': 'Consumi', 'icon': 'ğŸ’°'},
    {'url': url_for('feedback.admin_list'), 'endpoint': 'feedback.admin_list', 'label': 'Feedback', 'icon': 'ğŸ’¬'},
  ], current_endpoint=request.endpoint, prenotazioni_attesa_count=prenotazioni_tavolo_attesa_count) }}

  {{ render_page_header(
    title="Consumi",
    subtitle="Ordini e vendite Â· Tracciamento consumi e punti fedeltÃ ",
    actions=[
      {'type': 'link', 'url': url_for('consumi.admin_new'), 'label': '+ Nuovo Consumo', 'class': 'btn--secondary'}
    ],
    breadcrumbs=[
      {'label': 'Operativo', 'url': url_for('prenotazioni.admin_hub')},
      {'label': 'Consumi'}
    ]
  ) }}

  <!-- Filtri -->
  <section class="card">
    <form class="form" method="get" id="filtriForm">
      <div class="grid grid--2">
        <div class="form__group">
          <label class="form__label">
            ğŸ” Cerca per nome
            {% if filtro.cerca_nome %}
            <span class="badge badge--secondary" style="margin-left: var(--spacing-2); font-size: var(--font-size-xs);">{{ filtro.cerca_nome }}</span>
            {% endif %}
          </label>
          <input class="form__input" type="text" name="cerca_nome" 
                 value="{{ filtro.cerca_nome or '' }}" 
                 placeholder="Nome o cognome cliente..."
                 onkeyup="if(event.key === 'Enter') this.form.submit();"
                 onblur="if(this.value !== '{{ filtro.cerca_nome or '' }}') this.form.submit();">
        </div>
        <div class="form__group">
          <label class="form__label">Evento</label>
          <select class="form__select" name="evento_id" onchange="this.form.submit()">
            <option value="">Tutti</option>
            {% for ev in eventi %}
            <option value="{{ ev.id_evento }}" {% if filtro.evento_id==ev.id_evento %}selected{% endif %}>
              {{ ev.data_evento }} â€” {{ ev.nome_evento }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="form__group">
          <label class="form__label">Staff</label>
          <select class="form__select" name="staff_id" onchange="this.form.submit()">
            <option value="">Tutti</option>
            {% for s in staff_list %}
            <option value="{{ s.id_staff }}" {% if filtro.staff_id==s.id_staff %}selected{% endif %}>{{ s.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form__group">
          <label class="form__label">Punto vendita</label>
          <select class="form__select" name="punto_vendita" onchange="this.form.submit()">
            <option value="">Tutti</option>
            <option value="bar" {% if filtro.punto_vendita=='bar' %}selected{% endif %}>Bar</option>
            <option value="tavolo" {% if filtro.punto_vendita=='tavolo' %}selected{% endif %}>Tavolo</option>
            <option value="privÃ¨" {% if filtro.punto_vendita=='privÃ¨' %}selected{% endif %}>PrivÃ¨</option>
          </select>
        </div>
        <div class="form__group">
          <label class="form__label">Prodotto contiene</label>
          <input class="form__input" type="text" name="prodotto" value="{{ filtro.prodotto or '' }}" 
                 placeholder="Es. Vodka"
                 onkeyup="if(event.key === 'Enter') this.form.submit();"
                 onblur="if(this.value !== '{{ filtro.prodotto or '' }}') this.form.submit();">
        </div>
        <div class="form__group">
          <label class="form__label">Dal</label>
          <input class="form__input" type="date" name="dal" value="{{ filtro.dal or '' }}" onchange="this.form.submit()">
        </div>
        <div class="form__group">
          <label class="form__label">Al</label>
          <input class="form__input" type="date" name="al" value="{{ filtro.al or '' }}" onchange="this.form.submit()">
        </div>
      </div>
      <div class="form__actions">
        {% if filtro.evento_id or filtro.staff_id or filtro.punto_vendita or filtro.prodotto or filtro.dal or filtro.al or filtro.cerca_nome %}
        <a href="{{ url_for('consumi.admin_list') }}" class="btn btn--ghost">Reset Filtri</a>
        {% endif %}
      </div>
    </form>
  </section>

  <!-- Lista Consumi -->
  {% if rows %}
  <section class="list">
    {% for c, cli, ev in rows %}
    <article class="card list__item">
      <div class="list__item-header">
        <div>
          <div class="list__item-title-link">
            <strong>{{ ev.data_evento }} â€” {{ ev.nome_evento }}</strong>
          </div>
          <div class="list__item-meta">
            {{ cli.cognome }} {{ cli.nome }} â€¢ {{ c.punto_vendita|capitalize }} â€¢ {{ c.data_consumo.strftime('%d/%m/%Y %H:%M') if c.data_consumo else c.data_consumo }}
          </div>
          <div class="list__item-badges">
            <span class="badge badge--primary">{{ c.prodotto }}</span>
            <span class="badge badge--success">â‚¬ {{ '%.2f'|format(c.importo) }}</span>
          </div>
          {% if c.note %}
          <div class="text--muted" style="margin-top: var(--spacing-2); font-size: var(--font-size-sm);">
            {{ c.note }}
          </div>
          {% endif %}
        </div>
        <div class="list__item-actions">
          <a href="{{ url_for('consumi.admin_edit', consumo_id=c.id_consumo) }}" class="btn btn--primary btn--small">Modifica</a>
          <form method="post" action="{{ url_for('consumi.admin_delete', consumo_id=c.id_consumo) }}" 
                style="display:inline" 
                onsubmit="return confirm('Eliminare questo consumo?');">
            <button class="btn btn--danger btn--small" type="submit">Elimina</button>
          </form>
        </div>
      </div>
    </article>
    {% endfor %}
  </section>
  {% else %}
  <section class="card">
    <div class="admin-empty-state">
      <span class="admin-empty-state__icon">ğŸ’°</span>
      <p class="admin-empty-state__message">Nessun consumo trovato.</p>
    </div>
  </section>
  {% endif %}
</div>
{% endblock %}
