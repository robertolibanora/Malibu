{% extends "admin/base.html" %}
{% block admin_title %}Feedback{% endblock %}
{% block admin_content %}
<section class="card">
  <h1 class="card__title">Feedback</h1>
  <div class="card__meta">
    Totali: {{ count }} • Musica: {{ avg_musica }} • Ingresso: {{ avg_ingresso }} • Ambiente: {{ avg_ambiente }}
  </div>
      <form class="form" method="get">
        <div class="grid grid--2">
          <div class="form__group">
            <label class="form__label">Evento</label>
            <select class="form__input" name="evento_id">
              <option value="">— Tutti —</option>
              {% for ev in eventi %}
                <option value="{{ ev.id_evento }}" {% if filtro_evento_id and filtro_evento_id == ev.id_evento %}selected{% endif %}>
                  {{ ev.data_evento }} — {{ ev.nome_evento }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="form__group">
            <label class="form__label">Dal</label>
            <input class="form__input" type="date" name="dal">
          </div>
          <div class="form__group">
            <label class="form__label">Al</label>
            <input class="form__input" type="date" name="al">
          </div>
        </div>
        <div class="form__actions">
          <button class="btn btn--secondary" type="submit">Filtra</button>
          {% if filtro_evento_id or request.args.get('dal') or request.args.get('al') %}
          <a href="{{ url_for('feedback.admin_list') }}" class="btn btn--ghost">Reset</a>
          {% endif %}
        </div>
      </form>
</section>

<!-- Info paginazione -->
{% if total > 0 %}
<section class="card" style="padding: 1rem 1.5rem; margin-bottom: 1.5rem;">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
      <strong>Mostrando {{ ((page - 1) * per_page) + 1 }} - {{ (page * per_page if page * per_page < total else total) }} di {{ total }} feedback</strong>
    </div>
    <div style="display: flex; gap: 0.75rem; align-items: center;">
      <label class="form__label" style="margin: 0; white-space: nowrap;">Per pagina:</label>
      <select class="form__input" style="width: auto; min-width: 80px;" onchange="updatePerPage(this.value)">
        <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
        <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
        <option value="200" {% if per_page==200 %}selected{% endif %}>200</option>
      </select>
    </div>
  </div>
  <script>
    function updatePerPage(value) {
      const url = new URL(window.location.href);
      url.searchParams.set('per_page', value);
      url.searchParams.set('page', '1');
      window.location.href = url.toString();
    }
  </script>
</section>
{% endif %}

<section class="card">
      {% if rows and rows|length %}
        <div class="list">
          {% for fb, cl, ev in rows %}
            <div class="list__item">
              <div><strong>{{ ev.nome_evento }}</strong> — {{ ev.data_evento }}</div>
              <div>{{ cl.nome }} {{ cl.cognome }}</div>
              <div>Musica: {{ fb.voto_musica }} • Ingresso: {{ fb.voto_ingresso }} • Ambiente: {{ fb.voto_ambiente }}</div>
              {% if fb.note %}<div class="text--muted">{{ fb.note }}</div>{% endif %}
              <form method="post" action="{{ url_for('feedback.admin_delete', id_feedback=fb.id_feedback) }}">
                <div class="form__actions">
                  <button class="btn btn--danger" onclick="return confirm('Eliminare il feedback?')" type="submit">Elimina</button>
                </div>
              </form>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text--muted">Nessun feedback trovato.</p>
      {% endif %}
</section>

<!-- Paginazione -->
{% if total_pages > 1 %}
<section class="card" style="padding: 1.5rem; margin-top: 2rem;">
  <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
    {% if page > 1 %}
    <a href="{{ url_for('feedback.admin_list', page=1, per_page=per_page, evento_id=filtro_evento_id, dal=request.args.get('dal'), al=request.args.get('al')) }}" class="btn btn--ghost btn--small">« Prima</a>
    <a href="{{ url_for('feedback.admin_list', page=page-1, per_page=per_page, evento_id=filtro_evento_id, dal=request.args.get('dal'), al=request.args.get('al')) }}" class="btn btn--ghost btn--small">‹ Precedente</a>
    {% endif %}
    
    <div style="display: flex; gap: 0.25rem; align-items: center; margin: 0 1rem;">
      {% set start_page = pages_list[0] if pages_list else 1 %}
      {% set end_page = pages_list[-1] if pages_list else total_pages %}
      
      {% if start_page > 1 %}
      <a href="{{ url_for('feedback.admin_list', page=1, per_page=per_page, evento_id=filtro_evento_id, dal=request.args.get('dal'), al=request.args.get('al')) }}" class="btn btn--ghost btn--small">1</a>
      {% if start_page > 2 %}
      <span class="text--muted" style="padding: 0 0.5rem;">...</span>
      {% endif %}
      {% endif %}
      
      {% for p in pages_list %}
      {% if p == page %}
      <span class="btn btn--primary btn--small" style="pointer-events: none;">{{ p }}</span>
      {% else %}
      <a href="{{ url_for('feedback.admin_list', page=p, per_page=per_page, evento_id=filtro_evento_id, dal=request.args.get('dal'), al=request.args.get('al')) }}" class="btn btn--ghost btn--small">{{ p }}</a>
      {% endif %}
      {% endfor %}
      
      {% if end_page < total_pages %}
      {% if end_page < total_pages - 1 %}
      <span class="text--muted" style="padding: 0 0.5rem;">...</span>
      {% endif %}
      <a href="{{ url_for('feedback.admin_list', page=total_pages, per_page=per_page, evento_id=filtro_evento_id, dal=request.args.get('dal'), al=request.args.get('al')) }}" class="btn btn--ghost btn--small">{{ total_pages }}</a>
      {% endif %}
    </div>
    
    {% if page < total_pages %}
    <a href="{{ url_for('feedback.admin_list', page=page+1, per_page=per_page, evento_id=filtro_evento_id, dal=request.args.get('dal'), al=request.args.get('al')) }}" class="btn btn--ghost btn--small">Successiva ›</a>
    <a href="{{ url_for('feedback.admin_list', page=total_pages, per_page=per_page, evento_id=filtro_evento_id, dal=request.args.get('dal'), al=request.args.get('al')) }}" class="btn btn--ghost btn--small">Ultima »</a>
    {% endif %}
  </div>
  
  <div style="text-align: center; margin-top: 1rem;">
    <small class="text--muted">Pagina {{ page }} di {{ total_pages }}</small>
  </div>
</section>
{% endif %}
{% endblock %}