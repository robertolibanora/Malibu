{% extends "admin/base.html" %}
{% block admin_title %}Log Attività{% endblock %}
{% block admin_content %}
<section class="card">
  <h1 class="card__title">Log attività</h1>
  <div class="card__meta">Totale: {{ total }}</div>
      <form class="form" method="get">
        <div class="grid grid--2">
          <div class="form__group">
            <label class="form__label">Tabella</label>
            <input class="form__input" type="text" name="tabella" value="{{ filtro_tabella or '' }}" placeholder="es. clienti">
          </div>
          <div class="form__group">
            <label class="form__label">Staff</label>
            <select class="form__input" name="staff_id">
              <option value="">— Tutti —</option>
              {% for s in staffs %}
                <option value="{{ s.id_staff }}" {% if filtro_staff_id == s.id_staff %}selected{% endif %}>{{ s.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form__group">
            <label class="form__label">Tipo</label>
            <select class="form__input" name="tipo">
              <option value="">— Tutti —</option>
              <option value="ingressi" {% if filtro_tipo == 'ingressi' %}selected{% endif %}>Ingressi</option>
              <option value="vendite" {% if filtro_tipo == 'vendite' %}selected{% endif %}>Vendite Bar</option>
            </select>
          </div>
          <div class="form__group">
            <label class="form__label">Dal</label>
            <input class="form__input" type="datetime-local" name="dal" value="{{ filtro_dal or '' }}">
          </div>
          <div class="form__group">
            <label class="form__label">Al</label>
            <input class="form__input" type="datetime-local" name="al" value="{{ filtro_al or '' }}">
          </div>
        </div>
        <div class="form__actions">
          <button class="btn btn--secondary" type="submit">Filtra</button>
        </div>
      </form>

      <hr class="divider" />

      {% if rows and rows|length %}
        <div class="list">
          {% for log, staff, detail in rows %}
            <article class="list__item card">
              <div class="list__item-header">
                <div>
                  <div style="display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;">
                    {% if log.tabella == 'ingressi' %}
                      <span class="badge badge--success">Ingressi</span>
                    {% elif log.tabella == 'consumi' %}
                      <span class="badge badge--warning">Vendite Bar</span>
                    {% else %}
                      <span class="badge">{{ log.tabella|capitalize }}</span>
                    {% endif %}
                    <span class="badge">{{ log.azione }}</span>
                  </div>
                  {% if detail %}
                    <div style="margin-top:.5rem;" class="text--muted">{{ detail }}</div>
                  {% endif %}
                  <div class="text--muted" style="margin-top:.25rem;">{{ log.timestamp }}</div>
                </div>
                <div style="display:flex; gap:.5rem; align-items:center;">
                  <span class="text--muted">{{ staff.nome if staff else '—' }}</span>
                  {% if log.tabella == 'ingressi' and log.azione != 'delete' %}
                    <a href="{{ url_for('ingressi.admin_ingresso_detail', ingresso_id=log.record_id) }}" class="btn btn--primary btn--small">Apri</a>
                  {% elif log.tabella == 'consumi' and log.azione != 'delete' %}
                    <a href="{{ url_for('consumi.admin_edit', consumo_id=log.record_id) }}" class="btn btn--secondary btn--small">Modifica</a>
                  {% endif %}
                </div>
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="text--muted">Nessun log trovato.</p>
      {% endif %}

      <div class="form__actions" style="margin-top:1rem;">
        {% if page > 1 %}
          <a class="btn btn--ghost" href="{{ url_for('log.list', page=page-1, per_page=per_page, tabella=filtro_tabella, staff_id=filtro_staff_id, tipo=filtro_tipo, dal=filtro_dal, al=filtro_al) }}">« Precedente</a>
        {% endif %}
        {% if total > page * per_page %}
          <a class="btn btn--ghost" href="{{ url_for('log.list', page=page+1, per_page=per_page, tabella=filtro_tabella, staff_id=filtro_staff_id, tipo=filtro_tipo, dal=filtro_dal, al=filtro_al) }}">Successiva »</a>
        {% endif %}
      </div>
</section>
{% endblock %}