{% extends "admin/base.html" %}
{% block admin_title %}Log Attivit√†{% endblock %}

{% block admin_content %}
<!-- Navigazione Secondaria Impostazioni -->
<div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.08);">
  <a href="{{ url_for('staff_admin.admin_hub') }}" class="btn btn--ghost btn--small">üè† Hub Impostazioni</a>
  <a href="{{ url_for('staff_admin.admin_list') }}" class="btn btn--ghost btn--small">üë§ Staff</a>
  <a href="{{ url_for('prodotti.admin_list') }}" class="btn btn--ghost btn--small">üçπ Listino</a>
  <a href="{{ url_for('format.admin_list') }}" class="btn btn--ghost btn--small">üé≠ Format</a>
  <a href="{{ url_for('fedelta.admin_soglie') }}" class="btn btn--ghost btn--small">‚≠ê Soglie</a>
  <a href="{{ url_for('log.list') }}" class="btn btn--primary btn--small">üìú Log</a>
</div>

{% set displayed_rows = rows or [] %}
{% set counts = namespace(ingressi=0, consumi=0, altre=0) %}
{% for log, staff, detail in displayed_rows %}
  {% if log.tabella == 'ingressi' %}
    {% set counts.ingressi = counts.ingressi + 1 %}
  {% elif log.tabella == 'consumi' %}
    {% set counts.consumi = counts.consumi + 1 %}
  {% else %}
    {% set counts.altre = counts.altre + 1 %}
  {% endif %}
{% endfor %}

<div class="logs-hub">
  <header class="logs-hub__header fade-in">
    <div class="logs-hub__intro">
      <h1 class="logs-hub__title">Registro Attivit√†</h1>
      <p class="logs-hub__subtitle">Traccia modifiche e operazioni eseguite dal personale con filtri rapidi.</p>
          </div>
    <div class="logs-hub__filters">
      <form class="logs-filter" method="get">
        <label class="logs-filter__field">
          <span>Tabella</span>
          <input class="form__input" type="text" name="tabella" value="{{ filtro_tabella or '' }}" placeholder="Es. clienti, ingressi">
        </label>
        <label class="logs-filter__field">
          <span>Staff</span>
          <select class="form__select form__select--dense" name="staff_id" onchange="this.form.submit()">
            <option value="">Tutti</option>
              {% for s in staffs %}
                <option value="{{ s.id_staff }}" {% if filtro_staff_id == s.id_staff %}selected{% endif %}>{{ s.nome }}</option>
              {% endfor %}
            </select>
        </label>
        <label class="logs-filter__field">
          <span>Tipo</span>
          <select class="form__select form__select--dense" name="tipo" onchange="this.form.submit()">
            <option value="" {% if not filtro_tipo %}selected{% endif %}>Tutti</option>
              <option value="ingressi" {% if filtro_tipo == 'ingressi' %}selected{% endif %}>Ingressi</option>
              <option value="vendite" {% if filtro_tipo == 'vendite' %}selected{% endif %}>Vendite Bar</option>
            </select>
        </label>
        <label class="logs-filter__field">
          <span>Dal</span>
            <input class="form__input" type="datetime-local" name="dal" value="{{ filtro_dal or '' }}">
        </label>
        <label class="logs-filter__field">
          <span>Al</span>
            <input class="form__input" type="datetime-local" name="al" value="{{ filtro_al or '' }}">
        </label>
        <div class="logs-filter__actions">
          <button class="btn btn--secondary btn--small" type="submit">Applica filtri</button>
          {% if filtro_tabella or filtro_staff_id or filtro_tipo or filtro_dal or filtro_al %}
          <a class="btn btn--ghost btn--small" href="{{ url_for('log.list') }}">Reset</a>
          {% endif %}
        </div>
      </form>
    </div>
  </header>

  <section class="logs-hub__stats fade-in" style="animation-delay: 120ms;">
    <article class="profile-metric">
      <span class="profile-metric__label">Log storici</span>
      <span class="profile-metric__value">{{ total }}</span>
    </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Risultati correnti</span>
      <span class="profile-metric__value">{{ displayed_rows|length }}</span>
      <span class="profile-metric__meta">Paginati {{ page }} / {{ (total // per_page) + (1 if total % per_page else 0) }}</span>
    </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Ingressi</span>
      <span class="profile-metric__value">{{ counts.ingressi }}</span>
      <span class="profile-metric__meta">Nel set filtrato</span>
    </article>
    <article class="profile-metric">
      <span class="profile-metric__label">Vendite bar</span>
      <span class="profile-metric__value">{{ counts.consumi }}</span>
      <span class="profile-metric__meta">Nel set filtrato</span>
    </article>
  </section>

  <section class="logs-timeline fade-in" style="animation-delay: 180ms;">
    {% if displayed_rows %}
    <ul class="timeline-list">
      {% for log, staff, detail in displayed_rows %}
      <li class="timeline-item">
        <div class="timeline-item__header">
          <div class="logs-pill logs-pill--{{ log.tabella }}">{{ log.tabella|capitalize }}</div>
          <span class="logs-action">{{ log.azione|upper }}</span>
        </div>
        <div class="timeline-item__meta">
          {{ log.timestamp.strftime('%d/%m/%Y %H:%M') if log.timestamp else log.timestamp }}
          {% if staff %}‚Ä¢ {{ staff.nome }}{% endif %}
                  </div>
                  {% if detail %}
        <p class="timeline-item__note">{{ detail }}</p>
                  {% endif %}
        <div class="timeline-item__actions">
                  {% if log.tabella == 'ingressi' and log.azione != 'delete' %}
            <a href="{{ url_for('ingressi.admin_ingresso_detail', ingresso_id=log.record_id) }}" class="btn btn--primary btn--small">Apri ingresso</a>
                  {% elif log.tabella == 'consumi' and log.azione != 'delete' %}
            <a href="{{ url_for('consumi.admin_edit', consumo_id=log.record_id) }}" class="btn btn--secondary btn--small">Modifica consumo</a>
                  {% endif %}
        </div>
      </li>
      {% endfor %}
    </ul>
      {% else %}
    <div class="empty-state">Nessun log corrisponde ai criteri selezionati.</div>
      {% endif %}
  </section>

  <section class="logs-pagination fade-in" style="animation-delay: 220ms;">
        {% if page > 1 %}
          <a class="btn btn--ghost" href="{{ url_for('log.list', page=page-1, per_page=per_page, tabella=filtro_tabella, staff_id=filtro_staff_id, tipo=filtro_tipo, dal=filtro_dal, al=filtro_al) }}">¬´ Precedente</a>
        {% endif %}
        {% if total > page * per_page %}
          <a class="btn btn--ghost" href="{{ url_for('log.list', page=page+1, per_page=per_page, tabella=filtro_tabella, staff_id=filtro_staff_id, tipo=filtro_tipo, dal=filtro_dal, al=filtro_al) }}">Successiva ¬ª</a>
        {% endif %}
  </section>
      </div>
{% endblock %}