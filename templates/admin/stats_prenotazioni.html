{% extends "admin/base.html" %}
{% block admin_title %}Statistiche Prenotazioni{% endblock %}

{% from "admin/_page_header.html" import render_page_header %}
{% from "admin/_secondary_nav.html" import render_secondary_nav %}

{% block admin_content %}
<div class="admin-shell__content">
  {{ render_secondary_nav([
    {'url': url_for('stats.admin_hub'), 'endpoint': 'stats.admin_hub', 'label': 'Hub Statistiche', 'icon': None},
    {'url': url_for('stats.admin_overview'), 'endpoint': 'stats.admin_overview', 'label': 'Overview', 'icon': None},
    {'url': url_for('stats.admin_ingressi'), 'endpoint': 'stats.admin_ingressi', 'label': 'Ingressi', 'icon': None},
    {'url': url_for('stats.admin_prenotazioni'), 'endpoint': 'stats.admin_prenotazioni', 'label': 'Prenotazioni', 'icon': None},
    {'url': url_for('stats.admin_consumi'), 'endpoint': 'stats.admin_consumi', 'label': 'Consumi', 'icon': None},
  ], current_endpoint=request.endpoint) }}
  
  {{ render_page_header(
    title="Statistiche Prenotazioni",
    subtitle="Analisi prenotazioni, conversioni e approvazioni tavoli",
    actions=None,
    breadcrumbs=[
      {'label': 'Statistiche', 'url': url_for('stats.admin_hub')},
      {'label': 'Prenotazioni'}
    ]
  ) }}

  <!-- Filtri -->
  <section class="card" style="margin-bottom: var(--spacing-5);">
    <form method="get" class="form__actions" style="border-top: none; padding-top: 0; margin-top: 0;">
      <div class="form__group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
        <label class="form__label">Evento</label>
        <select class="form__select" name="evento_id" onchange="this.form.submit()">
          <option value="">Tutti gli eventi</option>
          {% for e in eventi %}
          <option value="{{ e.id_evento }}" {% if evento_selezionato_id == e.id_evento %}selected{% endif %}>
            {{ e.nome_evento }} - {{ e.data_evento.strftime('%d/%m/%Y') if e.data_evento else 'N/A' }}
          </option>
          {% endfor %}
        </select>
      </div>
      {% if evento_selezionato_id %}
      <div class="form__group" style="margin-bottom: 0;">
        <a href="{{ url_for('stats.admin_prenotazioni') }}" class="btn btn--ghost">Reset</a>
      </div>
      {% endif %}
    </form>
  </section>

  <!-- KPI -->
  <div class="grid grid--auto" style="margin-bottom: var(--spacing-6);">
    <div class="stat-card" style="border-left: 4px solid var(--admin-accent); text-align: center;">
      <div class="stat-card__value" style="color: var(--admin-accent); font-size: var(--font-size-4xl); font-weight: var(--font-weight-bold);">{{ stats.totale }}</div>
      <div class="stat-card__label" style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">Totale Prenotazioni</div>
    </div>
    <div class="stat-card" style="border-left: 4px solid var(--admin-accent); text-align: center;">
      <div class="stat-card__value" style="color: var(--admin-accent); font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold);">{{ stats.lista }}</div>
      <div class="stat-card__label" style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">Lista</div>
    </div>
    <div class="stat-card" style="border-left: 4px solid var(--admin-accent); text-align: center;">
      <div class="stat-card__value" style="color: var(--admin-accent); font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold);">{{ stats.tavolo }}</div>
      <div class="stat-card__label" style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">Tavolo</div>
    </div>
    {% if stats.tavoli_in_attesa > 0 %}
    <div class="stat-card" style="border-left: 4px solid var(--admin-accent); text-align: center;">
      <div class="stat-card__value" style="color: var(--admin-accent); font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold);">{{ stats.tavoli_in_attesa }}</div>
      <div class="stat-card__label" style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">In Attesa</div>
    </div>
    {% endif %}
  </div>

  <!-- Grafici -->
  <div class="grid grid--2" style="margin-bottom: var(--spacing-6);">
    <section class="card chart-card">
      <div class="card__header">
        <h2 class="card__title">Distribuzione per Tipo</h2>
        <p class="card__meta" style="margin: 0;">Lista vs Tavolo</p>
      </div>
      <div class="card__content">
        <canvas id="chartTipo"></canvas>
      </div>
    </section>

    <section class="card chart-card">
      <div class="card__header">
        <h2 class="card__title">Stati Approvazione Tavoli</h2>
        <p class="card__meta" style="margin: 0;">Stato delle richieste tavolo</p>
      </div>
      <div class="card__content">
        <canvas id="chartStati"></canvas>
      </div>
    </section>
  </div>
</div>

<script>
// Distribuzione Tipo
const ctxTipo = document.getElementById('chartTipo');
if (ctxTipo) {
  new Chart(ctxTipo, {
    type: 'doughnut',
    data: {
      labels: ['Lista', 'Tavolo'],
      datasets: [{
        data: [{{ stats.lista }}, {{ stats.tavolo }}],
        backgroundColor: ['var(--admin-accent)', 'var(--admin-accent)'],
        borderWidth: 2,
        borderColor: 'rgba(0, 0, 0, 0.1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 }
        }
      }
    }
  });
}

// Stati Approvazione
const ctxStati = document.getElementById('chartStati');
if (ctxStati) {
  new Chart(ctxStati, {
    type: 'doughnut',
    data: {
      labels: ['In Attesa', 'Approvati', 'Rifiutati'],
      datasets: [{
        data: [
          {{ stats.tavoli_in_attesa }},
          {{ stats.tavoli_approvati }},
          {{ stats.tavoli_rifiutati }}
        ],
        backgroundColor: ['var(--admin-accent)', 'var(--admin-accent)', 'var(--admin-accent)'],
        borderWidth: 2,
        borderColor: 'rgba(0, 0, 0, 0.1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 }
        }
      }
    }
  });
}
</script>
{% endblock %}
