{% extends "clienti/base.html" %}
{% block title %}{{ e.nome_evento }} - Malibù{% endblock %}

{% block cliente_content %}
<article class="card card--hero">
  {% if e.cover_url %}
    <img src="{{ url_for('static', filename='uploads/eventi/' ~ e.cover_url) }}" alt="" style="width:100%;border-radius:10px;margin-bottom:10px;">
  {% endif %}
  <div class="card__header">
    <div>
      <h1 class="card__title">{{ e.nome_evento }}</h1>
      <div class="card__meta">{{ e.data_evento }} • {{ e.tipo_musica or e.categoria }}</div>
      {% if e.dj_artista %}<p class="text--muted">DJ: {{ e.dj_artista }}</p>{% endif %}
      {% if e.promozione %}<p class="text--muted">Promo: {{ e.promozione }}</p>{% endif %}
    </div>
  </div>
  <div class="form__actions" style="margin-top:.5rem;">
    {% set prenotazione_attiva = workflow_state.prenotazione_attiva if workflow_state else None %}
    {% set can_prenotare = workflow_state.cliente_puo_prenotare() if workflow_state else True %}

    {% if is_future %}
      {% if can_prenotare %}
        <a class="btn btn--primary" href="{{ url_for('prenotazioni.nuova', evento_id=e.id_evento) }}">Prenota</a>
      {% elif prenotazione_attiva %}
        <button class="btn btn--ghost" type="button" aria-disabled="true">Prenotazione già attiva</button>
      {% else %}
        <button class="btn btn--ghost" type="button" aria-disabled="true">Prenotazioni non disponibili</button>
      {% endif %}
    {% else %}
      <button class="btn btn--ghost" type="button" aria-disabled="true">Evento passato</button>
    {% endif %}

    <button class="btn btn--ghost" type="button" onclick="copyLink(window.location.href)">Condividi</button>
  </div>

  {% if prenotazione_attiva %}
    <p class="text--muted" style="margin-top:.5rem;">Hai già una prenotazione attiva per questa serata. Puoi gestirla da <a href="{{ url_for('prenotazioni.mie') }}">Le mie prenotazioni</a>.</p>
  {% endif %}
</article>

{% if not is_future %}
<section class="card">
  <div class="card__header card__header--compact">
    <h2 class="card__title">I miei acquisti durante la serata</h2>
    <p class="card__meta">Vedi cosa hai acquistato in questo evento.</p>
  </div>
  {% if consumi_miei %}
    <ul class="timeline timeline--compact">
      {% for c in consumi_miei %}
        <li class="timeline__item">
          <span class="timeline__date">{{ c.data_consumo.strftime('%d/%m/%Y %H:%M') }}</span>
          <div class="timeline__content">
            <h3 class="timeline__title">{{ c.prodotto }}</h3>
            <p class="timeline__meta">Importo: € {{ '%.2f'|format(c.importo) }}</p>
            {% if c.note %}<p class="timeline__note">{{ c.note }}</p>{% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="empty-state">Non risultano acquisti per questa serata.</p>
  {% endif %}
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function copyLink(url){ navigator.clipboard.writeText(url).then(()=>alert('Link copiato')); }
</script>
{% endblock %}