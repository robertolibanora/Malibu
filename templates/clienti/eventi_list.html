{% extends "clienti/base.html" %}
{% block title %}Eventi - Malib√π{% endblock %}

{% block cliente_content %}
{% import "clienti/_status_badges.html" as badges %}
{% set show_all_past = show_all_past|default(false) %}

<div class="section-heading">
  <span class="section-heading__icon">üéâ</span>
  <div class="section-heading__meta">
    <span class="section-heading__eyebrow">Scopri e prenota</span>
    <h1 class="section-heading__title">Prossimi eventi</h1>
  </div>
</div>

<section class="event-list">
  {% for e in eventi_prossimi %}
  <article class="event-card">
    <div class="event-card__media">
      {% if e.cover_url %}
        <img src="{{ url_for('static', filename='uploads/eventi/' ~ e.cover_url) }}" alt="{{ e.nome_evento }}">
      {% else %}
        <div class="event-card__placeholder">{{ e.nome_evento[0]|upper }}</div>
      {% endif %}
      
      <!-- Badge stato evento -->
      {% if evento_badge_map and e.id_evento in evento_badge_map %}
        {% set badge = evento_badge_map[e.id_evento] %}
        <span class="event-card__chip event-card__chip--{{ badge.color }}">
          {{ badge.icon }} {{ badge.label }}
        </span>
      {% endif %}
      
      <!-- Badge prenotazione -->
      {% if workflow_map and e.id_evento in workflow_map %}
        {% set workflow = workflow_map[e.id_evento] %}
        {% if workflow.prenotazione_attiva %}
          <span class="event-card__chip event-card__chip--booked">üéüÔ∏è Prenotato</span>
        {% endif %}
      {% endif %}
    </div>
    <div class="event-card__body">
      <div class="event-card__info">
        <h2 class="event-card__title">{{ e.nome_evento }}</h2>
        
        <!-- Info evento -->
        <p class="event-card__meta">
          <span class="event-card__date">{{ e.data_evento.strftime('%d %b %Y') if e.data_evento else '' }}</span>
          <span class="event-card__dot">‚Ä¢</span>
          <span class="event-card__genre">{{ e.tipo_musica or e.categoria }}</span>
        </p>
        
        {% if e.dj_artista %}
          <p class="event-card__dj">DJ set: <strong>{{ e.dj_artista }}</strong></p>
        {% endif %}
        
        {% if e.promozione %}
          <p class="event-card__promo">üéä Promo: {{ e.promozione }}</p>
        {% endif %}

        <!-- Workflow status (se cliente loggato) -->
        {% if workflow_map and e.id_evento in workflow_map %}
          {% set workflow = workflow_map[e.id_evento] %}
          <div class="event-card__workflow">
            <small class="text--muted">
              {% if workflow.prenotazione_attiva %}
                ‚úì Prenotazione confermata ‚Äî Pronto per entrare!
              {% elif workflow.ingresso_registrato %}
                ‚úì Sei entrato ‚Äî Puoi lasciare feedback
              {% else %}
                ‚Üí Scegli questa serata e prenota il tuo posto
              {% endif %}
            </small>
          </div>
        {% endif %}
      </div>
      
      <!-- Azioni contesto -->
      <div class="event-card__actions">
        <a class="btn btn--primary" href="{{ url_for('eventi.dettaglio_pubblico', evento_id=e.id_evento) }}">
          Dettagli
        </a>
        
        {% if workflow_map and e.id_evento in workflow_map %}
          {% set workflow = workflow_map[e.id_evento] %}
          {% if workflow.cliente_puo_prenotare() %}
            <a class="btn btn--secondary" href="{{ url_for('prenotazioni.nuova', evento_id=e.id_evento) }}">
              Prenota ora
            </a>
          {% endif %}
        {% else %}
          <a class="btn btn--secondary" href="{{ url_for('prenotazioni.nuova', evento_id=e.id_evento) }}">
            Prenota
          </a>
        {% endif %}
        
        <button class="btn btn--ghost" type="button" 
                data-share-url="{{ request.url_root|trim('/') }}{{ url_for('eventi.dettaglio_pubblico', evento_id=e.id_evento) }}" 
                onclick="copyLink(this.dataset.shareUrl)">
          Condividi
        </button>
      </div>
    </div>
  </article>
  {% else %}
    <div class="card"><p class="text--muted">Nessun evento disponibile al momento. Torna presto!</p></div>
  {% endfor %}
</section>

{% if eventi_passati %}
{% set eventi_passati_preview = eventi_passati if show_all_past else eventi_passati[:3] %}
<div class="section-heading section-heading--muted">
  <span class="section-heading__icon">üï∞Ô∏è</span>
  <div class="section-heading__meta">
    <span class="section-heading__eyebrow">Ricordi recenti</span>
    <h2 class="section-heading__title">Eventi passati</h2>
  </div>
</div>

<section class="event-list event-list--past">
  {% for e in eventi_passati_preview %}
  <article class="event-card event-card--past">
    <div class="event-card__media">
      {% if e.cover_url %}
        <img src="{{ url_for('static', filename='uploads/eventi/' ~ e.cover_url) }}" alt="{{ e.nome_evento }}">
      {% else %}
        <div class="event-card__placeholder">{{ e.nome_evento[0]|upper }}</div>
      {% endif %}
      <span class="event-card__chip event-card__chip--past">Terminato</span>
    </div>
    <div class="event-card__body">
      <div class="event-card__info">
        <h3 class="event-card__title">{{ e.nome_evento }}</h3>
        <p class="event-card__meta">
          <span class="event-card__date">{{ e.data_evento.strftime('%d %b %Y') if e.data_evento else '' }}</span>
          <span class="event-card__dot">‚Ä¢</span>
          <span class="event-card__genre">{{ e.tipo_musica or e.categoria }}</span>
        </p>
        {% if e.dj_artista %}
          <p class="event-card__dj">DJ set: <strong>{{ e.dj_artista }}</strong></p>
        {% endif %}
        {% if e.promozione %}
          <p class="event-card__promo">Promo: {{ e.promozione }}</p>
        {% endif %}
      </div>
      <div class="event-card__actions event-card__actions--past">
        <a class="btn btn--ghost" href="{{ url_for('eventi.dettaglio_pubblico', evento_id=e.id_evento) }}">Vedi dettagli</a>
      </div>
    </div>
  </article>
  {% endfor %}
{% if not show_all_past and eventi_passati|length > 3 %}
<div class="form__actions">
  <form method="get" action="{{ url_for('eventi.lista_pubblica') }}">
    <input type="hidden" name="show_all" value="past">
    {% if filtri.categoria %}
      <input type="hidden" name="categoria" value="{{ filtri.categoria }}">
    {% endif %}
    {% if filtri.dal %}
      <input type="hidden" name="dal" value="{{ filtri.dal }}">
    {% endif %}
    {% if filtri.al %}
      <input type="hidden" name="al" value="{{ filtri.al }}">
    {% endif %}
    <button class="btn btn--ghost" type="submit">Vedi altri eventi passati</button>
  </form>
</div>
{% endif %}
</section>
{% endif %}

<section class="card" style="margin-top: 1rem;">
  <h1 class="card__title">Filtra eventi</h1>
  <form class="form" method="get">
    <div class="grid grid--2">
      <div class="form__group">
        <label class="form__label">Categoria</label>
        <select class="form__input" name="categoria">
          <option value="">Tutte</option>
          {% for c in CATEGORIES_PUBLIC %}
            <option value="{{ c }}" {% if filtri.categoria==c %}selected{% endif %}>{{ c|capitalize }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form__group">
        <label class="form__label">Dal</label>
        <input class="form__input" type="date" name="dal" value="{{ filtri.dal or '' }}">
      </div>
      <div class="form__group">
        <label class="form__label">Al</label>
        <input class="form__input" type="date" name="al" value="{{ filtri.al or '' }}">
      </div>
    </div>
    <div class="form__actions">
      <button class="btn btn--primary">Applica filtri</button>
      <a class="btn btn--ghost" href="{{ url_for('eventi.lista_pubblica') }}">Reset</a>
    </div>
  </form>
</section>

{% endblock %}

{% block scripts %}
<script>
function copyLink(url){
  navigator.clipboard.writeText(url).then(()=>alert('Link copiato'));
}
</script>
{% endblock %}