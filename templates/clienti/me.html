{% extends "clienti/base.html" %}
{% block title %}Area personale - Malibù{% endblock %}

{% block cliente_content %}
<section class="card card--qr card--qr-focus">
  <div class="card__header card__header--compact">
    <h1 class="card__title">Il tuo QR personale</h1>
    <p class="card__meta">Mostralo all’ingresso per accumulare punti e accedere rapidamente.</p>
  </div>
  <div class="qr qr--focus">
    {% if qr_url %}
      <img class="qr__img" src="{{ qr_url }}" alt="QR personale">
      <a class="btn btn--secondary qr__action" download="qr_cliente_{{ cliente.id_cliente }}.png" href="{{ qr_url }}">Salva sul telefono</a>
      <small class="text--muted" style="margin-top:0.75rem;">Suggerimento: salva lo screenshot nella galleria per averlo sempre a portata di mano.</small>
    {% else %}
      <p class="empty-state">QR non disponibile.</p>
    {% endif %}
  </div>
  <div class="form__actions">
    <a class="btn btn--primary" href="{{ url_for('clienti.me_edit') }}">Modifica profilo</a>
  </div>
</section>

<section class="card card--loyalty">
  <h2 class="card__title">Il tuo livello Fedeltà</h2>
  <p class="text--muted card--loyalty__subtitle">
    Colleziona punti per sbloccare vantaggi speciali riservati ai membri Malibù.
  </p>

  <div class="card--loyalty__stats">
    <div class="card--loyalty__stat">
      <span class="card--loyalty__label">Livello attuale</span>
      <span class="card--loyalty__value">{{ current_level|capitalize }}</span>
    </div>
    <div class="card--loyalty__stat">
      <span class="card--loyalty__label">Punti totali</span>
      <span class="card--loyalty__value">{{ points }}</span>
    </div>
  </div>

  <div class="card--loyalty__progress">
    <span class="card--loyalty__progress-label">Progresso verso il prossimo livello</span>
    <div class="progress progress--loyalty">
      <div class="progress__bar" style="width: {{ progress }}%"></div>
    </div>
    <div class="card--loyalty__progress-meta">
      {% if next_level %}
        Ti mancano <strong>{{ to_go }}</strong> pt per raggiungere <strong>{{ next_level|capitalize }}</strong>.
      {% else %}
        Hai raggiunto il livello massimo. Continua a divertirti con Malibù!
      {% endif %}
    </div>
  </div>
</section>

<section class="card">
  <h2 class="card__title">Le tue prenotazioni</h2>
  <div class="grid" style="gap:1rem;">
    <div>
      <h3 class="text--muted" style="margin-bottom:0.5rem;">Future</h3>
      {% if prenotazioni_future %}
        <ul class="list">
          {% for pren, evento in prenotazioni_future %}
          <li class="list__item">
            <strong>{{ evento.nome_evento }}</strong><br>
            <small class="text--muted">{{ evento.data_evento }} • {{ pren.tipo|capitalize }}</small>
          </li>
          {% endfor %}
        </ul>
        <a class="btn btn--ghost" href="{{ url_for('prenotazioni.mie') }}">Gestisci prenotazioni</a>
      {% else %}
        <p class="text--muted">Nessuna prenotazione in arrivo.</p>
      {% endif %}
    </div>
    <div>
      <h3 class="text--muted" style="margin-bottom:0.5rem;">Ultime prenotazioni chiuse</h3>
      {% if prenotazioni_passate %}
        <ul class="list">
          {% for pren, evento in prenotazioni_passate %}
          <li class="list__item">
            <strong>{{ evento.nome_evento }}</strong><br>
            <small class="text--muted">{{ evento.data_evento }} • Stato {{ pren.stato|replace('_',' ') }}</small>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text--muted">Ancora nessuna prenotazione conclusa.</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="card">
  <h2 class="card__title">Attività recente</h2>
  <div class="grid" style="gap:1rem;">
    <div class="card card--muted" style="padding:1rem;">
      <h3 class="card__title" style="font-size:1rem;">Ultimo ingresso</h3>
      {% if ultimo_ingresso %}
        <p style="margin:0;"><strong>{{ ultimo_ingresso.evento.nome_evento }}</strong></p>
        <small class="text--muted">Registrato il {{ ultimo_ingresso.orario_ingresso.strftime('%d/%m/%Y %H:%M') }}</small>
      {% else %}
        <p class="text--muted" style="margin:0;">Ancora nessun ingresso registrato.</p>
      {% endif %}
    </div>
    <div>
      <h3 class="text--muted" style="margin-bottom:0.5rem;">Consumi recenti</h3>
      {% if consumi_recenti %}
        <ul class="list">
          {% for consumo, evento in consumi_recenti %}
          <li class="list__item">
            <strong>{{ consumo.prodotto }}</strong><br>
            <small class="text--muted">{{ evento.nome_evento }} • {{ consumo.data_consumo.strftime('%d/%m/%Y %H:%M') }} • €{{ '%.2f'|format(consumo.importo) }}</small>
          </li>
          {% endfor %}
        </ul>
        <a class="btn btn--ghost" href="{{ url_for('consumi.miei') }}">Vedi tutti i consumi</a>
      {% else %}
        <p class="text--muted">Non ci sono consumi registrati.</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="card card--logout">
  <h2 class="card__title">Hai finito?</h2>
  <p class="text--muted">Effettua il logout in qualsiasi momento per proteggere i tuoi dati.</p>
  <div class="form__actions">
    <a class="btn btn--logout" href="{{ url_for('auth.logout') }}">Esci dall'account</a>
  </div>
</section>
{% endblock %}