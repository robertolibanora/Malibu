{% extends "clienti/base.html" %}
{% block cliente_title %}Home{% endblock %}
{% block title %}Home - Malib√π{% endblock %}

{% block cliente_content %}
<section class="card card--qr card--qr-focus">
  <div class="card__header card__header--compact">
    <h1 class="card__title">Il tuo QR personale</h1>
    <p class="card__meta">Mostralo all‚Äôingresso per accumulare punti e accedere rapidamente.</p>
  </div>
  <div class="qr qr--focus">
    {% if qr_url %}
      <img class="qr__img" src="{{ qr_url }}" alt="QR personale">
      <a class="btn btn--secondary qr__action" download="qr_cliente_{{ cliente.id_cliente }}.png" href="{{ qr_url }}">Salva sul telefono</a>
      <small class="text--muted" style="margin-top:0.75rem;"> Suggerimento: utilizza il QR quando fai acquisti per il tavolo selezionato </small>
    {% else %}
      <p class="empty-state">QR non disponibile.</p>
    {% endif %}
  </div>
  <div class="form__actions" style="flex-direction: column; gap:0.75rem;">
    <a class="btn btn--primary" href="{{ url_for('clienti.me_edit') }}">Modifica profilo</a>
    <a class="btn btn--ghost" href="{{ url_for('prodotti.public_listino') }}" target="_blank" rel="noopener">
      üåê Listino prodotti
    </a>
  </div>
</section>

<section class="card card--loyalty">
  <h2 class="card__title">Il tuo livello Fedelt√†</h2>
  <p class="text--muted card--loyalty__subtitle">
    Colleziona punti per sbloccare vantaggi speciali riservati ai membri Malib√π.
  </p>

  <div class="card--loyalty__stats">
    <div class="card--loyalty__stat">
      <span class="card--loyalty__label">Livello attuale</span>
      <span class="card--loyalty__value">{{ current_level|capitalize }}</span>
    </div>
    <div class="card--loyalty__stat">
      <span class="card--loyalty__label">Punti totali</span>
      <span class="card--loyalty__value">{{ points }}</span>
    </div>
  </div>

  <div class="card--loyalty__progress">
    <span class="card--loyalty__progress-label">Progresso verso il prossimo livello</span>
    <div class="progress progress--loyalty">
      <div class="progress__bar" data-progress="{{ progress }}"></div>
    </div>
    <div class="card--loyalty__progress-meta">
      {% if next_level %}
        Ti mancano <strong>{{ to_go }}</strong> pt per raggiungere <strong>{{ next_level|capitalize }}</strong>.
      {% else %}
        Hai raggiunto il livello massimo. Continua a divertirti con Malib√π!
      {% endif %}
    </div>
  </div>
</section>

<section class="card card--logout">
  <h2 class="card__title">Hai finito?</h2>
  <p class="text--muted">Effettua il logout in qualsiasi momento per proteggere i tuoi dati.</p>
  <div class="form__actions">
    <a class="btn btn--logout" href="{{ url_for('auth.logout') }}">Esci dall'account</a>
  </div>
</section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      document.querySelectorAll(".progress__bar[data-progress]").forEach(function(el){
        var raw = parseFloat(el.dataset.progress);
        if (isNaN(raw)) {
          return;
        }
        var clamped = Math.max(0, Math.min(100, raw));
        el.style.width = clamped + "%";
      });
    });
  </script>
{% endblock %}