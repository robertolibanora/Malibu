{% extends "clienti/base.html" %}
{% block title %}Le mie prenotazioni{% endblock %}

{% block cliente_content %}
{% set show_all_usate = show_all_usate|default(false) %}
{% set stato_label = {
  'attiva': 'Prenotazione attiva',
  'usata': 'Prenotazione usata',
  'no-show': 'Prenotazione non usata'
} %}

{% if prenotazioni_attive %}
<div class="section-heading section-heading--muted">
  <span class="section-heading__icon">ğŸ—“ï¸</span>
  <div class="section-heading__meta">
    <span class="section-heading__eyebrow">In programma</span>
    <h2 class="section-heading__title">Prenotazioni attive</h2>
  </div>
</div>
<section class="event-list">
  {% for p in prenotazioni_attive %}
  <article class="event-card">
    <div class="event-card__media">
      {% if p.evento.cover_url %}
        <img src="{{ url_for('static', filename='uploads/eventi/' ~ p.evento.cover_url) }}" alt="{{ p.evento.nome_evento }}">
      {% else %}
        <div class="event-card__placeholder">{{ p.evento.nome_evento[0]|upper }}</div>
      {% endif %}
    </div>
    <div class="event-card__body">
      <div class="event-card__info">
        <h3 class="event-card__title">{{ p.evento.nome_evento }}</h3>
        <p class="event-card__meta">
          <span class="event-card__date">{{ p.evento.data_evento.strftime('%d %b %Y') if p.evento.data_evento else '' }}</span>
          <span class="event-card__dot">â€¢</span>
          {% if p.tipo == 'tavolo' %}
            <span class="event-card__genre" style="color: var(--gold-primary); font-weight: 600;">ğŸª‘ Tavolo</span>
          {% else %}
            <span class="event-card__genre">ğŸ“‹ Lista</span>
          {% endif %}
        </p>
        <p class="event-card__promo">Punti guadagnati finora: {{ punti_evento.get(p.evento_id, 0) }}</p>
        {% if p.tipo == 'tavolo' %}
          {% if p.num_persone %}
            <p class="event-card__info" style="display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ‘¥</span>
              <span>Persone: <strong>{{ p.num_persone }}</strong></span>
            </p>
        {% endif %}
        {% if p.note %}
            <p class="event-card__promo" style="display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸª‘</span>
              <span><strong>Tavolo:</strong> {{ p.note }}</span>
            </p>
          {% endif %}
        {% elif p.note %}
          <p class="event-card__promo">Note: {{ p.note }}</p>
        {% endif %}
      </div>
      <div class="event-card__actions">
        {% if p.evento.data_evento >= oggi %}
        <form method="post" action="{{ url_for('prenotazioni.cancella_mia', pren_id=p.id_prenotazione) }}" onsubmit="return confirm('Cancellare la prenotazione?');">
          <button class="btn btn--primary" type="submit" style="background: linear-gradient(135deg, rgba(196, 30, 58, 0.95) 0%, rgba(196, 30, 58, 0.85) 100%); color: white; border: 1px solid rgba(196, 30, 58, 0.4);">Cancella (entro le 18)</button>
        </form>
        {% endif %}
      </div>
    </div>
  </article>
  {% endfor %}
</section>
{% endif %}

{% if prenotazioni_usate %}
{% set prenotazioni_usate_preview = prenotazioni_usate if show_all_usate else prenotazioni_usate[:3] %}
<div class="section-heading">
  <span class="section-heading__icon">â­</span>
  <div class="section-heading__meta">
    <span class="section-heading__eyebrow">GiÃ  vissute</span>
    <h2 class="section-heading__title">Prenotazioni usate</h2>
  </div>
</div>
<section class="event-list">
  {% for pren, feedback in prenotazioni_usate_preview %}
  <article class="event-card">
    <div class="event-card__media">
      {% if pren.evento.cover_url %}
        <img src="{{ url_for('static', filename='uploads/eventi/' ~ pren.evento.cover_url) }}" alt="{{ pren.evento.nome_evento }}">
      {% else %}
        <div class="event-card__placeholder">{{ pren.evento.nome_evento[0]|upper }}</div>
      {% endif %}
    </div>
    <div class="event-card__body">
      <div class="event-card__info">
        <h3 class="event-card__title">{{ pren.evento.nome_evento }}</h3>
        <p class="event-card__meta">
          <span class="event-card__date">{{ pren.evento.data_evento.strftime('%d %b %Y') if pren.evento.data_evento else '' }}</span>
          <span class="event-card__dot">â€¢</span>
          {% if pren.tipo == 'tavolo' %}
            <span class="event-card__genre" style="color: var(--gold-primary); font-weight: 600;">ğŸª‘ Tavolo</span>
          {% else %}
            <span class="event-card__genre">ğŸ“‹ Lista</span>
          {% endif %}
        </p>
        <p class="event-card__promo">Punti guadagnati: {{ punti_evento.get(pren.evento_id, 0) }}</p>
        {% if pren.tipo == 'tavolo' %}
          {% if pren.num_persone %}
            <p class="event-card__info" style="display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ‘¥</span>
              <span>Persone: <strong>{{ pren.num_persone }}</strong></span>
            </p>
          {% endif %}
        {% if pren.note %}
            <p class="event-card__promo" style="display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸª‘</span>
              <span><strong>Tavolo:</strong> {{ pren.note }}</span>
            </p>
          {% endif %}
        {% elif pren.note %}
          <p class="event-card__promo">Note: {{ pren.note }}</p>
        {% endif %}
        {% if feedback %}
          {% set avg = ((feedback.voto_musica + feedback.voto_ingresso + feedback.voto_ambiente + feedback.voto_servizio) / 4.0) %}
          <div class="rating-stars" aria-label="Valutazione media {{ avg|round(1) }}/10">
            {% for star in range(1, 11) %}
              <span class="rating-stars__star {% if star <= avg %}rating-stars__star--active{% endif %}">â˜…</span>
            {% endfor %}
            <span class="rating-stars__label">{{ avg|round(1) }}/10</span>
          </div>
        {% else %}
          <div class="form__actions">
            <a class="btn btn--ghost" href="{{ url_for('feedback.nuovo', evento_id=pren.evento_id) }}">
              Lascia feedback
            </a>
          </div>
        {% endif %}
      </div>
      <div class="event-card__actions">
        <a class="btn btn--ghost" href="{{ url_for('prenotazioni.mia_prenotazione_detail', pren_id=pren.id_prenotazione) }}">
          Vedi dettagli consumi
        </a>
      </div>
    </div>
  </article>
  {% endfor %}
  {% if not show_all_usate and prenotazioni_usate|length > 3 %}
  <div class="form__actions">
    <form method="get" action="{{ url_for('prenotazioni.mie') }}">
      <input type="hidden" name="show_all" value="usate">
      <button class="btn btn--ghost" type="submit">Vedi altre prenotazioni usate</button>
    </form>
  </div>
  {% endif %}
</section>
{% endif %}

{% if prenotazioni_no_show %}
<div class="section-heading section-heading--muted">
  <span class="section-heading__icon">âš ï¸</span>
  <div class="section-heading__meta">
    <span class="section-heading__eyebrow">Attenzione</span>
    <h2 class="section-heading__title">Prenotazioni non usate</h2>
  </div>
</div>
<section class="event-list">
  <p class="text--muted" style="margin-bottom:.75rem;">
    Hai perso <strong>{{ punti_persi_no_show }}</strong> pt fedeltÃ  perchÃ© non hai registrato l'ingresso.
  </p>
  {% for p in prenotazioni_no_show %}
  <article class="event-card event-card--no-show">
    <div class="event-card__media">
      {% if p.evento.cover_url %}
        <img src="{{ url_for('static', filename='uploads/eventi/' ~ p.evento.cover_url) }}" alt="{{ p.evento.nome_evento }}">
      {% else %}
        <div class="event-card__placeholder">{{ p.evento.nome_evento[0]|upper }}</div>
      {% endif %}
    </div>
    <div class="event-card__body">
      <div class="event-card__info">
        <h3 class="event-card__title">{{ p.evento.nome_evento }}</h3>
        <p class="event-card__meta">
          <span class="event-card__date">{{ p.evento.data_evento.strftime('%d %b %Y') if p.evento.data_evento else '' }}</span>
          <span class="event-card__dot">â€¢</span>
          {% if p.tipo == 'tavolo' %}
            <span class="event-card__genre" style="color: var(--gold-primary); font-weight: 600;">ğŸª‘ Tavolo</span>
          {% else %}
            <span class="event-card__genre">ğŸ“‹ Lista</span>
          {% endif %}
        </p>
        <p class="event-card__promo">Punti guadagnati: {{ punti_evento.get(p.evento_id, 0) }}</p>
        {% if p.tipo == 'tavolo' %}
          {% if p.num_persone %}
            <p class="event-card__info" style="display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸ‘¥</span>
              <span>Persone: <strong>{{ p.num_persone }}</strong></span>
            </p>
          {% endif %}
        {% if p.note %}
            <p class="event-card__promo" style="display: flex; align-items: center; gap: 0.5rem;">
              <span>ğŸª‘</span>
              <span><strong>Tavolo:</strong> {{ p.note }}</span>
            </p>
          {% endif %}
        {% elif p.note %}
          <p class="event-card__promo">Note: {{ p.note }}</p>
        {% endif %}
        <p class="event-card__promo">Perdita punti: -{{ punti_per_no_show }} pt</p>
      </div>
      <div class="event-card__actions">
        <p class="text--muted">Ricorda di effettuare il check-in QR la prossima volta.</p>
      </div>
    </div>
  </article>
  {% endfor %}
</section>
{% endif %}

{% if not prenotazioni_attive and not prenotazioni_usate and not prenotazioni_no_show %}
  <div><p class="text--muted">Nessuna prenotazione trovata.</p></div>
{% endif %}

{% endblock %}